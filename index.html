<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸–ç´€é«®å»Š æ™¯ç¾åº—</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.11.5/main.min.css">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,400,1,0&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="styles.css">

</head>

<body>
  <div id="calendar-container">
    <div id="calendar"></div>
    <div id="appointmentModal" class="modal">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <form id="appointmentForm">
          <input type="hidden" id="event_id" name="event_id">
          <input type="hidden" id="start_time" name="start_time">
          <input type="hidden" id="employee_id" name="employee_id">
          <input type="hidden" id="amount_input" name="amount_input">

          <div class="modal-layout-grid">
            <!-- [å½ˆçª—å·¦æ¬„] è—è‰²å¡ç‰‡å€åŸŸï¼šé¡§å®¢è³‡æ–™èˆ‡é ç´„æ™‚é•· -->
            <div class="modal-col">
              <div class="modal-section blue-card-section" id="appointment-info-card">
                <label>é ç´„é¡å‹</label>
                <div class="type-toggle-container">
                  <input type="radio" id="appointment-normal" name="appointment_type" value="normal" checked>
                  <input type="radio" id="appointment-blocked" name="appointment_type" value="blocked">
                  <label for="appointment-normal" class="toggle-label left">ä¸€èˆ¬é ç´„</label>
                  <label for="appointment-blocked" class="toggle-label right">ä¸ç´„æ™‚æ®µ</label>
                  <span class="sliding-glider"></span>
                </div>
                
                <hr style="border:none; border-top:1px solid rgba(255,255,255,0.1); margin:8px -2;">
                
                <div class="form-row">
                  <label for="minute_select">æ™‚é–“ (åˆ†)</label>
                  <select id="minute_select" name="minute_select"></select>
                </div>
                
                <!-- [åŠŸèƒ½] é ç´„æ™‚é•·é¸æ“‡ï¼š15åˆ†è‡³3å°æ™‚ -->
                <div class="form-row">
                  <label for="duration_select">é ç´„æ™‚é•·</label>
                  <select id="duration_select" name="duration_select">
                    <option value="15">15 åˆ†é˜</option>
                    <option value="30">30 åˆ†é˜</option>
                    <option value="45">45 åˆ†é˜</option>
                    <option value="60">1 å°æ™‚</option>
                    <option value="90">1.5 å°æ™‚</option>
                    <option value="120">2 å°æ™‚</option>
                    <option value="180">3 å°æ™‚</option>
                  </select>
                </div>

                <div id="customer-fields-left">
                  <hr style="border:none; border-top:1px solid rgba(255,255,255,0.1); margin:8px 0;">
                  
                  <div class="form-row">
                    <label for="customer_name">é¡§å®¢å§“å</label>
                    <input type="text" id="customer_name" name="customer_name" placeholder="è«‹è¼¸å…¥é¡§å®¢å§“å">
                  </div>
                  
                  <div class="form-row">
                    <label for="customer_phone">é›»è©±</label>
                    <input type="tel" id="customer_phone" name="customer_phone" inputmode="numeric" autocomplete="off" placeholder="09xx-xxx-xxx">
                  </div>
                  
                  <div class="form-row">
                    <label for="service_id">é …ç›® (é¸å¡«)</label>
                    <select id="service_id" name="service_id">
                      <option value="">-- ä¸é¸ --</option>
                      <option value="å‰ªé«®">å‰ªé«®</option>
                      <option value="æŸ“">æŸ“</option>
                      <option value="ç‡™">ç‡™</option>
                      <option value="æŸ“+ç‡™">æŸ“+ç‡™</option>
                      <option value="é ­çš®è­·ç†">é ­çš®è­·ç†</option>
                    </select>
                  </div>
                </div>
                
                <hr style="border:none; border-top:1px solid rgba(255,255,255,0.1); margin:8px 0;">
                
                <label for="notes">å‚™è¨»</label>
                <textarea id="notes" name="notes" rows="3" placeholder="è«‹è¼¸å…¥å‚™è¨»è³‡è¨Š..."></textarea>
                <div id="last-visit-info" class="last-visit-info" hidden>ä¸Šæ¬¡æ¶ˆè²»ï¼š-</div>
              </div>
            </div>

            <!-- [å½ˆçª—å³æ¬„] çµå¸³ç¶ å¡å€åŸŸï¼šé¸æ“‡å‰ªé«®/æŸ“ç‡™é …ç›®èˆ‡åŠ©ç† -->
            <div class="modal-col settlement-col" id="settlement-col">
              <div class="modal-section settlement-section">
                  <label>å‰ªé«®é …ç›®</label>
                  <div class="price-group">
                      <!-- éš±è—çš„ 0 å…ƒé¸é …ï¼Œç”¨æ–¼æ”¹å›æœªçµå¸³ -->
                      <input type="radio" name="cut_price" value="0" data-cost="0" style="display:none;">
                      
                      <label class="price-item"><span class="price-label"><input type="radio" name="cut_price" value="450" data-cost="0"> æˆäººå‰ªé«®</span> <span class="price-val">$450</span></label>
                      <label class="price-item"><span class="price-label"><input type="radio" name="cut_price" value="400" data-cost="0"> å¤§å­¸å‰ªé«®</span> <span class="price-val">$400</span></label>
                      <label class="price-item"><span class="price-label"><input type="radio" name="cut_price" value="350" data-cost="0"> é«˜ä¸­å‰ªé«®</span> <span class="price-val">$350</span></label>
                      
                      <label class="price-item"><span class="price-label"><input type="radio" name="cut_price" value="1100" data-cost="0"> å‰ªé«®+è­·é«®</span> <span class="price-val">$1100</span></label>
                      <label class="price-item"><span class="price-label"><input type="radio" name="cut_price" value="900" data-cost="0"> å‰ªé«®+è­·é«®</span> <span class="price-val">$900</span></label>
                      <label class="price-item" id="xiaobai-cut-opt" style="display:none;"><span class="price-label"><input type="radio" name="cut_price" value="600" data-cost="0">æŒ‡å®šå‰ªé«®</span> <span class="price-val">$600</span></label>
                      
                      <label class="price-item"><span class="price-label"><input type="radio" name="cut_price" value="1000" data-cost="0"> éå¹´å‰ªé«®</span> <span class="price-val">$1000</span></label>
                      <label class="price-item"><span class="price-label"><input type="radio" name="cut_price" value="650" data-cost="0"> éå¹´å‰ªé«®</span> <span class="price-val">$600</span></label>
                      <label class="price-item"><span class="price-label"><input type="radio" name="cut_price" value="500" data-cost="0"> éå¹´å‰ªé«®</span> <span class="price-val">$500</span></label>
                      
                      <!-- å°‡ã€Œå‰ªé«®è‡ªè¨‚ã€ç§»å‹•åˆ°æ­¤è™• -->
                      <div class="settlement-row" style="margin-top:0; display: flex; align-items: center; gap: 10px;">
                        <label style="color: #81c784; font-weight: 700; font-size: 14px; white-space: nowrap;">å‰ªé«®è‡ªè¨‚</label>
                        <input type="number" id="cut_custom" class="custom-price-input" placeholder="0" min="0" style="margin-top:0;">
                      </div>
                  </div>

                  <hr style="border:none; border-top:1px solid rgba(255,255,255,0.1); margin:4px 0;">
                  
                  <label>å…¶ä»–é …ç›®</label>
                  <div class="price-group">
                      <label class="price-item"><span class="price-label"><input type="checkbox" name="other_item" value="150" data-cost="0"> æ´—é«®</span> <span class="price-val">$150</span></label>
                      <label class="price-item"><span class="price-label"><input type="checkbox" name="other_item" value="1000" data-cost="270"> æŸ“é«®</span> <span class="price-val">$1000</span></label>
                      <label class="price-item"><span class="price-label"><input type="checkbox" name="other_item" value="1000" data-cost="270"> æ¼‚é«®</span> <span class="price-val">$1000</span></label>
                      <label class="price-item"><span class="price-label"><input type="checkbox" name="other_item" value="4000" data-cost="270"> æ¼‚4000</span> <span class="price-val">$4000</span></label>
                      
                      <!-- ç§»å‹•ã€Œå…¶ä»–è‡ªè¨‚ã€åˆ°æ­¤è™• -->
                      <div class="settlement-row" style="margin-top:0; display: flex; align-items: center; gap: 10px;">
                        <label style="color: #81c784; font-weight: 700; font-size: 14px; white-space: nowrap;">å…¶ä»–è‡ªè¨‚</label>
                        <input type="number" id="other_custom" class="custom-price-input" placeholder="0" min="0" style="margin-top:0;">
                      </div>
                  </div>

                  <!-- [CRMåŠŸèƒ½] æŸ“é«®é¡è‰²ç´€éŒ„å€å¡Š (åƒ…åœ¨ CRM æ‰¾åˆ°è‰²è™Ÿæ™‚é¡¯ç¤º) -->
                  <div id="dye-color-wrap" class="settlement-row" style="display:none; margin-top:10px;">
                    <label for="dye_color_input" style="color:#ffcc80;">æŸ“é«®é¡è‰²ç´€éŒ„</label>
                    <input type="text" id="dye_color_input" name="dye_color_input" placeholder="è«‹è¼¸å…¥è‰²è™Ÿ/é…æ–¹...">
                  </div>

                  <div id="material-cost-wrap" class="settlement-row" style="display:none; margin-top:10px;">
                    <label for="custom_material_cost" style="color:#ffcc80;">ææ–™è²» (è‡ªå¡«)</label>
                    <input type="number" id="custom_material_cost" name="custom_material_cost" min="0" inputmode="numeric" placeholder="è«‹è¼¸å…¥ææ–™è²»...">
                  </div>

                  <div class="settlement-row settlement-row--inline" style="margin-top:10px;">
                    <div class="settlement-inline-item">
                      <label for="perm_select">ç‡™é«®</label>
                      <select id="perm_select" name="perm_select">
                        <option value="" data-cost="0">ç„¡</option>
                        <option value="1200" data-cost="260">1200ï¼ˆææ–™260ï¼‰</option>
                        <option value="1500" data-cost="260">1500ï¼ˆææ–™260ï¼‰</option>
                        <option value="1800" data-cost="280">1800ï¼ˆææ–™280ï¼‰</option>
                        <option value="2000" data-cost="280">2000ï¼ˆææ–™280ï¼‰</option>
                        <option value="2400" data-cost="280">2400ï¼ˆææ–™280ï¼‰</option>
                        <option value="3600" data-cost="300">3600ï¼ˆææ–™300ï¼‰</option>
                      </select>
                    </div>

                    <div class="settlement-inline-item">
                      <label for="perm_custom">ç‡™é«®è‡ªè¨‚</label>
                      <input type="number" id="perm_custom" class="custom-price-input" placeholder="0" min="0">
                    </div>
                  </div>
                  
                  <hr style="border:none; border-top:1px solid rgba(255,255,255,0.1); margin:4px 0;">
                  
                  <div class="settlement-row settlement-row--title shop-sales-row">
                    <label for="retail_item">åº—è²©</label>
                    <div class="shop-sales-inputs">
                      <input type="text" id="retail_item" name="retail_item" placeholder="å“é …åç¨±">
                      <input type="number" id="retail_price" name="retail_price" placeholder="é‡‘é¡" min="0">
                    </div>
                  </div>
                  
                <div class="assistant-total-row">
                  <div class="assistant-field">
                    <label for="assistant_select">åŠ©ç†</label>
                    <select id="assistant_select" name="assistant_select">
                      <option value="">-- ç„¡åŠ©ç† --</option>
                        <option value="é™³ç¿">é™³ç¿</option>
                        <option value="æ´ªè‹¡èŠ³">æ´ªè‹¡èŠ³</option>
                        <option value="æ›¹å®¶æº±">æ›¹å®¶æº±</option>
                      </select>
                    </div>

                    <div class="total-display">
                      <span style="font-size:0.5em; color:#aaa; font-weight:normal;">ç¸½é‡‘é¡: </span>
                      <span id="display-total">$0</span>
                      <button type="button" id="unsetPaidBtn" class="unset-paid-btn">æ”¹å›æœªçµå¸³</button>
                      <div style="font-size:12px; color:#aaa; font-weight:normal; margin-top:4px;">(å…¥å¸³é‡‘é¡: <span id="display-net">$0</span>)</div>
                    </div>
                  </div>
              </div>
              <div id="last-visit-info-right" class="last-visit-info" hidden>ä¸Šæ¬¡æ¶ˆè²»ï¼š-</div>
            </div>
          </div>
          
          <div id="appointment-actions-anchor"></div>
          <div class="modal-actions" style="grid-column: 1 / -1; margin-top: 16px;">
            <button type="button" id="deleteBtn" style="display:none; background-color:#d32f2f; color:white;">åˆªé™¤é ç´„</button>
            <button type="submit" id="submit-btn" style="flex:1;">å„²å­˜</button>
          </div>
        </form>
      </div>
    </div>

    <div id="leaveModal" class="modal">
      <div class="modal-content">
        <span class="close-button leave-close-button">&times;</span>
        <h3 id="leaveModalTitle">è¨­å®šæ’ä¼‘</h3>
        <p>æ‚¨æ­£åœ¨ç‚º <b id="leaveModalResourceName"></b> è¨­å®š <b id="leaveModalDate"></b> çš„æ’ä¼‘ç‹€æ…‹ã€‚</p>
        <form id="leaveForm" class="modal-form">
          <input type="hidden" id="leaveResourceId">
          <input type="hidden" id="leaveDate">
          <div class="modal-section form-span-2">
            <label for="leaveReason">æ’ä¼‘åŸå›  (æœƒé¡¯ç¤ºåœ¨æ ¼å­ä¸Š)</label>
            <input type="text" id="leaveReason" name="leaveReason" placeholder="ä¾‹å¦‚ï¼šåº—ä¼‘ã€ç‰¹ä¼‘ã€é€²ä¿®">
          </div>
          <div class="modal-actions">
            <button type="button" id="deleteLeaveBtn">å–æ¶ˆæ’ä¼‘</button>
            <button type="submit" id="submitLeaveBtn">å„²å­˜è¨­å®š</button>
          </div>
        </form>
      </div>
    </div>

    <div id="report-trigger-placeholder" hidden>
      <button id="open-report-btn" type="button" class="report-trigger-btn">
        å ±è¡¨
      </button>
    </div>

    <div id="reportModal" class="modal">
      <div class="modal-content" style="max-width: 700px;">
        <span class="close-button report-close-button">&times;</span>
        <h3 style="margin-top:0;">å€é–“çµ±è¨ˆ (å®¢æ•¸)</h3>
        <div class="report-controls">
          <label for="report-start" class="report-label">èµ·æ—¥</label>
          <input type="date" id="report-start">
          <label for="report-end" class="report-label">è¿„æ—¥</label>
          <input type="date" id="report-end">
          <button id="fetch-report-btn" type="button">æŸ¥è©¢</button>
        </div>
        <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 4px 0;">
        <div id="report-result">
          <div style="text-align:center; color:#888; padding: 20px;">
            è«‹é¸æ“‡èµ·è¨–æ—¥æœŸï¼Œé»æ“Šã€ŒæŸ¥è©¢ã€ã€‚
          </div>
        </div>
      </div>
    </div>

    <div id="notes-section">
      <div class="notes-container">
        <div class="notes-header">
          <h4>ç•™è¨€æ¿</h4>
          <div class="notes-meta"><span>æœªå„²å­˜</span></div>
          <button id="save-notes-btn" type="button">ğŸ’¾ å„²å­˜ä»Šæ—¥ç•™è¨€</button>
        </div>
        <textarea id="notes-content" placeholder="è«‹è¼¸å…¥ä»Šæ—¥ç•™è¨€..."></textarea>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.11.5/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/locales/zh-tw.js"></script>

    <script>
      // å¾Œç«¯ Google Apps Script ç¶²å€
      const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwds2EP3YgVB8DK9ctuAtg--4JDt0jGaEbTvjm5l1t-2lSV08xkptRk2ozW2bxE8du29A/exec';
      const RESOURCE_LIST = [
        { id: '1', title: 'åº—é•·' },
        { id: '2', title: 'é›…å©·' },
        { id: '3', title: 'å°ç™½' }
      ];
      const MOBILE_RESOURCE_STORAGE_KEY = 'sj_mobile_resource_id';
      const MOBILE_RESOURCE_MEDIA_QUERY = '(max-width: 1024px)';

      (function () {
        let employeeLeaveData = [];
        const ymd = d => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        let currentYmd = null;
        let selectedDate = null;
        let calendar;
        let perResourceAxisTimer = null;
        let mobileSelectedResourceId = null;
        let displayTotal = 0;  // å…¨åŸŸè®Šæ•¸å„²å­˜ç¸½é‡‘é¡

        let appointmentModal, leaveModal, reportModal;
          let appointmentCloseButton, leaveCloseButton, reportCloseButton;
          let form, leaveForm, notesTextarea, phoneEl, customerFields;
          let submitBtn, deleteBtn, eventIdInput, assistantSelect, amountInput, deleteLeaveBtn, unsetPaidBtn;
          let appointmentContent, appointmentActions, appointmentActionsAnchor, appointmentInfoCard;
          let lastVisitInfo;
          let lastVisitInfoRight;
          let lastVisitLabelValue = '';
          let lastVisitPhoneValue = '';
          let lastVisitDesignerValue = '';

        document.addEventListener('DOMContentLoaded', function () {
          const calendarEl = document.getElementById('calendar');
          if (calendarEl && isMobileLayout()) {
            mobileSelectedResourceId = ensureMobileResourceId();
            calendarEl.setAttribute('data-mobile-resource', mobileSelectedResourceId);
          }
          appointmentModal = document.getElementById('appointmentModal');
          leaveModal = document.getElementById('leaveModal');
          reportModal = document.getElementById('reportModal');

          form = document.getElementById('appointmentForm');
          leaveForm = document.getElementById('leaveForm');
          notesTextarea = document.getElementById('notes-content');
          phoneEl = document.getElementById('customer_phone');
          customerFields = document.getElementById('customer-fields-left');
          submitBtn = document.getElementById('submit-btn');
          deleteBtn = document.getElementById('deleteBtn');
          eventIdInput = document.getElementById('event_id');
          assistantSelect = document.getElementById('assistant_select');
          amountInput = document.getElementById('amount_input');
          unsetPaidBtn = document.getElementById('unsetPaidBtn');
          lastVisitInfo = document.getElementById('last-visit-info');
          lastVisitInfoRight = document.getElementById('last-visit-info-right');
          appointmentContent = appointmentModal ? appointmentModal.querySelector('.modal-content') : null;
          appointmentActions = document.querySelector('#appointmentForm .modal-actions');
          appointmentActionsAnchor = document.getElementById('appointment-actions-anchor');
          appointmentInfoCard = document.getElementById('appointment-info-card');
          
          appointmentCloseButton = appointmentModal ? appointmentModal.querySelector('.close-button') : null;
          leaveCloseButton = leaveModal ? leaveModal.querySelector('.close-button') : null;
          reportCloseButton = reportModal ? reportModal.querySelector('.close-button') : null;

          deleteLeaveBtn = document.getElementById('deleteLeaveBtn');

          function placeAppointmentActions(mode) {
            if (!appointmentActions || !appointmentActionsAnchor) return;
            if (mode === 'create' && appointmentInfoCard && appointmentModal) {
              appointmentModal.classList.add('is-create');
              appointmentInfoCard.appendChild(appointmentActions);
              return;
            }
            if (appointmentModal) appointmentModal.classList.remove('is-create');
            appointmentActionsAnchor.after(appointmentActions);
          }

          initializeCalendar();
          fetchAllCloudData();
          bindEventListeners();

          async function fetchDailyNote(dStr) {
            const meta = document.querySelector('.notes-meta span');
            const notesTextarea = document.getElementById('notes-content');
            notesTextarea.value = '';
            notesTextarea.placeholder = 'ç•™è¨€è¼‰å…¥ä¸­...';
            meta.textContent = 'è¼‰å…¥ä¸­...';
            try {
              const r = await fetch(APPS_SCRIPT_WEB_APP_URL + '?action=getNotes&date=' + encodeURIComponent(dStr));
              const j = await r.json();
              notesTextarea.value = j.content || '';
              meta.textContent = 'å·²è¼‰å…¥';
            } catch (e) {
              meta.textContent = 'è¼‰å…¥å¤±æ•—';
              console.error("è®€å–ç•™è¨€å¤±æ•—:", e);
            } finally {
              notesTextarea.placeholder = 'è«‹è¼¸å…¥å‚™è¨»è³‡è¨Š...';
            }
          }

          function initializeCalendar() {
            calendar = new FullCalendar.Calendar(calendarEl, {
              schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
              locale: 'zh-tw',
              timeZone: 'Asia/Taipei',
              initialView: 'resourceTimeGridDay',
              headerToolbar: false,
              firstDay: 2,
              hiddenDays: [1],
              buttonText: { today: 'ä»Š', dayGridMonth: 'æœˆ', resourceTimeGridDay: 'æ—¥', resourceTimeGridWeek: 'é€±' },
              allDaySlot: false,
              slotMinTime: '12:00:00',
              slotMaxTime: '21:00:00',
              slotDuration: '00:15:00',
              slotLabelInterval: '00:15:00',
              slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
              dayHeaderContent: function (arg) {
                const date = arg.date;
                const weekdayMap = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                return weekdayMap[date.getDay()];
              },
              displayEventTime: false,
              height: 'auto',
              expandRows: false,
              handleWindowResize: true,
              businessHours: [{ daysOfWeek: [0, 2, 3, 4, 5, 6], startTime: '00:00', endTime: '24:00' }],
              resources: RESOURCE_LIST,
              events: APPS_SCRIPT_WEB_APP_URL + '?action=getEvents',
                views: {
                resourceTimeGridWeek: { hiddenDays: [1] },
                dayGridMonth: { eventDisplay: 'auto', displayEventTime: false, fixedWeekCount: false, showNonCurrentDates: false, dayMaxEventRows: 3 }
              },
              selectable: true,
              dateClick: function (info) {
                if (info.view.type === 'dayGridMonth') {
                  calendar.changeView('resourceTimeGridDay', info.date);
                  return;
                }
                if (info.view.type === 'resourceTimeGridDay' || info.view.type === 'resourceTimeGridWeek') {
                  if (window.matchMedia && (window.matchMedia('(pointer: coarse)').matches || window.matchMedia('(max-width: 1024px)').matches)) return;
                  openApptModalForCreate(info.date, info.resource);
                }
              },
              eventClick: function(info) {
                info.jsEvent.preventDefault();
                info.jsEvent.stopPropagation();
                openApptModalForEdit(info.event);
              },
              dayCellDidMount: function (arg) {
                if (arg.view.type !== 'dayGridMonth') return;
                const currentMonth = arg.view.currentStart.getMonth();
                const cellMonth = arg.date.getMonth();
                if (cellMonth !== currentMonth) return;
                const d = arg.date.getDay();
                if (d === 4) arg.el.classList.add('leave-boss');
                if (d === 2) arg.el.classList.add('leave-xiaobai');
                if (d === 0) arg.el.classList.add('leave-yatting');
              },
              selectLongPressDelay: 250,
              datesSet: function (info) {
                updateToolbarTitle(info);
                updateDateScroller(info);
                applyMobileResourceVisibility(info);
                paintMondayClosed(info);
                paintEmployeeLeave();
                syncFullyBookedButtons();
                schedulePerResourceTimeAxis(80);
                // æ›´æ–° currentYmd
                currentYmd = ymd(info.start);

                // åœ¨æ—¥è¦–åœ–æ™‚,åŒæ­¥ selectedDate
                if (info.view && info.view.type === 'resourceTimeGridDay') {
                  selectedDate = new Date(info.view.currentStart);
                  selectedDate.setHours(12, 0, 0, 0);
                }

                fetchDailyNote(currentYmd);
              },
              resourceLabelDidMount: function (arg) {
                const viewType = arg.view?.type || calendar?.view?.type;
                const cushionEl = (arg.el && arg.el.querySelector) ? arg.el.querySelector('.fc-col-header-cell-cushion') : null;
                const hostEl = cushionEl || arg.el;
                if (!hostEl) return;
                hostEl.style.position = 'relative';
                hostEl.style.overflow = 'visible';
                hostEl.classList.add('resource-cushion');
                hostEl.querySelectorAll?.('.header-button-group').forEach(n => n.remove());

                const isDayView = viewType === 'resourceTimeGridDay';
                if (!isDayView) return;

                const rid = String(arg?.resource?.id ?? '');
                const headerBgByRid = { '1': 'var(--resource-col-1-bg)', '2': 'var(--resource-col-2-bg)', '3': 'var(--resource-col-3-bg)' };
                if (headerBgByRid[rid]) {
                  hostEl.dataset.resourceId = rid;
                  if (arg.el && arg.el !== hostEl) arg.el.dataset.resourceId = rid;
                }

                const btnGroup = document.createElement('div');
                btnGroup.className = 'header-button-group';

                const leaveIconButton = document.createElement('button');
                leaveIconButton.type = 'button';
                leaveIconButton.className = 'leave-icon-button';
                leaveIconButton.textContent = 'æ’ä¼‘';
                btnGroup.appendChild(leaveIconButton);
                leaveIconButton.addEventListener('click', function (event) {
                  event.preventDefault(); event.stopPropagation();
                  setTimeout(() => { openLeaveModal(calendar.view.currentStart, arg.resource); }, 0);
                });

                const dStr = ymd(calendar.view.currentStart);
                const isFB = Array.isArray(employeeLeaveData) && employeeLeaveData.some(l => l.date === dStr && l.resourceId === arg.resource.id && l.reason === 'å·²ç´„æ»¿');
                const fbBtn = document.createElement('button');
                fbBtn.type = 'button';
                fbBtn.className = 'fully-booked-button' + (isFB ? ' fb-active' : '');
                fbBtn.dataset.resourceId = String(arg.resource.id);
                fbBtn.textContent = isFB ? 'å·²ç´„æ»¿' : 'ç´„æ»¿';
                btnGroup.appendChild(fbBtn);
                hostEl.appendChild(btnGroup);

                fbBtn.addEventListener('click', async (e) => {
                  e.stopPropagation();
                  const date = ymd(calendar.view.currentStart);
                  const resourceId = arg.resource.id;
                  try {
                    if (fbBtn.classList.contains('fb-active')) {
                      const res = await fetch(APPS_SCRIPT_WEB_APP_URL, { method: 'POST', mode: 'cors', body: JSON.stringify({ action: 'deleteLeave', resourceId, date }) });
                      const j = await res.json(); if (j.status !== 'success') throw new Error(j.message);
                      if (Array.isArray(employeeLeaveData)) {
                        const i = employeeLeaveData.findIndex(l => l.date === date && l.resourceId === resourceId && l.reason === 'å·²ç´„æ»¿');
                        if (i !== -1) employeeLeaveData.splice(i, 1);
                      }
                      fbBtn.classList.remove('fb-active'); fbBtn.textContent = 'ç´„æ»¿';
                    } else {
                      const res = await fetch(APPS_SCRIPT_WEB_APP_URL, { method: 'POST', mode: 'cors', body: JSON.stringify({ action: 'saveLeave', resourceId, date, reason: 'å·²ç´„æ»¿' }) });
                      const j = await res.json(); if (j.status !== 'success') throw new Error(j.message);
                      if (Array.isArray(employeeLeaveData)) employeeLeaveData.push({ date, resourceId, reason: 'å·²ç´„æ»¿' });
                      fbBtn.classList.add('fb-active'); fbBtn.textContent = 'å·²ç´„æ»¿';
                    }
                    paintEmployeeLeave(); syncFullyBookedButtons();
                  } catch (err) { alert('åˆ‡æ›ç´„æ»¿å¤±æ•—ï¼š' + err.message); }
                });
              },
              select: function (info) { openApptModalForCreate(info.start, info.resource); },
              eventContent: function (arg) {
                const ep = arg.event.extendedProps || {};
                const svcMap = { 
                  'å‰ªé«®': ['å‰ª'], 
                  'æŸ“': ['æŸ“'], 
                  'ç‡™': ['ç‡™'], 
                  'æŸ“+ç‡™': ['ç‡™', 'æŸ“'], 
                  'é ­çš®è­·ç†': ['è­·'],
                  // ä¿ç•™ç›¸å®¹æ€§
                  'å‰ª+æŸ“': ['æŸ“'], 
                  'å‰ª+ç‡™': ['ç‡™'], 
                  'å‰ª+æŸ“+ç‡™': ['æŸ“', 'ç‡™'], 
                  'å‰ª+é ­çš®è­·ç†': ['è­·'] 
                };
                if (ep.appointment_type === 'blocked') {
                  return { html: `<div class="fc-event-title evt-line evt-blocked"><span class="blocked-icon material-symbols-outlined" aria-hidden="true">pan_tool</span><span class="evt-col-note">${ep.notes ? ep.notes : ''}</span></div>` };
                }
                const svcList = svcMap[ep.service_id] || ['é '];
                const svcClassMap = { 'å‰ª': 'svc-cut', 'æŸ“': 'svc-dye', 'ç‡™': 'svc-perm', 'è­·': 'svc-treat', 'é ': 'svc-default' };
                const safeTrim = (v) => (v != null ? String(v).trim() : '');
                const name = safeTrim(ep.customer_name) || safeTrim(ep.notes);
                const phone = safeTrim(ep.customer_phone);
                const paidAmount = Number(ep.total_amount) || Number(ep.amount);  // å„ªå…ˆä½¿ç”¨ç¸½é‡‘é¡ï¼ŒèˆŠè³‡æ–™ç”¨å…¥å¸³é‡‘é¡
                const isPaid = ep.appointment_type !== 'blocked' && !Number.isNaN(paidAmount) && paidAmount > 0;
                const currencyFormatter = new Intl.NumberFormat('zh-TW');
                
                // [ä¿®æ”¹] çµå¸³å¾Œé¡¯ç¤º: åŠ©ç†åå­— + é‡‘é¡
                let amountLabel = '';
                if(isPaid) {
                    const asst = ep.assistant_id || '';
                    amountLabel = (asst ? asst + ' ' : '') + '$' + currencyFormatter.format(paidAmount);
                }

                const badgeText = svcList.join('');
                const badgeKey = (svcList && svcList[0]) ? svcList[0] : 'é ';
                const badgeCls = svcClassMap[badgeKey] || 'svc-default';
                const servicesHtml = `<span class="evt-svc ${badgeCls}">${badgeText}</span>`;
                return { html: `<div class="fc-event-title evt-line"><span class="evt-col-svc"><span class="evt-services">${servicesHtml}</span></span><span class="evt-col-name">${name}</span><span class="evt-col-phone">${isPaid ? amountLabel : phone}</span></div>` };
              },
              eventClassNames: function (arg) {
                const r = arg.event.getResources();
                const cls = (r && r[0]) ? ['sty-' + r[0].id] : [];
                const ep = arg.event.extendedProps || {};
                if (ep.appointment_type === 'blocked') cls.push('blocked-time');
                const paidAmount = Number(ep.amount);
                if (ep.appointment_type !== 'blocked' && !Number.isNaN(paidAmount) && paidAmount > 0) cls.push('is-paid');
                return cls;
              },
            });
            calendar.render();
          }

          async function fetchAllCloudData() {
            try {
              const leaveRes = await fetch(APPS_SCRIPT_WEB_APP_URL + '?action=getLeave');
              if (!leaveRes.ok) throw new Error('ç„¡æ³•å¾å¾Œç«¯ç²å–æ’ä¼‘è³‡æ–™');
              employeeLeaveData = await leaveRes.json();
              paintEmployeeLeave(); syncFullyBookedButtons();
            } catch (error) { console.error('è®€å–é›²ç«¯è³‡æ–™å¤±æ•—:', error); }
          }

          function syncFullyBookedButtons() {
            try {
              if (!calendar || !employeeLeaveData || calendar.view?.type !== 'resourceTimeGridDay') return;
              const dStr = ymd(calendar.view.currentStart);
              document.querySelectorAll('#calendar .fully-booked-button[data-resource-id]').forEach(btn => {
                const rid = btn.dataset.resourceId;
                const isFB = employeeLeaveData.some(l => l.date === dStr && String(l.resourceId) === String(rid) && l.reason === 'å·²ç´„æ»¿');
                if (isFB) { btn.classList.add('fb-active'); btn.textContent = 'å·²ç´„æ»¿'; } else { btn.classList.remove('fb-active'); btn.textContent = 'ç´„æ»¿'; }
              });
            } catch (e) {}
          }

          function showToast(message, type = 'info', duration = 2000) {
            let container = document.getElementById('toast-container');
            if (!container) { container = document.createElement('div'); container.id = 'toast-container'; document.body.appendChild(container); }
            const toast = document.createElement('div');
            toast.className = `toast toast--${type}`; toast.textContent = message;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('is-visible'));
            window.setTimeout(() => { toast.classList.remove('is-visible'); toast.addEventListener('transitionend', () => toast.remove(), { once: true }); }, duration);
          }

          function normalizePhone(value) {
            return String(value || '').replace(/\D/g, '').slice(0, 10);
          }

          function formatLastVisitLabel(rawStart) {
            if (!rawStart) return null;
            const normalized = String(rawStart || '').trim().replace(/\s+/g, 'T');
            const parsed = new Date(normalized);
            if (isNaN(parsed.getTime())) return String(rawStart).trim();
            const adjusted = new Date(parsed.getTime() - 12 * 60 * 60 * 1000); // é¡¯ç¤ºæ™‚æ‰£æ‰ 12 å°æ™‚
            const pad = v => String(v).padStart(2, '0');
            return `${adjusted.getFullYear()}/${pad(adjusted.getMonth() + 1)}/${pad(adjusted.getDate())}`;
          }

          function getDesignerNameById(id) {
            const rid = String(id || '').trim();
            if (!rid) return '';
            const res = Array.isArray(RESOURCE_LIST) ? RESOURCE_LIST.find(r => String(r.id) === rid) : null;
            return res ? res.title : '';
          }

          function updateLastVisitInfo(label, designerName) {
            const text = label ? `ä¸Šæ¬¡æ¶ˆè²»ï¼š${label}${designerName ? `ï¼ˆè¨­è¨ˆå¸«ï¼š${designerName}ï¼‰` : ''}` : '';
            if (lastVisitInfo) {
              lastVisitInfo.textContent = text;
              lastVisitInfo.hidden = !label;
            }
            if (lastVisitInfoRight) {
              lastVisitInfoRight.textContent = text;
              lastVisitInfoRight.hidden = !label;
            }
          }



          function removeEventOptimistically(eventId) {
            const ev = calendar.getEventById(String(eventId));
            if (!ev) return false;
            ev.remove(); return true;
          }

          function bindEventListeners() {
            phoneEl.addEventListener('input', async (e) => {
              let d = e.target.value.replace(/\D/g, '').slice(0, 10);
              if (d.length >= 7) e.target.value = d.replace(/^(\d{4})(\d{3})(\d{0,3}).*$/, (_, a, b, c) => c ? `${a}-${b}-${c}` : `${a}-${b}`);
              else if (d.length >= 5) e.target.value = d.replace(/^(\d{4})(\d{0,3}).*$/, '$1-$2');
              else e.target.value = d;

              // [CRMåŠŸèƒ½] ç•¶è¼¸å…¥æ»¿ 10 ç¢¼ä¸”éç·¨è¼¯æ¨¡å¼æ™‚ï¼Œè‡ªå‹•æŸ¥è©¢æ­·å²ç´€éŒ„ä¸¦è¿½æº¯é…æ–¹
              if (d.length === 10 && !eventIdInput.value) {
                try {
                  const res = await fetch(`${APPS_SCRIPT_WEB_APP_URL}?action=getLastVisit&phone=${d}`, { method: 'GET', mode: 'cors' });
                  const history = await res.json();
                  if (history && history.customer_name) {
                    // 1. è‡ªå‹•å¡«å…¥å§“åï¼ˆè‹¥ç›®å‰ç‚ºç©ºï¼‰
                    const nameInput = document.getElementById('customer_name');
                    if (nameInput && !nameInput.value.trim()) {
                      nameInput.value = history.customer_name;
                    }
                    // 2. è‡ªå‹•å¸¶å…¥æŸ“é«®é¡è‰²ä¸¦é¡¯ç¤ºå€å¡Š
                    if (history.dye_color) {
                      const dyeInput = document.getElementById('dye_color_input');
                      const dyeWrap = document.getElementById('dye-color-wrap');
                      if (dyeInput) dyeInput.value = history.dye_color;
                      if (dyeWrap) dyeWrap.style.display = 'grid'; // å¼·åˆ¶é¡¯ç¤ºå€å¡Š
                    }
                    // 3. å˜—è©¦åŒ¹é…å‰ªé«®åˆ†é¡ï¼ˆä¾å‰ªé«®é‡‘é¡ç™¼äº®æç¤ºï¼Œä¸è‡ªå‹•å‹¾é¸ï¼‰
                    const histCut = parseInt(history.cut_price, 10);
                    const histAmt = parseInt(history.amount, 10);
                    if (Number.isFinite(histCut) && histCut > 0) {
                      const radios = document.querySelectorAll('input[name="cut_price"]');
                      radios.forEach(r => {
                        const item = r.closest('.price-item');
                        if (item) item.classList.remove('price-item--suggested'); // æ¸…é™¤èˆŠç‹€
                        if (parseInt(r.value, 10) === histCut) {
                          if (item) item.classList.add('price-item--suggested');
                        }
                      });
                    } else if (Number.isFinite(histAmt) && histAmt > 0) {
                      const radios = document.querySelectorAll('input[name="cut_price"]');
                      radios.forEach(r => {
                        const item = r.closest('.price-item');
                        if (item) item.classList.remove('price-item--suggested'); // æ¸…é™¤èˆŠç‹€
                        if (parseInt(r.value, 10) === histAmt) {
                          if (item) item.classList.add('price-item--suggested');
                        }
                      });
                    }
                    const lastVisitLabel = formatLastVisitLabel(history.start);
                    if (lastVisitLabel) {
                      lastVisitLabelValue = lastVisitLabel;
                      lastVisitPhoneValue = normalizePhone(history.customer_phone || d);
                      lastVisitDesignerValue = getDesignerNameById(history.employee_id);
                      updateLastVisitInfo(lastVisitLabel, lastVisitDesignerValue);
                    }
                    showToast('å·²æ‰¾åˆ°æ­·å²ç´€éŒ„ä¸¦å¸¶å…¥', 'success', 2000);
                  }
                } catch (err) { console.error('CRMæŸ¥è©¢å¤±æ•—:', err); }
              }
            });

            notesTextarea.addEventListener('input', () => document.querySelector('.notes-meta span').textContent = 'æœªå„²å­˜');
            document.getElementById('save-notes-btn').addEventListener('click', async () => {
              const meta = document.querySelector('.notes-meta span'); meta.textContent = 'å„²å­˜ä¸­...';
              try {
                await fetch(APPS_SCRIPT_WEB_APP_URL, { method: 'POST', mode: 'cors', body: JSON.stringify({ action: 'saveNotes', date: currentYmd || ymd(new Date()), content: notesTextarea.value }) });
                meta.textContent = 'å·²å„²å­˜ âœ“';
              } catch (e) { meta.textContent = 'å„²å­˜å¤±æ•— âŒ'; }
            });

            leaveForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              try {
                const res = await fetch(APPS_SCRIPT_WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'saveLeave', resourceId: document.getElementById('leaveResourceId').value, date: document.getElementById('leaveDate').value, reason: document.getElementById('leaveReason').value.trim() || 'æ’ä¼‘' }), mode: 'cors' });
                const r = await res.json(); if (r.status !== 'success') throw new Error(r.message);
                calendar.refetchEvents(); leaveModal.style.display = 'none';
              } catch (err) { alert('å„²å­˜æ’ä¼‘å¤±æ•—: ' + err.message); }
            });

            deleteLeaveBtn.addEventListener('click', async () => {
              if (!confirm('ç¢ºå®šè¦å–æ¶ˆé€™ç­†æ’ä¼‘å—ï¼Ÿ')) return;
              try {
                await fetch(APPS_SCRIPT_WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteLeave', resourceId: document.getElementById('leaveResourceId').value, date: document.getElementById('leaveDate').value }), mode: 'cors' });
                calendar.refetchEvents(); leaveModal.style.display = 'none';
              } catch (err) { alert('åˆªé™¤æ’ä¼‘å¤±æ•—: ' + err.message); }
            });

            form.addEventListener('submit', async (e) => {
              e.preventDefault();
              const isEditing = !!eventIdInput.value;
              const fd = new FormData(form);
              const amountRaw = fd.get('amount_input');
              const parsedAmount = parseInt(amountRaw, 10);
              const amountValue = Number.isFinite(parsedAmount) ? String(Math.max(0, parsedAmount)) : '';
              
              // ç¢ºä¿ç¸½é‡‘é¡è¨ˆç®—æœ€æ–°
              updateCalculatedTotal();
              
              const payload = {
                action: isEditing ? 'edit' : 'create',
                id: fd.get('event_id') || undefined,
                employee_id: fd.get('employee_id'),
                start: fd.get('start_time'),
                appointment_type: fd.get('appointment_type'),
                customer_name: fd.get('customer_name') || '',
                customer_phone: (fd.get('customer_phone') || '').replace(/\D/g, ''),
                service_id: fd.get('service_id') || '',
                assistant_id: fd.get('assistant_select') || '',
                cut_price: (document.querySelector('input[name="cut_price"]:checked')?.value) || '',
                amount: amountValue,
                total_amount: window.displayTotal,  // æ–°å¢ç¸½é‡‘é¡æ¬„ä½
                notes: fd.get('notes') || '',
                duration: fd.get('duration_select') || 15,
                // [æ–°å¢] æŸ“é«®é¡è‰²å‚³é€çµ¦å¾Œç«¯
                dye_color: document.getElementById('dye_color_input').value
              };
              submitBtn.disabled = true; appointmentModal.style.display = 'none'; showToast('å„²å­˜ä¸­...', 'loading', 3000);
              let saveOk = false;
              try {
                const res = await fetch(APPS_SCRIPT_WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'cors' });
                const data = await res.json();
                if (!res.ok || data.status !== 'success') throw new Error(data.message || 'å„²å­˜å¤±æ•—');
                calendar.refetchEvents();
                saveOk = true;
              } catch (err) { alert('âŒ å„²å­˜å¤±æ•—ï¼š' + err.message); calendar.refetchEvents(); }
              finally { submitBtn.disabled = false; showToast(saveOk ? 'å·²å„²å­˜' : 'å„²å­˜å¤±æ•—', saveOk ? 'success' : 'error', 2000); }
            });

            deleteBtn.onclick = async function () {
              const eventId = eventIdInput.value.trim();
              if (!eventId || !confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†é ç´„å—ï¼Ÿ')) return;
              try {
                const res = await fetch(APPS_SCRIPT_WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id: eventId }), mode: 'cors' });
                if (removeEventOptimistically(eventId)) showToast('å·²åˆªé™¤', 'success'); else calendar.refetchEvents();
                appointmentModal.style.display = 'none';
              } catch (err) { alert('âŒ åˆªé™¤å¤±æ•—'); }
            };

            if (appointmentCloseButton) appointmentCloseButton.onclick = () => appointmentModal.style.display = 'none';
            if (leaveCloseButton) leaveCloseButton.onclick = () => leaveModal.style.display = 'none';
            if (reportCloseButton) reportCloseButton.onclick = () => reportModal.style.display = 'none';
            window.addEventListener('click', (e) => {
              if (e.target === appointmentModal) appointmentModal.style.display = 'none';
              if (e.target === leaveModal) leaveModal.style.display = 'none';
              if (e.target === reportModal) reportModal.style.display = 'none';
            });
            window.addEventListener('resize', () => { schedulePerResourceTimeAxis(150); applyMobileResourceVisibility(); });

            document.querySelectorAll('input[name="appointment_type"]').forEach(radio => {
              radio.addEventListener('change', function () {
                const isBlocked = this.value === 'blocked';
                document.getElementById('customer-fields-left').style.display = isBlocked ? 'none' : 'block';
                document.getElementById('settlement-col').style.display = (!!eventIdInput.value && !isBlocked) ? 'block' : 'none';
                document.getElementById('notes').placeholder = isBlocked ? 'ä¸ç´„æ™‚æ®µå‚™è¨»...' : 'è«‹è¼¸å…¥å‚™è¨»è³‡è¨Š...';
                const actions = document.querySelector('.modal-actions');
                const content = document.querySelector('.modal-content');
                if (!isBlocked && eventIdInput.value) { actions.style.gridColumn = '1 / -1'; content.style.maxWidth = '900px'; }
                else { actions.style.gridColumn = '1 / 2'; content.style.maxWidth = '450px'; }
                
                if (isBlocked) {
                  assistantSelect.value = ''; amountInput.value = '';
                  document.getElementById('perm_select').value = '';
                  document.getElementById('retail_item').value = ''; document.getElementById('retail_price').value = '';
                  document.getElementById('material-cost-wrap').style.display = 'none';
                  document.querySelectorAll('input[name="cut_price"][value="0"]').forEach(r => r.checked = true);
                  document.querySelectorAll('input[name="other_item"]').forEach(c => c.checked = false);
                  // Clear new fields
                  document.getElementById('cut_custom').value = '';
                  document.getElementById('perm_custom').value = '';
                  document.getElementById('other_custom').value = '';
                  document.getElementById('dye-color-wrap').style.display = 'none';
                  updateCalculatedTotal();
                  submitBtn.textContent = 'è¨­å®šä¸ç´„æ™‚æ®µ';
                } else {
                  submitBtn.textContent = eventIdInput.value ? 'æ›´æ–°é ç´„' : 'å„²å­˜é ç´„';
                }
              });
            });

            // [æ–°å¢] ç›£è½å·¦å³ç®­é ­
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            if(prevBtn) prevBtn.addEventListener('click', () => {
              // äº¤çµ¦ FullCalendar è™•ç†æ—¥æœŸè®Šæ›´ï¼ˆdatesSet äº‹ä»¶æœƒåŒæ­¥ selectedDateï¼‰
              calendar.prev();
            });
            if(nextBtn) nextBtn.addEventListener('click', () => {
              // äº¤çµ¦ FullCalendar è™•ç†æ—¥æœŸè®Šæ›´ï¼ˆdatesSet äº‹ä»¶æœƒåŒæ­¥ selectedDateï¼‰
              calendar.next();
            });

            // [æ–°å¢] ç›£è½æŸ“é«®é¸é …ï¼Œé¡¯ç¤ºé¡è‰²è¼¸å…¥æ¡†
            document.querySelectorAll('input[name="other_item"]').forEach(cb => {
              cb.addEventListener('change', function() {
                const label = this.parentElement.textContent;
                if(label.includes('æŸ“é«®')) {
                   document.getElementById('dye-color-wrap').style.display = this.checked ? 'grid' : 'none';
                }
                updateCalculatedTotal();
              });
            });

            const priceInputs = document.querySelectorAll('input[name="cut_price"], input[name="other_item"], #perm_select, #retail_price, #bleach4000_cost, #cut_custom, #perm_custom, #other_custom');
            priceInputs.forEach(input => {
                input.addEventListener('change', updateCalculatedTotal);
                if (input.type === 'number' || input.type === 'text') input.addEventListener('input', updateCalculatedTotal);
            });

            const materialCostWrap = document.getElementById('material-cost-wrap');
            const customMaterialCostInput = document.getElementById('custom_material_cost');
            const syncMaterialCostUI = () => {
              const otherItems = Array.from(document.querySelectorAll('input[name="other_item"]:checked')).map(i => i.parentElement.textContent.trim());
              const isOtherCustom = (parseInt(document.getElementById('other_custom').value, 10) || 0) > 0;
              const isPermCustom = (parseInt(document.getElementById('perm_custom').value, 10) || 0) > 0;
              const hasTrigger = otherItems.some(label => label.includes('æ¼‚4000')) || isOtherCustom || isPermCustom;
              
              if (materialCostWrap) materialCostWrap.style.display = hasTrigger ? 'grid' : 'none';
            };
            // ç›£è½æ‰€æœ‰å¯èƒ½è§¸ç™¼ææ–™è²»é¡¯ç¤ºçš„æ¬„ä½
            document.querySelectorAll('input[name="other_item"], #other_custom, #perm_custom').forEach(el => {
              el.addEventListener('change', syncMaterialCostUI);
              el.addEventListener('input', syncMaterialCostUI);
            });
            customMaterialCostInput?.addEventListener('input', updateCalculatedTotal);

            if (unsetPaidBtn) {
              unsetPaidBtn.addEventListener('click', function () {
                if (!eventIdInput.value) return;
                if (!confirm('è¦æŠŠé€™ç­†æ”¹å›æœªçµå¸³å—ï¼Ÿ')) return;
                document.querySelectorAll('input[name="cut_price"][value="0"]').forEach(r => r.checked = true);
                document.querySelectorAll('input[name="other_item"]').forEach(c => c.checked = false);
                document.getElementById('perm_select').value = '';
                document.getElementById('retail_item').value = ''; document.getElementById('retail_price').value = '';
                assistantSelect.value = ''; amountInput.value = '';
                document.getElementById('cut_custom').value = '';
                document.getElementById('perm_custom').value = '';
                document.getElementById('other_custom').value = '';
                document.getElementById('dye-color-wrap').style.display = 'none';
                updateCalculatedTotal();
                submitBtn.click();
              });
            }
          }

          function updateCalculatedTotal() {
              let cutPrice = 0;
              let chemTotal = 0;
              let totalCost = 0;

              let chemTriggerActive = false;
              let defaultChemCost = 0;

              const cut = document.querySelector('input[name="cut_price"]:checked');
              if (cut) {
                  cutPrice = parseInt(cut.value, 10) || 0;
                  totalCost += parseInt(cut.dataset.cost || 0, 10);
              }
              // [æ–°å¢] å‰ªé«®è‡ªè¨‚
              cutPrice += (parseInt(document.getElementById('cut_custom').value, 10) || 0);

              document.querySelectorAll('input[name="other_item"]:checked').forEach(item => {
                  const p = parseInt(item.value, 10) || 0;
                  let c = parseInt(item.dataset.cost || 0, 10) || 0;
                  const label = item.parentElement.textContent.trim();
                  
                  if (label.includes('æ¼‚4000')) {
                      chemTriggerActive = true;
                      defaultChemCost += c; // ç´¯è¨ˆæ¼‚4000çš„é è¨­æˆæœ¬
                  } else {
                      totalCost += c; // æŸ“é«®ã€æ´—é«®æˆ–å…¶ä»–
                  }
                  chemTotal += p;
              });
              // [æ–°å¢] å…¶ä»–è‡ªè¨‚
              const oc = (parseInt(document.getElementById('other_custom').value, 10) || 0);
              if (oc > 0) chemTriggerActive = true;
              chemTotal += oc;

              const permSelect = document.getElementById('perm_select');
              let permPrice = 0;
              if (permSelect) {
                  permPrice = parseInt(permSelect.value, 10) || 0;
                  const opt = permSelect.selectedOptions[0];
                  totalCost += opt ? (parseInt(opt.dataset.cost || 0, 10) || 0) : 0;
              }
              // [æ–°å¢] ç‡™é«®è‡ªè¨‚
              const pc = (parseInt(document.getElementById('perm_custom').value, 10) || 0);
              if (pc > 0) chemTriggerActive = true;
              permPrice += pc;

              // è™•ç†çµ±ä¸€ææ–™è²»
              const customMaterialVal = parseInt(document.getElementById('custom_material_cost').value, 10) || 0;
              if (chemTriggerActive) {
                  if (customMaterialVal > 0) totalCost += customMaterialVal;
                  else totalCost += defaultChemCost;
              }

              const retailInput = document.getElementById('retail_price');
              let retailVal = parseInt(retailInput?.value, 10) || 0;

              const displayTotal = cutPrice + chemTotal + permPrice + retailVal;
              const netAmount = displayTotal - totalCost;

              document.getElementById('display-total').textContent = '$' + displayTotal;
              document.getElementById('display-net').textContent = '$' + netAmount;
              const finalAmount = netAmount > 0 ? netAmount : '';
              document.getElementById('amount_input').value = finalAmount;
              
              // æ›´æ–°å…¨åŸŸ displayTotal
              window.displayTotal = displayTotal;
              
              if (unsetPaidBtn && eventIdInput.value) {
                const show = !document.querySelector('input[name="appointment_type"][value="blocked"]').checked && Number.isFinite(netAmount) && netAmount > 0;
                unsetPaidBtn.style.display = show ? 'inline-flex' : 'none';
              }
          }

          function paintEmployeeLeave() {
            document.querySelectorAll('#calendar .leave-overlay').forEach(n => n.remove());
            document.querySelectorAll('#calendar .fully-booked-outline').forEach(n => n.remove());
            if (!Array.isArray(employeeLeaveData)) return;
            employeeLeaveData.forEach(leave => {
              const targetColumn = document.querySelector(`#calendar .fc-timegrid-col[data-date="${leave.date}"][data-resource-id="${leave.resourceId}"]`);
              if (!targetColumn) return;
              const frame = targetColumn.querySelector('.fc-timegrid-col-frame') || targetColumn;
              if (leave.reason === 'å·²ç´„æ»¿') {
                const o = document.createElement('div'); o.className = 'fully-booked-outline'; frame.appendChild(o);
                return;
              }
              const ov = document.createElement('div'); ov.className = 'closed-overlay leave-overlay';
              const label = document.createElement('span'); label.className = 'overlay-label'; label.textContent = leave.reason;
              ov.appendChild(label); frame.appendChild(ov);
            });
          }

          function openLeaveModal(date, resource) {
            const dateStr = ymd(date);
            const existingLeave = Array.isArray(employeeLeaveData) ? employeeLeaveData.find(l => l.date === dateStr && l.resourceId === resource.id) : null;
            document.getElementById('leaveResourceId').value = resource.id;
            document.getElementById('leaveDate').value = dateStr;
            document.getElementById('leaveModalResourceName').textContent = resource.title;
            document.getElementById('leaveModalDate').textContent = dateStr;
            document.getElementById('leaveReason').value = existingLeave ? existingLeave.reason : resource.title + 'æ’ä¼‘';
            deleteLeaveBtn.style.display = existingLeave ? 'inline-block' : 'none';
            leaveModal.style.display = 'block';
          }

          function openApptModalForCreate(startDate, resource) {
            if (!resource) return;
            form.reset(); eventIdInput.value = ''; submitBtn.textContent = 'å„²å­˜'; deleteBtn.style.display = 'none';
            document.querySelector('input[name="appointment_type"][value="normal"]').checked = true;
            document.getElementById('customer-fields-left').style.display = 'block';
            document.getElementById('settlement-col').style.display = 'none';
            placeAppointmentActions('create');
            document.querySelector('.modal-actions').style.gridColumn = '1 / 2';
            if (appointmentContent) appointmentContent.style.maxWidth = '450px';
            document.getElementById('notes').placeholder = 'è«‹è¼¸å…¥å‚™è¨»è³‡è¨Š.';
            document.getElementById('employee_id').value = resource.id;
            
            const isXiaobai = String(resource.id) === '3';
            document.getElementById('xiaobai-cut-opt').style.display = isXiaobai ? 'flex' : 'none';

            assistantSelect.value = ''; amountInput.value = '';
            document.querySelectorAll('input[name="cut_price"][value="0"]').forEach(r => r.checked = true);
            document.querySelectorAll('input[name="other_item"]').forEach(c => c.checked = false);
            document.getElementById('perm_select').value = '';
            document.getElementById('retail_item').value = ''; document.getElementById('retail_price').value = '';
            document.getElementById('material-cost-wrap').style.display = 'none';
            
            // Clear new fields
            document.getElementById('cut_custom').value = '';
            document.getElementById('perm_custom').value = '';
            document.getElementById('other_custom').value = '';
            document.getElementById('dye-color-wrap').style.display = 'none';
            document.getElementById('dye_color_input').value = '';
            document.getElementById('duration_select').value = '15'; // é è¨­ 15 åˆ†é˜
            
            // [CRMåŠŸèƒ½] æ¸…é™¤ä¸Šä¸€æ¬¡ç•™ä¸‹çš„å»ºè­°ç™¼äº®ç‹€æ…‹
            document.querySelectorAll('.price-item--suggested').forEach(el => el.classList.remove('price-item--suggested'));
            updateLastVisitInfo('', '');
            
            updateCalculatedTotal();

            const minuteSelect = document.getElementById('minute_select'); minuteSelect.innerHTML = '';
            const baseMin = startDate.getMinutes();
            for (let i = 0; i < 3; i++) {
              const currentMinute = baseMin + (i * 5);
              const opt = document.createElement('option');
              opt.value = currentMinute; opt.textContent = String(currentMinute).padStart(2, '0');
              if (i === 0) opt.selected = true;
              minuteSelect.appendChild(opt);
            }
            updateHiddenStartTime(startDate);
            minuteSelect.onchange = function () { updateHiddenStartTime(startDate) };
            appointmentModal.style.display = 'block';
          }

          function openApptModalForEdit(event) {
            form.reset();
            const ep = event.extendedProps || {};
            eventIdInput.value = event.id;
            deleteBtn.style.display = 'inline-block';
            const rs = event.getResources();
            document.getElementById('employee_id').value = (rs && rs[0] ? rs[0].id : '');
            document.getElementById('customer_phone').value = ep.customer_phone || '';
            document.getElementById('customer_name').value = ep.customer_name || '';
            const normalizedEditPhone = normalizePhone(ep.customer_phone || '');
            if (normalizedEditPhone && normalizedEditPhone === lastVisitPhoneValue && lastVisitLabelValue) {
              updateLastVisitInfo(lastVisitLabelValue, lastVisitDesignerValue);
            } else {
              updateLastVisitInfo('', '');
            }
            const serviceSelect = document.getElementById('service_id');
            if(serviceSelect) serviceSelect.value = ep.service_id || '';
            document.getElementById('notes').value = ep.notes || '';
            assistantSelect.value = ep.assistant_id || '';
            amountInput.value = ep.amount !== undefined ? ep.amount : '';
            
            // [æ–°å¢] å›å¡«æŸ“é«®é¡è‰²
            const dyeInput = document.getElementById('dye_color_input');
            if(dyeInput) dyeInput.value = ep.dye_color || '';
            if(ep.dye_color) document.getElementById('dye-color-wrap').style.display = 'grid';
            else document.getElementById('dye-color-wrap').style.display = 'none';

            const isBlocked = ep.appointment_type === 'blocked';
            document.querySelector(`input[name="appointment_type"][value="${isBlocked ? 'blocked' : 'normal'}"]`).checked = true;
            document.getElementById('customer-fields-left').style.display = isBlocked ? 'none' : 'block';
            document.getElementById('settlement-col').style.display = isBlocked ? 'none' : 'block';
            placeAppointmentActions('edit');
            document.querySelector('.modal-actions').style.gridColumn = isBlocked ? '1 / 2' : '1 / -1';
            if (appointmentContent) appointmentContent.style.maxWidth = isBlocked ? '450px' : '900px';
            
            const isXiaobai = (rs && rs[0] && String(rs[0].id) === '3');
            document.getElementById('xiaobai-cut-opt').style.display = isXiaobai ? 'flex' : 'none';

            // Reset billing default
            document.querySelectorAll('input[name="cut_price"][value="0"]').forEach(r => r.checked = true);
            document.querySelectorAll('input[name="other_item"]').forEach(c => c.checked = false);
            document.getElementById('perm_select').value = '';
            document.getElementById('material-cost-wrap').style.display = 'none';
            // Clear new custom fields
            document.getElementById('cut_custom').value = '';
            document.getElementById('perm_custom').value = '';
            document.getElementById('other_custom').value = '';

            // å›å¡«å‰ªé«®é‡‘é¡ï¼ˆèˆŠè³‡æ–™æ²’æœ‰å°±ä¿ç•™é è¨­ 0ï¼‰
            if (ep.cut_price) {
              const cutRadio = document.querySelector(`input[name="cut_price"][value="${ep.cut_price}"]`);
              if (cutRadio) cutRadio.checked = true;
            }

            updateCalculatedTotal();
            
            if (ep.amount || ep.total_amount) {
                const totalAmt = ep.total_amount || ep.amount;
                amountInput.value = ep.amount || '';
                document.getElementById('display-net').textContent = '$' + (ep.amount || 0);
                document.getElementById('display-total').textContent = '$' + totalAmt;
                window.displayTotal = totalAmt;  // è¨­ç½®å…¨åŸŸç¸½é‡‘é¡
            }
            if (unsetPaidBtn && eventIdInput.value) {
                const show = !isBlocked && Number.isFinite(Number(amountInput.value)) && Number(amountInput.value) > 0;
                unsetPaidBtn.style.display = show ? 'inline-flex' : 'none';
            }

            // è¨ˆç®—ä¸¦å›å¡«æ™‚é•·
            if (event.start && event.end) {
              const dur = Math.round((event.end - event.start) / 60000);
              const durSelect = document.getElementById('duration_select');
              // æª¢æŸ¥æ˜¯å¦æœ‰åŒ¹é…çš„é¸é …ï¼Œè‹¥ç„¡å‰‡æš«æ™‚åŠ å…¥
              if (!Array.from(durSelect.options).some(opt => opt.value == dur)) {
                const opt = document.createElement('option');
                opt.value = dur; opt.textContent = dur + ' åˆ†é˜';
                durSelect.appendChild(opt);
              }
              durSelect.value = dur;
            }

            submitBtn.textContent = 'å„²å­˜';
            const startDate = event.start;
            const minuteSelect = document.getElementById('minute_select'); minuteSelect.innerHTML = '';
            const startMinute = startDate.getMinutes();
            for (let m = 0; m < 60; m += 5) {
              const opt = document.createElement('option');
              opt.value = m; opt.textContent = String(m).padStart(2, '0');
              if (m === startMinute) opt.selected = true;
              minuteSelect.appendChild(opt);
            }
            updateHiddenStartTime(startDate);
            minuteSelect.onchange = function () { updateHiddenStartTime(startDate) };
            appointmentModal.style.display = 'block';
          }

          function updateHiddenStartTime(baseDate) {
            const selectedMinute = parseInt(document.getElementById('minute_select').value, 10);
            const dt = new Date(baseDate.getTime());
            dt.setMinutes(selectedMinute, 0, 0);
            document.getElementById('start_time').value = dt.toISOString();
          }

          function schedulePerResourceTimeAxis(delayMs = 0) {
            if (perResourceAxisTimer) window.clearTimeout(perResourceAxisTimer);
            perResourceAxisTimer = window.setTimeout(renderPerResourceTimeAxis, delayMs);
          }
          function resetCalendarHorizontalScroll() {
            const scrollers = document.querySelectorAll('#calendar .fc-scroller');
            scrollers.forEach(s => { if (s && s.scrollWidth > s.clientWidth) s.scrollLeft = 0; });
          }
          function renderPerResourceTimeAxis() {
            document.querySelectorAll('#calendar .per-resource-time-axis').forEach(n => n.remove());
            if (!calendar || calendar.view?.type !== 'resourceTimeGridDay') return;
            resetCalendarHorizontalScroll();
            const laneCells = Array.from(document.querySelectorAll('#calendar .fc-resourceTimeGridDay-view td.fc-timegrid-slot.fc-timegrid-slot-lane[data-time]'));
            if (!laneCells.length) return;
            const byTime = new Map();
            laneCells.forEach(cell => { const t = cell.getAttribute('data-time'); if (!byTime.has(t)) byTime.set(t, cell); });
            const labelInfos = Array.from(byTime.entries()).sort((a, b) => (a[0] < b[0] ? -1 : a[0] > b[0] ? 1 : 0)).map(([t, cell]) => {
                const text = String(t).slice(0, 5); const rect = cell.getBoundingClientRect(); const minute = parseInt(String(t).slice(3, 5), 10);
                return { text, rect, kind: (minute === 0 || minute === 30 ? 'major' : 'minor') };
              });
            const frames = Array.from(document.querySelectorAll('#calendar .fc-resourceTimeGridDay-view .fc-timegrid-col[data-resource-id] .fc-timegrid-col-frame'));
            frames.forEach(frame => {
              const axis = document.createElement('div'); axis.className = 'per-resource-time-axis';
              const frameRect = frame.getBoundingClientRect();
              labelInfos.forEach(info => {
                const item = document.createElement('div'); item.className = `per-resource-time-item ${info.kind === 'major' ? 'is-major' : 'is-minor'}`;
                item.textContent = info.text; item.style.top = `${info.rect.top - frameRect.top + info.rect.height / 2}px`;
                axis.appendChild(item);
              });
              frame.appendChild(axis);
            });
          }

          function ensureDateScroller() {
            const cal = document.getElementById('calendar'); if (!cal) return null;
            let scroller = cal.querySelector('.fc-date-scroller');
            if (scroller) return scroller;
            const toolbar = cal.querySelector('.fc-header-toolbar');
            const viewHarness = cal.querySelector('.fc-view-harness');
            scroller = document.createElement('div'); scroller.className = 'fc-date-scroller';
            scroller.innerHTML = `
              <div class="date-row">
                <div class="date-left-col">
                  <div class="nav-arrows">
                    <button type="button" id="prev-btn" class="nav-btn"><span class="material-symbols-outlined">chevron_left</span></button>
                    <button type="button" id="next-btn" class="nav-btn"><span class="material-symbols-outlined">chevron_right</span></button>
                  </div>
                  <div class="date-label"><span class="date-header-month"></span><span class="date-header-day"></span></div>
                  <div class="date-toggle">
                    <button type="button" class="date-toggle-btn" data-view="resourceTimeGridDay">æ—¥</button>
                    <button type="button" class="date-toggle-btn" data-view="resourceTimeGridWeek">é€±</button>
                    <button type="button" class="date-toggle-btn" data-view="dayGridMonth">æœˆ</button>
                  </div>
                  <div class="mobile-resource-toggle"></div>
                </div>
                <div class="date-strip"></div>
              </div>`;
            if (toolbar) toolbar.insertAdjacentElement('afterend', scroller);
            else if (viewHarness) viewHarness.insertAdjacentElement('beforebegin', scroller);
            else cal.prepend(scroller);
            const reportBtn = document.getElementById('open-report-btn');
            if (reportBtn) scroller.querySelector('.date-toggle').appendChild(reportBtn);
            ensureMobileResourceToggle(scroller);
            return scroller;
          }

          function updateDateScroller(info) {
            const cal = document.getElementById('calendar');
            if (!cal || !info || !info.view) return;
            cal.classList.add('is-date-scroller');
            const scroller = ensureDateScroller(); if (!scroller) return; scroller.hidden = false;
            ensureMobileResourceToggle(scroller);

            // æ ¹æ“šè¦–åœ–é¡å‹æ±ºå®šé¡¯ç¤ºæ—¥æœŸï¼ˆé¿å… selectedDate èˆ‡ view ä¸ä¸€è‡´ï¼‰
            let activeDate = null;
            if (info.view.type === 'resourceTimeGridDay') {
              activeDate = new Date(info.view.currentStart);
            } else if (info.view.type === 'dayGridMonth') {
              // æœˆè¦–åœ–ï¼šä»¥ view.currentStartï¼ˆè©²æœˆç¬¬ä¸€å¤©ï¼‰ç‚ºåŸºæº–ï¼Œé¿å…é¡¯ç¤ºåˆ°å…¶ä»–æœˆä»½
              activeDate = new Date(info.view.currentStart);
            }

            // fallback: ä½¿ç”¨ selectedDate æˆ– calendar.getDate()
            if (!activeDate) {
              if (selectedDate) activeDate = new Date(selectedDate);
              else activeDate = new Date(calendar.getDate());
            }
            activeDate.setHours(12, 0, 0, 0);
            const dateLocale = 'zh-TW';
            const monthRaw = new Intl.DateTimeFormat(dateLocale, { month: 'numeric' }).format(activeDate);

            // æ›´æ–°é¡¯ç¤ºï¼ˆæœˆè¦–åœ–åƒ…é¡¯ç¤º å¹´/æœˆï¼Œä¸é¡¯ç¤ºæ—¥ï¼‰
            scroller.querySelector('.date-header-month').textContent = `${activeDate.getFullYear()}å¹´${monthRaw.includes('æœˆ') ? monthRaw : monthRaw + 'æœˆ'}`;
            if (info.view && info.view.type === 'dayGridMonth') scroller.querySelector('.date-header-day').textContent = '';
            else scroller.querySelector('.date-header-day').textContent = `${activeDate.getDate()}æ—¥`;

            syncDateToggleState(scroller, info.view.type); bindDateToggleActions(scroller);
            
            const strip = scroller.querySelector('.date-strip');
            const dates = []; const activeBase = new Date(activeDate); activeBase.setHours(12, 0, 0, 0);
            if (activeBase.getDay() === 1) activeBase.setDate(activeBase.getDate() + 1);
            const before = []; const after = [];
            let cursor = new Date(activeBase);
            while (before.length < 10) { cursor.setDate(cursor.getDate() - 1); if (cursor.getDay() === 1) continue; before.push(new Date(cursor)); }
            cursor = new Date(activeBase);
            while (after.length < 10) { cursor.setDate(cursor.getDate() + 1); if (cursor.getDay() === 1) continue; after.push(new Date(cursor)); }
            dates.push(...before.reverse(), activeBase, ...after);
            
            strip.innerHTML = '';
            const currentKey = ymd(activeDate); const todayKey = ymd(new Date());
            const weekdayFmt = new Intl.DateTimeFormat(dateLocale, { weekday: 'narrow' });
            dates.forEach(d => {
              const dateKey = ymd(d);
              const btn = document.createElement('button'); btn.type = 'button'; btn.className = 'date-item';
              if (dateKey === currentKey) btn.classList.add('is-active');
              if (dateKey === todayKey) btn.classList.add('is-today');
              btn.dataset.date = dateKey;
              btn.innerHTML = `<span class="date-item-weekday">${weekdayFmt.format(d)}</span><span class="date-item-day">${d.getDate()}</span>`;
              // ç¢ºä¿é»æ“Šæœƒåˆ‡æ›æ—¥æœŸï¼ˆæ”¯æ´æ»‘å‹•å¾Œçš„ click èˆ‡è¡Œå‹•è£ç½®ï¼‰
              btn.addEventListener('click', (e) => {
                e.preventDefault();
                // quick visual feedback for debugging
                try { btn.style.outline = '3px solid rgba(255,0,0,0.8)'; setTimeout(() => btn.style.outline = '', 600); } catch (err) {}
                console.log('date-item clicked', btn.dataset.date);
                selectDateFromItem(btn);
              });
              // pointer/touch æ”¯æ´ï¼Œéƒ¨åˆ†è£ç½®æœƒè§¸ç™¼ pointerdown/touchstart è€Œé click
              btn.addEventListener('pointerdown', (e) => {
                try { btn.style.outline = '3px solid rgba(0,122,255,0.9)'; setTimeout(() => btn.style.outline = '', 600); } catch (err) {}
                console.log('date-item pointerdown', btn.dataset.date);
                selectDateFromItem(btn);
              });
              btn.addEventListener('touchstart', (e) => {
                try { btn.style.outline = '3px solid rgba(0,200,100,0.9)'; setTimeout(() => btn.style.outline = '', 600); } catch (err) {}
                console.log('date-item touchstart', btn.dataset.date);
                selectDateFromItem(btn);
              }, { passive: true });
              strip.appendChild(btn);
            });
            enableDragScroll(strip); applyDateStripCurve(strip);
            const active = strip.querySelector('.date-item.is-active');
            if (active) {
                if(strip.dataset.centerOnNextUpdate === '1') {
                    delete strip.dataset.centerOnNextUpdate;
                    const targetLeft = active.offsetLeft - (strip.clientWidth - active.clientWidth) / 2;
                    if(typeof strip.scrollTo === 'function') strip.scrollTo({ left: Math.max(0, targetLeft), behavior: 'smooth' });
                    else strip.scrollLeft = Math.max(0, targetLeft);
                } else active.scrollIntoView({ block: 'nearest', inline: 'nearest' });
            }
          }

          function isMobileLayout() { return !!(window.matchMedia && window.matchMedia(MOBILE_RESOURCE_MEDIA_QUERY).matches); }
          function ensureMobileResourceId() { return mobileSelectedResourceId || String(RESOURCE_LIST[0]?.id || '1'); }
          function ensureMobileResourceToggle(scroller) {
            if (!scroller) return; const wrap = scroller.querySelector('.mobile-resource-toggle'); if (!wrap || wrap.dataset.bound === '1') return;
            wrap.dataset.bound = '1';
            const allBtn = `<button type="button" class="resource-toggle-btn" data-resource-id="all">å…¨éƒ¨</button>`;
            wrap.innerHTML = allBtn + RESOURCE_LIST.map(r => `<button type="button" class="resource-toggle-btn" data-resource-id="${r.id}">${r.title}</button>`).join('');
            wrap.querySelectorAll('.resource-toggle-btn').forEach(btn => btn.addEventListener('click', () => {
              const rid = btn.dataset.resourceId; mobileSelectedResourceId = rid;
              localStorage.setItem(MOBILE_RESOURCE_STORAGE_KEY, rid); applyMobileResourceVisibility(); schedulePerResourceTimeAxis(80);
            }));
          }
          function applyMobileResourceVisibility(info) {
            const cal = document.getElementById('calendar'); if (!cal) return;
            const viewType = info?.view?.type || calendar?.view?.type || '';
            const shouldShowSingle = (viewType === 'resourceTimeGridDay' && isMobileLayout());
            const scroller = cal.querySelector('.fc-date-scroller');
            if(scroller) {
                scroller.classList.toggle('is-mobile-resource', shouldShowSingle);
                scroller.querySelector('.mobile-resource-toggle').querySelectorAll('.resource-toggle-btn').forEach(btn => btn.classList.toggle('is-active', String(btn.dataset.resourceId) === String(ensureMobileResourceId())));
            }
            if(!shouldShowSingle) cal.removeAttribute('data-mobile-resource');
            else cal.setAttribute('data-mobile-resource', ensureMobileResourceId());
          }
          function applyDateStripCurve(strip) {
             /* ç°¡åŒ–ç‰ˆæ›²ç·šæ•ˆæœ */
             const items = Array.from(strip.querySelectorAll('.date-item'));
             const activeIndex = items.findIndex(i => i.classList.contains('is-active'));
             if(activeIndex === -1) return;
             items.forEach((item, idx) => {
               const dist = Math.abs(idx - activeIndex);
               item.style.setProperty('--arc-offset', `${Math.min(22, dist * 6)}px`);
               item.style.setProperty('--arc-scale', (dist === 0 ? 1.1 : Math.max(0.84, 1 - dist * 0.06)).toFixed(2));
               item.style.setProperty('--arc-opacity', (dist === 0 ? 1 : Math.max(0.45, 1 - dist * 0.12)).toFixed(2));
               item.style.setProperty('--arc-font-scale', (dist === 0 ? 1 : Math.max(0.7, 1 - dist * 0.08)).toFixed(2));
             });
          }
          function selectDateFromItem(item) {
            if(!item || !item.dataset.date) return;
            const parts = item.dataset.date.split('-').map(Number);
            selectedDate = new Date(parts[0], parts[1]-1, parts[2], 12, 0, 0, 0);
            calendar.changeView('resourceTimeGridDay', item.dataset.date);
            calendar.gotoDate(item.dataset.date);
            // debug feedback
            try { console.log('selectDateFromItem ->', item.dataset.date); } catch (e) {}
            try {
              let dbg = document.getElementById('fc-debug-banner');
              if (!dbg) {
                dbg = document.createElement('div'); dbg.id = 'fc-debug-banner';
                dbg.style.position = 'fixed'; dbg.style.right = '12px'; dbg.style.bottom = '12px'; dbg.style.padding = '6px 10px'; dbg.style.background = 'rgba(0,0,0,0.7)'; dbg.style.color = '#fff'; dbg.style.borderRadius = '6px'; dbg.style.zIndex = 99999; dbg.style.fontSize = '13px';
                document.body.appendChild(dbg);
              }
              dbg.textContent = `Selected: ${item.dataset.date}`;
              setTimeout(() => { try { dbg.textContent = ''; } catch (e) {} }, 2000);
            } catch (e) {}
            // ç«‹å³æ›´æ–° header é¡¯ç¤ºï¼Œé¿å…è¦–åœ–åˆ‡æ›æ»¯å¾Œæ™‚ç„¡åæ‡‰æ„Ÿ
            try {
              const sc = document.querySelector('.fc-date-scroller');
                if (sc) {
                const [y, m, d] = item.dataset.date.split('-').map(Number);
                const monthRaw = `${m}`;
                sc.querySelector('.date-header-month').textContent = `${y}å¹´${monthRaw}æœˆ`;
                if (calendar && calendar.view && calendar.view.type === 'dayGridMonth') sc.querySelector('.date-header-day').textContent = '';
                else sc.querySelector('.date-header-day').textContent = `${d}æ—¥`;
              }
            } catch (e) {}
            // å¼·åˆ¶æ›´æ–°æ—¥æœŸé¡¯ç¤º
            updateDateScroller({ view: calendar.view });
          }
          function syncDateToggleState(scroller, viewType) {
            scroller.querySelectorAll('.date-toggle-btn').forEach(btn => {
                const isActive = viewType === btn.dataset.view;
                btn.classList.toggle('is-active', isActive);
            });
          }
          function bindDateToggleActions(scroller) {
            if(!scroller || scroller.dataset.toggleBound === '1') return; scroller.dataset.toggleBound = '1';
            scroller.querySelectorAll('.date-toggle-btn').forEach(btn => btn.addEventListener('click', () => {
                const view = btn.dataset.view;
                if(view === 'resourceTimeGridDay') {
                    const today = new Date(); today.setHours(12,0,0,0); selectedDate = today;
                    calendar.changeView(view, ymd(today)); calendar.gotoDate(today);
                } else calendar.changeView(view, ymd(selectedDate));
            }));
          }
          function enableDragScroll(strip) {
             /* ç°¡åŒ–ç‰ˆæ‹–æ›³é‚è¼¯ */
             let isDown = false, startX, scrollLeft, moved = false, lastTouchTarget = null;
             strip.addEventListener('mousedown', (e) => { isDown = true; moved = false; startX = e.pageX; scrollLeft = strip.scrollLeft; strip.classList.add('active'); });
             strip.addEventListener('mouseleave', () => { isDown = false; strip.classList.remove('active'); lastTouchTarget = null; });
             strip.addEventListener('mouseup', (e) => { isDown = false; strip.classList.remove('active'); if(!moved && e.target.closest('.date-item')) { strip.dataset.centerOnNextUpdate='1'; selectDateFromItem(e.target.closest('.date-item')); } lastTouchTarget = null; });
             strip.addEventListener('mousemove', (e) => { if(!isDown) return; e.preventDefault(); const x = e.pageX; const walk = (x - startX) * 2; strip.scrollLeft = scrollLeft - walk; moved = true; });
             // touch support
             strip.addEventListener('touchstart', (e) => { if(!e.touches || !e.touches[0]) return; isDown = true; moved = false; startX = e.touches[0].pageX; scrollLeft = strip.scrollLeft; strip.classList.add('active'); lastTouchTarget = e.target; }, { passive: true });
             strip.addEventListener('touchend', (e) => { isDown = false; strip.classList.remove('active'); if(!moved && lastTouchTarget && lastTouchTarget.closest && lastTouchTarget.closest('.date-item')) { strip.dataset.centerOnNextUpdate='1'; selectDateFromItem(lastTouchTarget.closest('.date-item')); } lastTouchTarget = null; });
             strip.addEventListener('touchmove', (e) => { if(!isDown || !e.touches || !e.touches[0]) return; const x = e.touches[0].pageX; const walk = (x - startX) * 2; strip.scrollLeft = scrollLeft - walk; moved = true; }, { passive: false });
          }
          function updateToolbarTitle(info) {
             const el = document.querySelector('#calendar .fc-toolbar-title'); if(!el) return;
             if(info.view.type === 'dayGridMonth') { el.classList.add('is-month-title'); el.textContent = info.view.title; }
             else { el.classList.remove('is-month-title'); el.textContent = info.view.title; }
          }
          function paintMondayClosed(info) {
             document.querySelectorAll('#calendar .closed-overlay:not(.leave-overlay)').forEach(n => n.remove());
             const start = info.start, end = info.end;
             for (let d = new Date(start); d < end; d.setDate(d.getDate() + 1)) {
               if (d.getDay() !== 1) continue;
               const dateStr = ymd(d);
               document.querySelectorAll(`#calendar .fc-timegrid-col[data-date="${dateStr}"]`).forEach(col => {
                 const frame = col.querySelector('.fc-timegrid-col-frame') || col;
                 const ov = document.createElement('div'); ov.className = 'closed-overlay';
                 const label = document.createElement('span'); label.className = 'overlay-label'; label.textContent = 'å…¬ä¼‘';
                 ov.appendChild(label); frame.appendChild(ov);
               });
             }
          }
        });

        const openReportBtn = document.getElementById('open-report-btn');
        const closeReportBtn = document.querySelector('.report-close-button');
        const fetchReportBtn = document.getElementById('fetch-report-btn');
        const reportResult = document.getElementById('report-result');
        const repStart = document.getElementById('report-start');
        const repEnd = document.getElementById('report-end');

        function initReportDateRange() {
          const pad2 = (n) => String(n).padStart(2, '0');
          const now = new Date();
          if (!repStart.value) repStart.value = `${now.getFullYear()}-${pad2(now.getMonth() + 1)}-01`;
          if (!repEnd.value) repEnd.value = `${now.getFullYear()}-${pad2(now.getMonth() + 1)}-${pad2(now.getDate())}`;
        }
        if (openReportBtn) openReportBtn.addEventListener('click', () => { reportModal.style.display = 'block'; initReportDateRange(); });
        if (closeReportBtn) closeReportBtn.addEventListener('click', () => reportModal.style.display = 'none');
        if (fetchReportBtn) fetchReportBtn.addEventListener('click', async () => {
          const start = repStart.value; const end = repEnd.value;
          if (!start || !end) { reportResult.innerHTML = '<div style="color:#ffb74d; text-align:center;">è«‹é¸æ“‡èµ·è¨–æ—¥æœŸ</div>'; return; }
          reportResult.innerHTML = '<div style="text-align:center;">â³ è³‡æ–™è¨ˆç®—ä¸­...</div>';
          try {
            const res = await fetch(APPS_SCRIPT_WEB_APP_URL + `?action=getReport&startDate=${encodeURIComponent(start)}&endDate=${encodeURIComponent(end)}`);
            renderReport(await res.json());
          } catch (e) { reportResult.innerHTML = '<div style="color:#ff6b6b; text-align:center;">âŒ è®€å–å¤±æ•—</div>'; }
        });

        function renderReport(data) {
          if (!data || (!Object.keys(data.designers).length && !Object.keys(data.assistants).length)) {
            reportResult.innerHTML = '<div style="text-align:center; padding:20px; color:#ccc;">è©²å€é–“å°šç„¡é ç´„è³‡æ–™</div>'; return;
          }
          let html = '';
          html += `<h4 style="margin-top:0; border-left:4px solid var(--accent-color); padding-left:10px;">è¨­è¨ˆå¸«æ¥­ç¸¾ (40%)</h4>`;
          html += `<table class="report-table" style="margin-bottom:20px;"><thead><tr><th width="18%">è¨­è¨ˆå¸«</th><th width="10%">å®¢æ•¸</th><th width="9%">å‰ª</th><th width="9%">ç‡™</th><th width="9%">æŸ“</th><th width="22%">ç¸½é‡‘é¡</th><th width="23%">æ¥­ç¸¾æŠ½æˆ</th></tr></thead><tbody>`;
          const designerMap = { '1': 'åº—é•·', '2': 'é›…å©·', '3': 'å°ç™½' };
          for (const [id, info] of Object.entries(data.designers)) {
            const commission = Math.round((info.totalAmount || 0) * 0.4);
            html += `<tr><td style="text-align:center; font-weight:bold; color:#fff;">${designerMap[id] || id}</td><td class="num-cell">${info.count || 0}</td><td class="num-cell">${info.cutCount || info.count || 0}</td><td class="num-cell">${info.permCount || 0}</td><td class="num-cell">${info.dyeCount || 0}</td><td class="num-cell">$${(info.totalAmount || 0).toLocaleString()}</td><td class="num-cell" style="color:#ffeb3b; font-weight:bold;">$${commission.toLocaleString()}</td></tr>`;
          }
          html += `</tbody></table>`;
          html += `<h4 style="margin-top:0; border-left:4px solid #ff9800; padding-left:10px;">åŠ©ç†æ´—é ­æ¥­ç¸¾ (è¶…é300é¡†, æ¯é¡†$20)</h4>`;
          html += `<table class="report-table"><thead><tr><th width="30%">åŠ©ç†å§“å</th><th width="30%">æ´—é ­æ•¸</th><th width="40%">æ¥­ç¸¾çé‡‘</th></tr></thead><tbody>`;
          for (const [name, info] of Object.entries(data.assistants)) {
            if (!name || name === 'undefined') continue;
            const excess = Math.max(0, (info.washCount || 0) - 300);
            html += `<tr><td style="text-align:center; font-weight:bold;">${name}</td><td class="num-cell">${info.washCount || 0} <span style="font-size:0.8em; color:#aaa;">(è¶…é¡ ${excess})</span></td><td class="num-cell" style="color:#ff9800; font-weight:bold;">$${(excess * 20).toLocaleString()}</td></tr>`;
          }
          html += `</tbody></table>`;
          reportResult.innerHTML = html;
        }
      })();
    </script>
</body>
</html>
