<!DOCTYPE html>
<!--
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  é€™ä»½ `index.html` æ˜¯ã€Œä¸–ç´€é«®å»Š æ™¯ç¾åº—ã€çš„é ç´„æ’ç¨‹é é¢ï¼ˆå‰ç«¯ï¼‰ã€‚

  ä½ å¯ä»¥æŠŠå®ƒæƒ³æˆä¸‰å€‹ä¸»è¦éƒ¨åˆ†ï¼š
  1) HTMLï¼šç•«é¢éª¨æ¶ï¼ˆæ—¥æ›†å®¹å™¨ã€é ç´„å½ˆçª—ã€æ’ä¼‘å½ˆçª—ã€å ±è¡¨å½ˆçª—ã€ç•™è¨€æ¿ï¼‰
  2) CSSï¼šå¤–è§€ï¼ˆæ­¤é å¼•ç”¨ `styles.css`ï¼›ä¹Ÿå¼•ç”¨ FullCalendar çš„ CSSï¼‰
  3) JavaScriptï¼šäº’å‹•èˆ‡è³‡æ–™ï¼ˆå»ºç«‹ FullCalendarã€é–‹é—œå½ˆçª—ã€å‘¼å«å¾Œç«¯ APIï¼‰

  å¾Œç«¯è³‡æ–™ä¾†æºï¼š
  - é€é Google Apps Script Web Appï¼ˆAPPS_SCRIPT_WEB_APP_URLï¼‰æä¾› JSON API
  - å‰ç«¯ç”¨ `fetch()` ä»¥ GET/POST å‘¼å«ä¸åŒ actionï¼Œä¾‹å¦‚ï¼š
    - `?action=getEvents` å–å¾—é ç´„äº‹ä»¶
    - `?action=getLeave` å–å¾—æ’ä¼‘/ç´„æ»¿
    - `?action=saveLeave` / `deleteLeave` å„²å­˜/åˆªé™¤æ’ä¼‘
    - `?action=getNotes` / `saveNotes` è®€å¯«æ¯æ—¥ç•™è¨€
    - `?action=getReport` å–å¾—å€é–“çµ±è¨ˆ

  å°æé†’ï¼ˆå­¸ç¿’é‡é»ï¼‰ï¼š
  - `id`ï¼šç”¨ä¾†è®“ JS ç²¾æº–æŠ“åˆ°å…ƒç´ ï¼ˆgetElementByIdï¼‰
  - `class`ï¼šç”¨ä¾†å¥— CSSã€ä¹Ÿå¯ä¾› JS é¸å–/åŠ ä¸Šç‹€æ…‹ï¼ˆclassListï¼‰
  - ã€Œå½ˆçª— modalã€ï¼šé€šå¸¸ç”±é®ç½© + å…§å®¹æ¡†çµ„æˆï¼Œé€éåˆ‡æ› `display` é¡¯ç¤º/éš±è—
  - IIFEï¼šæœ¬æª”ç”¨ (function(){ ... })(); æŠŠè®Šæ•¸åŒ…åœ¨ä½œç”¨åŸŸä¸­ï¼Œé¿å…æ±¡æŸ“å…¨åŸŸ
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-->
<html lang="zh-Hant">

<head>
  <!--
      <meta charset="UTF-8">
      - è¨­å®šæ–‡ä»¶å­—å…ƒç·¨ç¢¼ç‚º UTF-8ï¼ˆå¯æ­£ç¢ºé¡¯ç¤ºç¹ä¸­ã€ç¬¦è™Ÿç­‰ï¼‰
    -->
  <meta charset="UTF-8">
  <!--
      <meta name="viewport" ...>
      - è®“æ‰‹æ©Ÿ/å¹³æ¿ä»¥æ­£ç¢ºæ¯”ä¾‹é¡¯ç¤ºï¼ˆéŸ¿æ‡‰å¼ç¶²ç«™çš„åŸºç¤è¨­å®šï¼‰
    -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- ç¶²é åˆ†é æ¨™é¡Œï¼ˆç€è¦½å™¨ tab ä¸Šçœ‹åˆ°çš„æ–‡å­—ï¼‰ -->
  <title>ä¸–ç´€é«®å»Š æ™¯ç¾åº—</title>

  <!-- FullCalendarï¼ˆè¡Œäº‹æ›†å¥—ä»¶ï¼‰èˆ‡ Schedulerï¼ˆè³‡æºæ¬„ä½ï¼šè¨­è¨ˆå¸«ï¼‰æ‰€éœ€çš„æ¨£å¼ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.11.5/main.min.css">

  <!-- Google Fontsï¼šå…ˆ preconnect å¯åŠ é€Ÿé€£ç·šï¼Œæ¸›å°‘å­—å‹è¼‰å…¥æ™‚é–“ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!--
	      å­—å‹çµ±ä¸€ï¼šNoto Sans JPï¼ˆä½ æŒ‡å®šçš„å­—å‹ï¼‰
	      - åªè¼‰å…¥é€™ä¸€å¥—å­—å‹ï¼Œé¿å…ä¸åŒå€å¡Šæ··ç”¨ä¸åŒ font-family
	      - wghtï¼š300/400/500/700 è¶³å¤ æ¶µè“‹æœ¬é çš„å­—é‡éœ€æ±‚
	    -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- Material Symbolsï¼ˆPan Tool æ‰‹æŒç¬¦è™Ÿï¼‰ -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,400,1,0&display=swap" rel="stylesheet">

  <!-- å°ˆæ¡ˆè‡ªå·±çš„æ¨£å¼ï¼ˆå¤§å¤šæ•¸ç‰ˆé¢/é¡è‰²/æŒ‰éˆ•/å½ˆçª—éƒ½åœ¨é€™è£¡å®šç¾©ï¼‰ -->
  <link rel="stylesheet" href="styles.css">

</head>

<body>
  <!--
      æ—¥æ›†ä¸»å®¹å™¨
      - `#calendar` æœƒè¢« FullCalendar æŠŠæ•´å€‹æ—¥æ›† UI render é€²ä¾†
      - å…¶ä»–å½ˆçª—(modal)æ”¾åœ¨åŒä¸€é ä¸­ï¼Œé€é JS æ§åˆ¶é¡¯ç¤º/éš±è—
    -->
  <div id="calendar-container">
    <!-- FullCalendar çš„æ›è¼‰é»ï¼ˆJS æœƒ new FullCalendar.Calendar(calendarEl, {...})ï¼‰ -->
    <div id="calendar"></div>

    <!--
          é ç´„å½ˆçª—ï¼ˆæ–°å¢/ç·¨è¼¯é ç´„éƒ½ç”¨åŒä¸€å€‹è¡¨å–®ï¼‰
          - `#appointmentModal`ï¼šæ•´å€‹é®ç½©å±¤
          - `.modal-content`ï¼šå½ˆçª—å…§å®¹å€ï¼ˆè¡¨å–®ã€æŒ‰éˆ•ï¼‰
          - `.close-button`ï¼šå³ä¸Šè§’é—œé–‰æŒ‰éˆ•ï¼ˆÃ—ï¼‰
        -->
    <div id="appointmentModal" class="modal">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <form id="appointmentForm">
          <input type="hidden" id="event_id" name="event_id">
          <input type="hidden" id="start_time" name="start_time">
          <input type="hidden" id="employee_id" name="employee_id">
          <!-- Hidden amount filled by JS calculation before submit -->
          <input type="hidden" id="amount_input" name="amount_input">

          <div class="modal-layout-grid">
            <!-- Left Column: Basic Appointment Info -->
            <div class="modal-col">
              <!-- Single consolidated card for all appointment info -->
              <div class="modal-section blue-card-section" id="appointment-info-card">
                <label>é ç´„é¡å‹</label>
                <div class="type-toggle-container">
                  <input type="radio" id="appointment-normal" name="appointment_type" value="normal" checked>
                  <input type="radio" id="appointment-blocked" name="appointment_type" value="blocked">
                  <label for="appointment-normal" class="toggle-label left">ä¸€èˆ¬é ç´„</label>
                  <label for="appointment-blocked" class="toggle-label right">ä¸ç´„æ™‚æ®µ</label>
                  <span class="sliding-glider"></span>
                </div>
                
                <hr style="border:none; border-top:1px solid rgba(255,255,255,0.1); margin:12px 0;">
                
                <div class="form-row">
                  <label for="minute_select">æ™‚é–“ (åˆ†)</label>
                  <select id="minute_select" name="minute_select"></select>
                </div>

                <!-- Customer Fields wrapper for hiding when 'Blocked' -->
                <div id="customer-fields-left">
                  <hr style="border:none; border-top:1px solid rgba(255,255,255,0.1); margin:12px 0;">
                  
                  <div class="form-row">
                    <label for="customer_name">é¡§å®¢å§“å</label>
                    <input type="text" id="customer_name" name="customer_name" placeholder="è«‹è¼¸å…¥é¡§å®¢å§“å">
                  </div>
                  
                  <div class="form-row">
                    <label for="customer_phone">é›»è©±</label>
                    <input type="tel" id="customer_phone" name="customer_phone" inputmode="numeric" autocomplete="off" placeholder="09xx-xxx-xxx">
                  </div>
                  
                  <div class="form-row">
                    <label for="service_id">é …ç›® (é¸å¡«)</label>
                    <select id="service_id" name="service_id">
                      <option value="">-- ä¸é¸ --</option>
                      <option value="å‰ªé«®">å‰ªé«®</option>
                      <option value="å‰ª+æŸ“">å‰ª+æŸ“</option>
                      <option value="å‰ª+ç‡™">å‰ª+ç‡™</option>
                      <option value="å‰ª+æŸ“+ç‡™">å‰ª+æŸ“+ç‡™</option>
                      <option value="å‰ª+é ­çš®è­·ç†">å‰ª+é ­çš®è­·ç†</option>
                    </select>
                  </div>
                </div>
                
                <hr style="border:none; border-top:1px solid rgba(255,255,255,0.1); margin:12px 0;">
                
                <label for="notes">å‚™è¨»</label>
                <textarea id="notes" name="notes" rows="3" placeholder="è«‹è¼¸å…¥å‚™è¨»è³‡è¨Š..."></textarea>
              </div>
            </div>

            <!-- Right Column: Settlement / Billing Info -->
            <div class="modal-col settlement-col" id="settlement-col">
              <!-- Single consolidated card for all settlement items -->
              <div class="modal-section settlement-section">
                  <label>å‰ªé«®é …ç›®</label>
                  <div class="price-group">
                      <label class="price-item"><span class="price-label"><input type="radio" name="cut_price" value="350" data-cost="0"> é«˜ä¸­å‰ªé«®</span> <span class="price-val">$350</span></label>
                      <label class="price-item"><span class="price-label"><input type="radio" name="cut_price" value="400" data-cost="0"> å¤§å­¸å‰ªé«®</span> <span class="price-val">$400</span></label>
                      <label class="price-item"><span class="price-label"><input type="radio" name="cut_price" value="450" data-cost="0"> æˆäººå‰ªé«®</span> <span class="price-val">$450</span></label>
                      <label class="price-item"><span class="price-label"><input type="radio" name="cut_price" value="900" data-cost="0"> å‰ª+è­·é«®</span> <span class="price-val">$1100</span></label>
                      <!-- Only show for Xiaobai -->
                      <label class="price-item" id="xiaobai-cut-opt" style="display:none;"><span class="price-label"><input type="radio" name="cut_price" value="600" data-cost="0"> æŒ‡å®šå‰ªé«®</span> <span class="price-val">$600</span></label>
                      <label class="price-item"><span class="price-label"><input type="radio" name="cut_price" value="0" data-cost="0" checked> ç„¡</span> <span class="price-val">-</span></label>
                  </div>
                  
                  <hr style="border:none; border-top:1px solid rgba(255,255,255,0.1); margin:12px 0;">
                  
                  <label>å…¶ä»–é …ç›®</label>
                  <div class="price-group">
                      <label class="price-item"><span class="price-label"><input type="checkbox" name="other_item" value="150" data-cost="0"> æ´—é«®</span> <span class="price-val">$150</span></label>
                      <label class="price-item"><span class="price-label"><input type="checkbox" name="other_item" value="1000" data-cost="270"> æŸ“é«®</span> <span class="price-val">$1000</span></label>
                      <label class="price-item"><span class="price-label"><input type="checkbox" name="other_item" value="1000" data-cost="270"> æ¼‚é«®</span> <span class="price-val">$1000</span></label>
                      <label class="price-item"><span class="price-label"><input type="checkbox" name="other_item" value="4000" data-cost="270"> æ¼‚4000</span> <span class="price-val">$4000</span></label>
                  </div>
                  <div id="bleach4000-cost-wrap" class="settlement-row" style="display:none; margin-top:10px;">
                    <label for="bleach4000_cost">æ¼‚4000 ææ–™è²»ï¼ˆè‡ªå¡«ï¼‰</label>
                    <input type="number" id="bleach4000_cost" name="bleach4000_cost" min="0" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š270">
                  </div>

                  <div class="settlement-row settlement-row--title" style="margin-top:10px;">
                    <label for="perm_select">ç‡™é«®</label>
                    <select id="perm_select" name="perm_select">
                      <option value="" data-cost="0">ç„¡</option>
                      <option value="1200" data-cost="260">1200ï¼ˆææ–™260ï¼‰</option>
                      <option value="1500" data-cost="260">1500ï¼ˆææ–™260ï¼‰</option>
                      <option value="1800" data-cost="280">1800ï¼ˆææ–™280ï¼‰</option>
                      <option value="2000" data-cost="280">2000ï¼ˆææ–™280ï¼‰</option>
                      <option value="2400" data-cost="280">2400ï¼ˆææ–™280ï¼‰</option>
                      <option value="3600" data-cost="300">3600ï¼ˆææ–™300ï¼‰</option>
                    </select>
                  </div>
                  
                  <hr style="border:none; border-top:1px solid rgba(255,255,255,0.1); margin:12px 0;">
                  
                  <div class="settlement-row settlement-row--title shop-sales-row">
                    <label for="retail_item">åº—è²©</label>
                    <div class="shop-sales-inputs">
                      <input type="text" id="retail_item" name="retail_item" placeholder="å“é …åç¨±">
                      <input type="number" id="retail_price" name="retail_price" placeholder="é‡‘é¡" min="0">
                    </div>
                  </div>
                  
                  <div class="assistant-total-row">
                    <div class="assistant-field">
                      <label for="assistant_select">æ“ä½œåŠ©ç†</label>
                      <select id="assistant_select" name="assistant_select">
                        <option value="">-- ç„¡åŠ©ç† --</option>
                        <option value="é™³ç¿">é™³ç¿</option>
                        <option value="æ´ªè‹¡èŠ³">æ´ªè‹¡èŠ³</option>
                        <option value="æ›¹å®¶æº±">æ›¹å®¶æº±</option>
                      </select>
                    </div>

                    <div class="total-display">
                      <span style="font-size:0.5em; color:#aaa; font-weight:normal;">ç¸½é‡‘é¡: </span>
                      <span id="display-total">$0</span>
                      <button type="button" id="unsetPaidBtn" class="unset-paid-btn">æ”¹å›æœªçµå¸³</button>
                      <div style="font-size:12px; color:#aaa; font-weight:normal; margin-top:4px;">(å…¥å¸³é‡‘é¡: <span id="display-net">$0</span>)</div>
                    </div>
                  </div>
              </div>
            </div>
          </div>
          
          <!-- Form Actions - Bottom of entire form, spanning both columns -->
          <div id="appointment-actions-anchor"></div>
          <div class="modal-actions" style="grid-column: 1 / -1; margin-top: 16px;">
            <button type="button" id="deleteBtn" style="display:none; background-color:#d32f2f; color:white;">åˆªé™¤é ç´„</button>
            <button type="submit" id="submit-btn" style="flex:1;">å„²å­˜</button>
          </div>
        </form>
      </div>
    </div>

    <!--
          æ’ä¼‘å½ˆçª—
          - ç”¨ä¾†åœ¨ã€Œæ—¥è¦–åœ–ã€æ›¿æŸä½è¨­è¨ˆå¸«è¨­å®šæŸä¸€å¤©çš„æ’ä¼‘åŸå› 
          - ç‰¹æ®ŠåŸå› ã€Œå·²ç´„æ»¿ã€ä¸æ˜¯å¾é€™å€‹è¡¨å–®è¼¸å…¥ï¼Œè€Œæ˜¯ç”±è¡¨é ­çš„ã€Œç´„æ»¿ã€åˆ‡æ›æŒ‰éˆ•è™•ç†
        -->
    <div id="leaveModal" class="modal">
      <div class="modal-content">
        <span class="close-button leave-close-button">&times;</span>
        <h3 id="leaveModalTitle">è¨­å®šæ’ä¼‘</h3>
        <p>æ‚¨æ­£åœ¨ç‚º <b id="leaveModalResourceName"></b> è¨­å®š <b id="leaveModalDate"></b> çš„æ’ä¼‘ç‹€æ…‹ã€‚</p>
        <form id="leaveForm" class="modal-form">
          <input type="hidden" id="leaveResourceId">
          <input type="hidden" id="leaveDate">
          <div class="modal-section form-span-2">
            <label for="leaveReason">æ’ä¼‘åŸå›  (æœƒé¡¯ç¤ºåœ¨æ ¼å­ä¸Š)</label>
            <input type="text" id="leaveReason" name="leaveReason" placeholder="ä¾‹å¦‚ï¼šåº—ä¼‘ã€ç‰¹ä¼‘ã€é€²ä¿®">
          </div>
          <div class="modal-actions">
            <button type="button" id="deleteLeaveBtn">å–æ¶ˆæ’ä¼‘</button>
            <button type="submit" id="submitLeaveBtn">å„²å­˜è¨­å®š</button>
          </div>
        </form>
      </div>
    </div>

    <!--
      æœˆçµå ±è¡¨æŒ‰éˆ•
      - é€™å€‹æŒ‰éˆ•åŸæœ¬å…ˆæ”¾åœ¨ placeholder è£¡ï¼ˆhiddenï¼‰
      - JS æœƒæŠŠå®ƒç§»åˆ°æ—¥æœŸåˆ‡æ›åˆ—ï¼ˆdate scrollerï¼‰æ—é‚Šé¡¯ç¤º
    -->
    <div id="report-trigger-placeholder" hidden>
      <button id="open-report-btn" type="button" class="report-trigger-btn">
        æŸ¥çœ‹æœˆçµå ±è¡¨
      </button>
    </div>

    <!-- å ±è¡¨å½ˆçª—ï¼ˆæŸ¥è©¢æŸæ®µæ—¥æœŸçš„å®¢æ•¸/æœå‹™åˆ†ä½ˆï¼‰ -->
    <div id="reportModal" class="modal">
      <div class="modal-content" style="max-width: 700px;">
        <span class="close-button report-close-button">&times;</span>

        <h3 style="margin-top:0;">å€é–“çµ±è¨ˆ (å®¢æ•¸)</h3>

        <div class="report-controls">
          <label for="report-start" class="report-label">èµ·æ—¥</label>
          <input type="date" id="report-start">
          <label for="report-end" class="report-label">è¿„æ—¥</label>
          <input type="date" id="report-end">
          <button id="fetch-report-btn" type="button">æŸ¥è©¢</button>
        </div>

        <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">

        <div id="report-result">
          <div style="text-align:center; color:#888; padding: 20px;">
            è«‹é¸æ“‡èµ·è¨–æ—¥æœŸï¼Œé»æ“Šã€ŒæŸ¥è©¢ã€ã€‚
          </div>
        </div>
      </div>
    </div>

    <!--
          ç•™è¨€å€ï¼ˆæ¯æ—¥å‚™å¿˜/äº¤æ¥ç”¨ï¼‰
          - `#notes-content`ï¼šè¼¸å…¥æ–‡å­—çš„ textarea
          - `#save-notes-btn`ï¼šæ‰‹å‹•å„²å­˜ï¼ˆé€é action=saveNotesï¼‰
          - `.notes-meta`ï¼šé¡¯ç¤ºã€Œæœªå„²å­˜ / å„²å­˜ä¸­ / å·²å„²å­˜ / å¤±æ•—ã€ç‹€æ…‹
        -->
    <div id="notes-section">
      <div class="notes-container">
        <div class="notes-header">
          <h4>ç•™è¨€æ¿</h4>
          <div class="notes-meta"><span>æœªå„²å­˜</span></div>
          <button id="save-notes-btn" type="button">ğŸ’¾ å„²å­˜ä»Šæ—¥ç•™è¨€</button>
        </div>
        <textarea id="notes-content" placeholder="è«‹è¼¸å…¥ä»Šæ—¥ç•™è¨€..."></textarea>
      </div>
    </div>

    <!--
          å¤–éƒ¨ JS å¥—ä»¶è¼‰å…¥é †åºï¼š
          1) FullCalendar æ ¸å¿ƒ
          2) Schedulerï¼ˆè³‡æºæ¬„ä½ï¼šè¨­è¨ˆå¸«/åº—é•·ï¼‰
          3) ä¸­æ–‡èªç³»æª”ï¼ˆzh-twï¼‰
        -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.11.5/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/locales/zh-tw.js"></script>

    <script>

      // å¾Œç«¯ Google Apps Script ç¶²å€ï¼ˆWeb App /execï¼‰
      // - é€™æ˜¯ä¸€å€‹ã€Œå…¬é–‹å¯å‘¼å«ã€çš„ HTTP ç«¯é»ï¼ˆå–æ±ºæ–¼ä½ çš„ Apps Script éƒ¨ç½²æ¬Šé™ï¼‰
      // - å‰ç«¯ç”¨ `fetch()` ä¸²æ¥ï¼Œå¾Œç«¯ç”¨ action åƒæ•¸å€åˆ†ä¸åŒ API
      const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxYe2AD8En-WNuv-Aqw9Mbf1OqY1bturPxlIJGdJzYiCU5GXkqS2cjI_tewTT8ZUiQJiA/exec';
      const RESOURCE_LIST = [
        { id: '1', title: 'åº—é•·' },
        { id: '2', title: 'é›…å©·' },
        { id: '3', title: 'å°ç™½' }
      ];
      const MOBILE_RESOURCE_STORAGE_KEY = 'sj_mobile_resource_id';
      const MOBILE_RESOURCE_MEDIA_QUERY = '(max-width: 1024px)';

      (function () {
        /*
          IIFEï¼ˆImmediately Invoked Function Expressionï¼‰ï¼š
          - ç«‹åˆ»åŸ·è¡Œçš„ä¸€å€‹å‡½å¼
          - å¥½è™•ï¼šæŠŠè®Šæ•¸/å‡½å¼åŒ…åœ¨å€åŸŸä½œç”¨åŸŸå…§ï¼Œé¿å…è·Ÿå…¶ä»– script çš„å…¨åŸŸè®Šæ•¸æ’å
        */

        // ==================== å…¨åŸŸç‹€æ…‹ï¼ˆåªåœ¨é€™å€‹ IIFE å…§æœ‰æ•ˆï¼‰ ====================
        let employeeLeaveData = []; // æ’ä¼‘/ç´„æ»¿è³‡æ–™å¿«å–ï¼ˆå¾å¾Œç«¯ action=getLeave è®€å›ä¾†ï¼‰



        // æŠŠ Date è½‰æˆ yyyy-mm-ddï¼ˆç”¨ä¾†å°é½Š DOM çš„ data-dateã€ä¹Ÿç”¨ä¾†å‘¼å«å¾Œç«¯ APIï¼‰
        const ymd = d => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;

        let currentYmd = null;      // ç›®å‰é¸åˆ°çš„æ—¥æœŸå­—ä¸²ï¼ˆç”¨ä¾†å­˜å–æ¯æ—¥ç•™è¨€ï¼‰
        let selectedDate = null;    // æ—¥æœŸæ»‘å‹•åˆ—ï¼ˆdate scrollerï¼‰ç›®å‰é¸å–çš„æ—¥æœŸ
        let calendar;               // FullCalendar å¯¦ä¾‹ï¼ˆå®£å‘Šåœ¨å¤–é¢ï¼šå„å‡½å¼éƒ½èƒ½ç”¨ï¼‰
        let perResourceAxisTimer = null; // æ’ç¨‹ï¼šæ¯ä½è¨­è¨ˆå¸«æ¬„ä½çš„æ™‚é–“è»¸é‡ç¹ªï¼ˆé¿å…çŸ­æ™‚é–“é‡è¤‡ç®—ï¼‰
        let mobileSelectedResourceId = null; // æ‰‹æ©Ÿæ—¥è¦–åœ–ï¼šç›®å‰é¸å–çš„è¨­è¨ˆå¸«å¡ç‰‡

	        // Global DOM Elements (declared here so all functions can access them)
	        let appointmentModal, leaveModal, reportModal;
	        let appointmentCloseButton, leaveCloseButton, reportCloseButton;
	        let form, leaveForm, notesTextarea, phoneEl, customerFields;
		        let submitBtn, deleteBtn, eventIdInput, assistantSelect, amountInput, deleteLeaveBtn, unsetPaidBtn;
	        let appointmentContent, appointmentActions, appointmentActionsAnchor, appointmentInfoCard;

        // ==================== DOMContentLoaded Event Listener ====================
        document.addEventListener('DOMContentLoaded', function () {
          // --- å…ƒç´ é¸æ“‡ï¼šæŠŠå¸¸ç”¨ DOM å…ˆæŠ“èµ·ä¾†ï¼ˆé¿å…æ¯æ¬¡éƒ½ queryï¼‰ ---
          // --- å…ƒç´ é¸æ“‡ï¼šæŠŠå¸¸ç”¨ DOM å…ˆæŠ“èµ·ä¾†ï¼ˆé¿å…æ¯æ¬¡éƒ½ queryï¼‰ ---
          const calendarEl = document.getElementById('calendar');
          if (calendarEl && isMobileLayout()) {
            mobileSelectedResourceId = ensureMobileResourceId();
            calendarEl.setAttribute('data-mobile-resource', mobileSelectedResourceId);
          }
          appointmentModal = document.getElementById('appointmentModal');
          leaveModal = document.getElementById('leaveModal');
          reportModal = document.getElementById('reportModal'); // Added reportModal

          form = document.getElementById('appointmentForm');
          leaveForm = document.getElementById('leaveForm');
          notesTextarea = document.getElementById('notes-content');
          phoneEl = document.getElementById('customer_phone');
          customerFields = document.getElementById('customer-fields-left') || document.getElementById('customer-fields'); // Ensure we get the correct one
          submitBtn = document.getElementById('submit-btn');
          deleteBtn = document.getElementById('deleteBtn');
          eventIdInput = document.getElementById('event_id');
	          assistantSelect = document.getElementById('assistant_select');
		          amountInput = document.getElementById('amount_input');
		          unsetPaidBtn = document.getElementById('unsetPaidBtn');
	          appointmentContent = appointmentModal ? appointmentModal.querySelector('.modal-content') : null;
	          appointmentActions = document.querySelector('#appointmentForm .modal-actions');
	          appointmentActionsAnchor = document.getElementById('appointment-actions-anchor');
	          appointmentInfoCard = document.getElementById('appointment-info-card');
	          
	          appointmentCloseButton = appointmentModal ? appointmentModal.querySelector('.close-button') : null;
	          leaveCloseButton = leaveModal ? leaveModal.querySelector('.close-button') : null;
	          reportCloseButton = reportModal ? reportModal.querySelector('.close-button') : null;

	          deleteLeaveBtn = document.getElementById('deleteLeaveBtn');
	
	          function placeAppointmentActions(mode) {
	            if (!appointmentActions || !appointmentActionsAnchor) return;
	            if (mode === 'create' && appointmentInfoCard && appointmentModal) {
	              appointmentModal.classList.add('is-create');
	              appointmentInfoCard.appendChild(appointmentActions);
	              return;
	            }
	            if (appointmentModal) appointmentModal.classList.remove('is-create');
	            appointmentActionsAnchor.after(appointmentActions);
	          }

	          // --- ç¨‹å¼ä¸€é–‹å§‹åŸ·è¡Œçš„ä¸‰å€‹ä¸»è¦å‹•ä½œï¼ˆå»º UI â†’ æŠ“è³‡æ–™ â†’ ç¶äº‹ä»¶ï¼‰ ---
	          // console.log('Init started');
          // 1) åˆå§‹åŒ–æ—¥æ›†ï¼ˆåªå»º UI/è¨­å®šï¼Œä¸å«æ’ä¼‘è³‡æ–™ï¼‰
          initializeCalendar();
          // alert('Calendar Init Done'); 

          // 2) æŠŠé›²ç«¯è³‡æ–™ï¼ˆæ’ä¼‘/ç´„æ»¿ï¼‰æŠ“å›ä¾†ä¸¦ç•«åˆ°æ—¥æ›†ä¸Š
          fetchAllCloudData();
          // 3) ç¶å®šå„ç¨®æŒ‰éˆ•/è¡¨å–®/è¼¸å…¥äº‹ä»¶
          bindEventListeners();

          // ========================================================
          // ä»¥ä¸‹å…¨éƒ¨æ˜¯å‡½å¼çš„è©³ç´°å®šç¾©
          // ========================================================
          /**
             * è®€å–ã€ŒæŸä¸€å¤©ã€çš„ç•™è¨€å…§å®¹ï¼Œä¸¦å¡«å…¥ç•™è¨€æ¿ textarea
             *
             * @param {string} dStr - æ—¥æœŸå­—ä¸²ï¼ˆyyyy-mm-ddï¼‰ï¼Œä¾‹å¦‚ "2026-01-17"
             *
             * æµç¨‹ï¼š
             * 1) å…ˆæŠŠ UI æ¸…ç©º/é¡¯ç¤ºè¼‰å…¥ä¸­ï¼ˆé¿å…ä¸Šä¸€å¤©çš„å…§å®¹æ®˜ç•™ï¼‰
             * 2) fetch å¾Œç«¯ action=getNotes
             * 3) æˆåŠŸå°±å¡«å…¥å…§å®¹ï¼›å¤±æ•—å°±é¡¯ç¤ºç‹€æ…‹ä¸¦ console.error
             */
          async function fetchDailyNote(dStr) {
            const meta = document.querySelector('.notes-meta span');
            const notesTextarea = document.getElementById('notes-content'); // ç¢ºä¿æŠ“åˆ°æœ€æ–°çš„å…ƒç´ 

            // 1. ç«‹å³æ¸…ç©ºç•™è¨€å€ä¸¦é¡¯ç¤ºè¼‰å…¥ä¸­ï¼Œé¿å…èˆŠè³‡æ–™æ®˜ç•™
            notesTextarea.value = '';
            notesTextarea.placeholder = 'ç•™è¨€è¼‰å…¥ä¸­...';
            meta.textContent = 'è¼‰å…¥ä¸­...';

            try {
              const r = await fetch(APPS_SCRIPT_WEB_APP_URL + '?action=getNotes&date=' + encodeURIComponent(dStr));
              const j = await r.json();

              // 2. è¼‰å…¥æˆåŠŸå¾Œï¼Œå¡«å…¥æ–°è³‡æ–™
              notesTextarea.value = j.content || '';
              meta.textContent = 'å·²è¼‰å…¥';
            } catch (e) {
              // 3. è¼‰å…¥å¤±æ•—çš„è™•ç†
              meta.textContent = 'è¼‰å…¥å¤±æ•—';
              console.error("è®€å–ç•™è¨€å¤±æ•—:", e); // åœ¨ä¸»æ§å°é¡¯ç¤ºè©³ç´°éŒ¯èª¤ï¼Œæ–¹ä¾¿é™¤éŒ¯
            } finally {
              // 4. ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œéƒ½æ¢å¾©é è¨­æç¤ºæ–‡å­—
              notesTextarea.placeholder = 'è«‹è¼¸å…¥å‚™è¨»è³‡è¨Š...';
            }
          }

          /**
             * åˆå§‹åŒ– FullCalendarï¼ˆå»ºç«‹æ—¥æ›† UI + è¨­å®šæ‰€æœ‰ callbackï¼‰
             *
             * é€™è£¡åšçš„äº‹æƒ…ä¸»è¦æ˜¯ã€Œå®šç¾©è¦å‰‡ã€ï¼š
             * - ç›®å‰è¦–åœ–ï¼ˆinitialViewï¼‰
             * - éœ€è¦é¡¯ç¤ºçš„è³‡æºï¼ˆresourcesï¼šåº—é•·/é›…å©·/å°ç™½ï¼‰
             * - slot çš„æ™‚é–“ç¯„åœã€é–“è·
             * - é»æ“Š/é•·æŒ‰æ™‚è¦åšä»€éº¼ï¼ˆdateClick / select / eventClickï¼‰
             * - å¦‚ä½•æ¸²æŸ“äº‹ä»¶ï¼ˆeventContent / eventClassNamesï¼‰
             *
             * å¯¦éš›äº‹ä»¶è³‡æ–™ï¼ˆeventsï¼‰æœƒç”± FullCalendar è‡ªå·±å»å‘¼å«ï¼š
             *   APPS_SCRIPT_WEB_APP_URL + '?action=getEvents'
             */
          function initializeCalendar() {
            // âœ… v5.11.5ï¼šæ’ä»¶å·²é€šé CDN è‡ªå‹•è¼‰å…¥ï¼Œä¸éœ€è¦æ‰‹å‹•å¾ globalPlugins å–å¾—

            calendar = new FullCalendar.Calendar(calendarEl, {
              schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
              locale: 'zh-tw',
              timeZone: 'Asia/Taipei',
              initialView: 'resourceTimeGridDay',

              // é€™æ˜¯å…¨åŸŸçš„å·¥å…·åˆ—è¨­å®šï¼Œå°æ‰€æœ‰è¦–åœ–éƒ½æœ‰æ•ˆ
              headerToolbar: false,

              firstDay: 2,       // å…¨åŸŸè¨­å®šï¼Œå¾é€±äºŒé–‹å§‹
              hiddenDays: [1],   // å…¨åŸŸè¨­å®šï¼Œéš±è—é€±ä¸€

          
              buttonText: {
                today: 'ä»Š',
                dayGridMonth: 'æœˆ',
                resourceTimeGridDay: 'æ—¥',
                resourceTimeGridWeek: 'é€±'
              },

              allDaySlot: false,
              slotMinTime: '12:00:00',
              slotMaxTime: '21:00:00',
              slotDuration: '00:15:00',
              slotLabelInterval: '00:15:00',
              slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
              dayHeaderContent: function (arg) {
                const date = arg.date;
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const weekdayMap = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                const weekday = weekdayMap[date.getDay()];

                return weekday;

              },
              displayEventTime: false,
              height: 'auto',
              expandRows: false,
              handleWindowResize: true,
              businessHours: [{ daysOfWeek: [0, 2, 3, 4, 5, 6], startTime: '00:00', endTime: '24:00' }],
              resources: RESOURCE_LIST,

              events: APPS_SCRIPT_WEB_APP_URL + '?action=getEvents',

              // æœˆè¦–åœ–ä¸é¡¯ç¤ºäº‹ä»¶å¡ç‰‡ï¼ˆåªçœ‹å“ªå¤©ï¼Œä¸çœ‹å–®ç­†é ç´„ï¼‰
              views: {
                // é€±è¦–åœ–çš„è¨­å®šä¿æŒä¸è®Š
                resourceTimeGridWeek: {
                  hiddenDays: [1]
                  // æ³¨æ„ï¼šæˆ‘å€‘æŠŠ headerToolbar çš„è¨­å®šç§»åˆ°å¤–é¢ï¼Œé€™è£¡ä¿æŒä¹¾æ·¨
                },

                dayGridMonth: {
                  // âœ… å–®æœˆè¦–åœ–è¨­å®š
                  eventDisplay: 'none',
                  displayEventTime: false,
                  fixedWeekCount: false,  // âœ… é¿å…é¡¯ç¤ºé¡å¤–çš„é€±æ•¸
                  showNonCurrentDates: false  // âœ… éš±è—éæœ¬æœˆçš„æ—¥æœŸ
                }
              }, // <--- views å€å¡Šåˆ°æ­¤çµæŸ

              selectable: true,

              // æœˆè¦–åœ–ï¼šé»æ—¥æœŸ â†’ è·³åˆ°è©²å¤©çš„æ—¥è¦–åœ–
              // æ—¥/é€±è¦–åœ–ï¼šæ¡Œæ©Ÿã€Œé»ä¸€ä¸‹ã€å¯ç›´æ¥é–‹æ–°å¢ï¼›æ‰‹æ©Ÿæ”¹ç”¨ã€Œé•·æŒ‰ã€ï¼ˆé¿å…æ»‘å‹•æ™‚èª¤è§¸ï¼‰
              dateClick: function (info) {
                if (info.view.type === 'dayGridMonth') {
                  calendar.changeView('resourceTimeGridDay', info.date);
                  return;
                }
                if (info.view.type === 'resourceTimeGridDay' || info.view.type === 'resourceTimeGridWeek') {
                  if (
                    window.matchMedia &&
                    (window.matchMedia('(pointer: coarse)').matches ||
                     window.matchMedia('(max-width: 1024px)').matches)
                  ) return; // æ‰‹æ©Ÿ/å¹³æ¿ï¼šæ”¹ç”±é•·æŒ‰(select)è§¸ç™¼
                  openApptModalForCreate(info.date, info.resource); // æ¡Œé¢ä»ç¶­æŒé»ä¸€ä¸‹é–‹çª—
                }
              },

              // é»æ“Šäº‹ä»¶å¡ç‰‡ï¼šé–‹å•Ÿç·¨è¼¯æ¨¡å¼
              eventClick: function(info) {
                info.jsEvent.preventDefault(); // é˜²æ­¢ç€è¦½å™¨è·³è½‰
                info.jsEvent.stopPropagation(); // é˜²æ­¢è§¸ç™¼ dateClick
                
                const event = info.event;
                const extendedProps = event.extendedProps || {};
                
                // é–‹å•Ÿå½ˆçª—ä¸¦å¡«å…¥è³‡æ–™
                openApptModalForEdit(event);
              },

              // æœˆè¦–åœ–ï¼šä¾æ˜ŸæœŸé¡¯ç¤ºå›ºå®šä¼‘å‡åº•è‰²ï¼ˆé€™æ˜¯ã€Œé è¨­è¦å‰‡ã€çš„è¦–è¦ºæç¤ºï¼Œä¸æ˜¯å¾å¾Œç«¯ä¾†çš„æ’ä¼‘è³‡æ–™ï¼‰
              dayCellDidMount: function (arg) {
                if (arg.view.type !== 'dayGridMonth') return;

                // âœ… åªå°æœ¬æœˆæ—¥æœŸé€²è¡Œè™•ç†ï¼Œæ’é™¤å…¶ä»–æœˆä»½çš„æ—¥æœŸ
                const currentMonth = arg.view.currentStart.getMonth();
                const cellMonth = arg.date.getMonth();
                if (cellMonth !== currentMonth) return;

                const d = arg.date.getDay(); // 0æ—¥ 1ä¸€ 2äºŒ 3ä¸‰ 4å›› 5äº” 6å…­
                if (d === 4) arg.el.classList.add('leave-boss');      // åº—é•·ä¼‘ï¼ˆé¡¯ç¤ºã€Œåº—é•·ä¼‘ã€æ–‡å­—ï¼‰
                if (d === 2) arg.el.classList.add('leave-xiaobai');   // âœ… é€±äºŒå°ç™½ä¼‘
                if (d === 0) arg.el.classList.add('leave-yatting');   // âœ… é€±æ—¥é›…å©·ä¼‘
              },

              selectLongPressDelay: 250, // æ‰‹æ©Ÿé•·æŒ‰ 0.25s è§¸ç™¼ selectï¼šé™ä½ç­‰å¾…ä½†é¿å…èª¤è§¸æ»‘å‹•

              datesSet: function (info) {
                // æ¯æ¬¡ã€Œåˆ‡æ›æ—¥æœŸ/åˆ‡æ›è¦–åœ–ã€éƒ½æœƒè§¸ç™¼ datesSet
                // å¸¸è¦‹ç”¨é€”ï¼šæ›´æ–°è‡ªè¨‚å·¥å…·åˆ—ã€æ›´æ–°é¡¯ç¤ºç‹€æ…‹ã€é‡æ–°ä¸Šè‰²
                updateToolbarTitle(info);
                updateDateScroller(info);
                applyMobileResourceVisibility(info);
                paintMondayClosed(info);
                paintEmployeeLeave();
                // è¼‰å…¥æ–°æ—¥æœŸå¾Œï¼ŒåŒæ­¥æ—¥è¦–åœ–ã€Œç´„æ»¿ã€æŒ‰éˆ•çš„ç´…è‰²ç‹€æ…‹
                syncFullyBookedButtons();
                // âœ… æ—¥è¦–åœ–ï¼šè®“æ¯ä½è¨­è¨ˆå¸«æ¬„ä½éƒ½æœ‰è‡ªå·±çš„æ™‚é–“è»¸ï¼ˆè¦–è¦ºè¼”åŠ©ï¼‰
                schedulePerResourceTimeAxis(80);
                currentYmd = ymd(info.start);
                fetchDailyNote(currentYmd);
              },

              // æ¯å€‹è³‡æºæ¬„ï¼ˆè¨­è¨ˆå¸«æ¬„ä½æ¨™é¡Œï¼‰æ¸²æŸ“å®Œæˆæ™‚
              // - åœ¨æ—¥è¦–åœ–ï¼Œæœƒåœ¨è¨­è¨ˆå¸«åç¨±æ—åŠ ä¸Šã€Œæ’ä¼‘ã€èˆ‡ã€Œç´„æ»¿ã€æŒ‰éˆ•
              resourceLabelDidMount: function (arg) {
                // FullCalendar ç‰ˆæœ¬/è¦–åœ–ä¸åŒæ™‚ï¼Œarg.el å¯èƒ½æ˜¯ã€Œcellã€ä¹Ÿå¯èƒ½å·²ç¶“æ˜¯ã€Œcushionã€æœ¬èº«
                // é€™è£¡åšæˆæ›´ç©©å¥çš„å–å¾—æ–¹å¼ï¼Œé¿å…æŠ“ä¸åˆ°è€Œå°è‡´æŒ‰éˆ•æ•´çµ„ä¸è¦‹ã€‚
                const viewType = arg.view?.type || calendar?.view?.type;
                const cushionEl =
                  (arg.el && arg.el.classList && arg.el.classList.contains('fc-col-header-cell-cushion'))
                    ? arg.el
                    : (arg.el?.querySelector ? arg.el.querySelector('.fc-col-header-cell-cushion') : null);
                const hostEl = cushionEl || arg.el;
                if (!hostEl) return;
                // ç¢ºä¿çµ•å°å®šä½çš„æŒ‰éˆ•ç¾¤ï¼ˆ.header-button-groupï¼‰æœ‰å®šä½åƒè€ƒï¼Œä¸æœƒè·‘åˆ°å¥‡æ€ªçš„ä½ç½®
                hostEl.style.position = 'relative';
                hostEl.style.overflow = 'visible';

                // æ‰‹æ©Ÿç‰ˆæœƒç”¨åˆ°ï¼šè®“è¨­è¨ˆå¸«åç¨±é å³ï¼Œé¿å…èˆ‡å³å´æŒ‰éˆ•é‡ç–Š
                hostEl.classList.add('resource-cushion');

                // åŒä¸€æ ¼å¯èƒ½æœƒè¢«é‡ç¹ªï¼ˆé‡æ–° mountï¼‰ï¼Œå…ˆæ¸…æ‰èˆŠçš„é¿å…ç–ŠåŠ 
                hostEl.querySelectorAll?.('.header-button-group').forEach(n => n.remove());

                // åƒ…åœ¨ã€Œæ—¥è¦–åœ–ã€é¡¯ç¤ºæ’ä¼‘/ç´„æ»¿æŒ‰éˆ•ï¼›é€±è¦–åœ–èˆ‡å…¶ä»–è¦–åœ–ä¸å»ºç«‹æŒ‰éˆ•
                const isDayView = viewType === 'resourceTimeGridDay';
                if (!isDayView) return;

                // è¡¨é ­èƒŒæ™¯ï¼šè·Ÿå„è‡ªçš„ã€Œè¨­è¨ˆå¸«æ¬„ä½å¡ç‰‡ã€åº•è‰²ä¸€è‡´ï¼ˆå°æ‡‰ styles.css çš„ --resource-col-*-bgï¼‰
                const rid = String(arg?.resource?.id ?? '');
                const headerBgByRid = {
                  '1': 'var(--resource-col-1-bg)',
                  '2': 'var(--resource-col-2-bg)',
                  '3': 'var(--resource-col-3-bg)'
                };
                const headerBg = headerBgByRid[rid];
                if (headerBg) {
                  hostEl.dataset.resourceId = rid;
                  if (arg.el && arg.el !== hostEl) arg.el.dataset.resourceId = rid;
                }

                // ğŸ“… æ’ä¼‘ï¼šé–‹å•Ÿæ’ä¼‘å½ˆçª—ï¼ˆå„²å­˜æ™‚ action=saveLeaveï¼‰
                const btnGroup = document.createElement('div');
                btnGroup.className = 'header-button-group';

                const leaveIconButton = document.createElement('button');
                leaveIconButton.type = 'button';
                leaveIconButton.className = 'leave-icon-button';
                leaveIconButton.setAttribute('aria-label', 'æ’ä¼‘');
                leaveIconButton.textContent = 'æ’ä¼‘';
                btnGroup.appendChild(leaveIconButton);
                // ç”¨ clickï¼ˆæ¯” mousedown æ›´é€šç”¨ï¼Œæ‰‹æ©Ÿ/å¹³æ¿ä¹Ÿç©©ï¼‰
                leaveIconButton.addEventListener('click', function (event) {
                  event.preventDefault();
                  event.stopPropagation();
                  setTimeout(() => { openLeaveModal(calendar.view.currentStart, arg.resource); }, 0);
                });

                // âœ… ç´„æ»¿ï¼ˆåˆ‡æ›ï¼‰ï¼šå…¶å¯¦ä¹Ÿæ˜¯å­˜åˆ° leave è³‡æ–™ï¼Œåªæ˜¯ reason å›ºå®šç”¨ã€Œå·²ç´„æ»¿ã€
                // - ç›®çš„ï¼šé¡¯ç¤ºã€Œé€™ä½è¨­è¨ˆå¸«é€™å¤©ä¸å†æ¥æ–°å®¢ã€çš„ç‹€æ…‹
                const dStr = ymd(calendar.view.currentStart);
                const isFB = Array.isArray(employeeLeaveData) &&
                  employeeLeaveData.some(l => l.date === dStr && l.resourceId === arg.resource.id && l.reason === 'å·²ç´„æ»¿');

                const fbBtn = document.createElement('button');
                fbBtn.type = 'button';
                fbBtn.className = 'fully-booked-button' + (isFB ? ' fb-active' : '');
                fbBtn.dataset.resourceId = String(arg.resource.id);
                fbBtn.setAttribute('aria-label', 'ç´„æ»¿');
                fbBtn.textContent = isFB ? 'å·²ç´„æ»¿' : 'ç´„æ»¿';
                btnGroup.appendChild(fbBtn);
                hostEl.appendChild(btnGroup);

                fbBtn.addEventListener('click', async (e) => {
                  e.stopPropagation();
                  const date = ymd(calendar.view.currentStart);
                  const resourceId = arg.resource.id;
                  try {
                    if (fbBtn.classList.contains('fb-active')) {
                      // å–æ¶ˆç´„æ»¿
                      const res = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                        method: 'POST', mode: 'cors',
                        body: JSON.stringify({ action: 'deleteLeave', resourceId, date })
                      });
                      const j = await res.json(); if (j.status !== 'success') throw new Error(j.message);
                      // æ›´æ–°å¿«å–
                      if (Array.isArray(employeeLeaveData)) {
                        const i = employeeLeaveData.findIndex(l => l.date === date && l.resourceId === resourceId && l.reason === 'å·²ç´„æ»¿');
                        if (i !== -1) employeeLeaveData.splice(i, 1);
                      }
                      fbBtn.classList.remove('fb-active'); fbBtn.textContent = 'ç´„æ»¿';
                    } else {
                      // è¨­ç‚ºç´„æ»¿
                      const res = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                        method: 'POST', mode: 'cors',
                        body: JSON.stringify({ action: 'saveLeave', resourceId, date, reason: 'å·²ç´„æ»¿' })
                      });
                      const j = await res.json(); if (j.status !== 'success') throw new Error(j.message);
                      if (Array.isArray(employeeLeaveData)) {
                        employeeLeaveData.push({ date, resourceId, reason: 'å·²ç´„æ»¿' });
                      }
                      fbBtn.classList.add('fb-active'); fbBtn.textContent = 'å·²ç´„æ»¿';
                    }
                    // ç«‹å³é‡ç¹ªæ¬„ä½æ¨£å¼ï¼ˆç•«å¤–æ¡†/è¦†è“‹å±¤ï¼‰
                    paintEmployeeLeave();
                    // ä¸¦åŒæ­¥æ›´æ–°æ—¥è¦–åœ–æŒ‰éˆ•ç´…è‰²ç‹€æ…‹
                    syncFullyBookedButtons();
                  } catch (err) {
                    alert('åˆ‡æ›ç´„æ»¿å¤±æ•—ï¼š' + err.message);
                  }
                });
              },


              // é»æ“Šã€Œäº‹ä»¶æœ¬èº«ã€â†’ ç·¨è¼¯
              eventClick: function (info) { openApptModalForEdit(info.event); },
              // é•·æŒ‰/æ‹–æ›³é¸å–ä¸€æ®µæ™‚é–“ï¼ˆselectable: trueï¼‰â†’ æ–°å¢
              select: function (info) { openApptModalForCreate(info.start, info.resource); },

              eventContent: function (arg) {
                // è‡ªè¨‚äº‹ä»¶é¡¯ç¤ºå…§å®¹ï¼ˆæŠŠæœå‹™ã€å§“åã€é›»è©±æ’æˆä¸€è¡Œï¼‰
                // - `arg.event.extendedProps` æ˜¯å¾Œç«¯å›ä¾†çš„è‡ªè¨‚æ¬„ä½ï¼ˆä¸æ˜¯ FullCalendar å…§å»ºæ¬„ä½ï¼‰
                const ep = arg.event.extendedProps || {};
                const svcMap = {
                  'å‰ªé«®': ['å‰ª'],
                  'å‰ª+æŸ“': ['å‰ª', 'æŸ“'],
                  'å‰ª+ç‡™': ['å‰ª', 'ç‡™'],
                  'å‰ª+æŸ“+ç‡™': ['å‰ª', 'æŸ“', 'ç‡™'],
                  'å‰ª+é ­çš®è­·ç†': ['å‰ª', 'è­·']
                };
                // ä¸ç´„æ™‚æ®µï¼šé¡¯ç¤ºæˆå–®ç´”çš„å°é–æ¨£å¼ï¼ˆä¸é¡¯ç¤ºå§“åé›»è©±ï¼‰
                if (ep.appointment_type === 'blocked') {
                  return {
                    html: `<div class="fc-event-title evt-line evt-blocked"><span class="blocked-icon material-symbols-outlined" aria-hidden="true">pan_tool</span><span class="evt-col-note">${ep.notes ? ep.notes : ''}</span></div>`
                  };
                }
                const svcList = svcMap[ep.service_id] || ['é '];
                const svcClassMap = {
                  'å‰ª': 'svc-cut',
                  'æŸ“': 'svc-dye',
                  'ç‡™': 'svc-perm',
                  'è­·': 'svc-treat',
                  'é ': 'svc-default'
                };
                const safeTrim = (v) => {
                  if (v == null) return '';
                  if (typeof v === 'string') return v.trim();
                  if (typeof v === 'number') return String(v).trim();
                  return '';
                };
                const name = safeTrim(ep.customer_name) || safeTrim(ep.notes);
                const phone = safeTrim(ep.customer_phone);
                const paidAmount = Number(ep.amount);
                const isPaid = ep.appointment_type !== 'blocked' && !Number.isNaN(paidAmount) && paidAmount > 0;
                const currencyFormatter = new Intl.NumberFormat('zh-TW');
                const amountLabel = isPaid ? `$${currencyFormatter.format(paidAmount)}` : '';

                // âœ… æœå‹™å‹³ç« ï¼šä¸ç®¡å¹¾å€‹é …ç›®éƒ½åªé¡¯ç¤ºã€Œä¸€å€‹ã€å‹³ç« 
                // - æ–‡å­—ï¼šæŠŠé …ç›®ç¸®å¯«ä¸²èµ·ä¾†ï¼ˆä¾‹å¦‚ï¼šå‰ªæŸ“ã€å‰ªæŸ“ç‡™ã€å‰ªè­·ï¼‰
                // - æ¨£å¼ classï¼šç”¨ç¬¬ä¸€å€‹é …ç›®æ±ºå®šï¼ˆä¾‹å¦‚ï¼šå‰ªæŸ“ â†’ èµ° svc-cut çš„é‚Šæ¡†è‰²ï¼‰
                const badgeText = svcList.join('');
                const badgeKey = (svcList && svcList[0]) ? svcList[0] : 'é ';
                const badgeCls = svcClassMap[badgeKey] || 'svc-default';
                const servicesHtml = `<span class="evt-svc ${badgeCls}">${badgeText}</span>`;
                return {
                  html: `<div class="fc-event-title evt-line"><span class="evt-col-svc"><span class="evt-services">${servicesHtml}</span></span><span class="evt-col-name">${name}</span><span class="evt-col-phone">${isPaid ? amountLabel : phone}</span></div>`
                };
              },

              eventClassNames: function (arg) {
                // ä¾ç…§ã€Œæ˜¯å“ªä½è¨­è¨ˆå¸« / æ˜¯å¦ä¸ç´„ / æ˜¯å¦å·²æ”¶æ¬¾ã€æ±ºå®šäº‹ä»¶ CSS class
                const r = arg.event.getResources();
                const cls = (r && r[0]) ? ['sty-' + r[0].id] : [];
                const ep = arg.event.extendedProps || {};
                if (ep.appointment_type === 'blocked') {
                  cls.push('blocked-time');
                }
                const paidAmount = Number(ep.amount);
                if (ep.appointment_type !== 'blocked' && !Number.isNaN(paidAmount) && paidAmount > 0) {
                  cls.push('is-paid');
                }
                return cls;
              },
            });
            calendar.render();
          }

          /**
             * æŠŠã€Œæ’ä¼‘/ç´„æ»¿ã€è³‡æ–™æ•´åŒ…æŠ“å›ä¾†ï¼Œä¸¦ç•«åˆ°æ—¥æ›†ä¸Š
             * - action=getLeave
             * - æˆåŠŸå¾Œæœƒå‘¼å« paintEmployeeLeave()ï¼ˆæŠŠ overlay ç•«åˆ°æ ¼å­ä¸Šï¼‰
             */
          async function fetchAllCloudData() {
            try {
              const leaveRes = await fetch(APPS_SCRIPT_WEB_APP_URL + '?action=getLeave');
              if (!leaveRes.ok) throw new Error('ç„¡æ³•å¾å¾Œç«¯ç²å–æ’ä¼‘è³‡æ–™');
              employeeLeaveData = await leaveRes.json();
              paintEmployeeLeave();
              // é¦–æ¬¡è³‡æ–™è¼‰å…¥å¾Œï¼ŒåŒæ­¥æŒ‰éˆ•ç‹€æ…‹ï¼ˆé¿å…åˆæ¬¡æ¸²æŸ“æ™‚æŒ‰éˆ•é‚„æ²’è®Šç´…ï¼‰
              syncFullyBookedButtons();
            } catch (error) {
              console.error('è®€å–é›²ç«¯è³‡æ–™å¤±æ•—:', error);
              alert('è®€å–é›²ç«¯è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–å¾Œç«¯è¨­å®šã€‚');
            }
          }

          /**
             * åŒæ­¥æ—¥è¦–åœ–ã€Œç´„æ»¿ã€æŒ‰éˆ•ç´…è‰²ç‹€æ…‹
             * - å› ç‚ºæŒ‰éˆ•æ˜¯åœ¨ resourceLabelDidMount å‹•æ…‹å»ºç«‹çš„
             * - ç•¶è³‡æ–™ï¼ˆemployeeLeaveDataï¼‰æ›´æ–°æ™‚ï¼Œéœ€è¦æŠŠæŒ‰éˆ• UI è·Ÿè³‡æ–™å°é½Š
             */
          function syncFullyBookedButtons() {
            try {
              if (!calendar || !employeeLeaveData || !Array.isArray(employeeLeaveData)) return;
              if (calendar.view?.type !== 'resourceTimeGridDay') return; // åªåœ¨æ—¥è¦–åœ–éœ€è¦æŒ‰éˆ•
              const dStr = ymd(calendar.view.currentStart);
              document.querySelectorAll('#calendar .fully-booked-button[data-resource-id]').forEach(btn => {
                const rid = btn.dataset.resourceId;
                const isFB = employeeLeaveData.some(l => l.date === dStr && String(l.resourceId) === String(rid) && l.reason === 'å·²ç´„æ»¿');
                if (isFB) {
                  btn.classList.add('fb-active');
                  btn.textContent = 'å·²ç´„æ»¿';
                } else {
                  btn.classList.remove('fb-active');
                  btn.textContent = 'ç´„æ»¿';
                }
              });
            } catch (e) {
              console.warn('syncFullyBookedButtons failed:', e);
            }
          }

          function ensureToastContainer() {
            let el = document.getElementById('toast-container');
            if (!el) {
              el = document.createElement('div');
              el.id = 'toast-container';
              el.setAttribute('aria-live', 'polite');
              document.body.appendChild(el);
            }
            return el;
          }

          function showToast(message, type = 'info', duration = 2000) {
            const container = ensureToastContainer();
            const toast = document.createElement('div');
            toast.className = `toast toast--${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('is-visible'));
            window.setTimeout(() => {
              toast.classList.remove('is-visible');
              toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, duration);
          }

          /**
           * å„²å­˜æˆåŠŸå¾Œï¼šåœ¨å‰ç«¯ç«‹å³æ›´æ–°äº‹ä»¶ï¼Œé¿å…æ¯æ¬¡éƒ½ refetch
           * - ç›®çš„ï¼šçµå¸³/å„²å­˜å¾Œã€Œå¡ç‰‡è®Šè‰²ã€èƒ½æ›´å¿«çœ‹åˆ°
           */
          function applyOptimisticEventUpdate(payload) {
            if (!calendar || !payload || !payload.id) return false;
            const ev = calendar.getEventById(String(payload.id));
            if (!ev) return false;

            // è‹¥æ™‚é–“æœ‰è®Šå‹•ï¼Œä¿ç•™åŸæœ¬æ™‚é•·
            if (payload.start) {
              const nextStart = new Date(payload.start);
              if (!Number.isNaN(nextStart.getTime())) {
                const durationMs = (ev.end && ev.start) ? (ev.end.getTime() - ev.start.getTime()) : null;
                ev.setStart(nextStart);
                if (durationMs != null && durationMs > 0) {
                  ev.setEnd(new Date(nextStart.getTime() + durationMs));
                }
              }
            }

            // è®Šæ›´è³‡æºæ¬„ä½ï¼ˆè‹¥æ”¯æ´ï¼‰
            if (payload.employee_id) {
              const nextRes = calendar.getResourceById?.(String(payload.employee_id));
              if (nextRes && typeof ev.setResources === 'function') ev.setResources([nextRes]);
              else if (typeof ev.setResourceId === 'function') ev.setResourceId(String(payload.employee_id));
            }

            // æ›´æ–°é¡¯ç¤ºæœƒç”¨åˆ°çš„æ¬„ä½
            ev.setExtendedProp('appointment_type', payload.appointment_type);
            ev.setExtendedProp('customer_name', payload.customer_name);
            ev.setExtendedProp('customer_phone', payload.customer_phone);
            ev.setExtendedProp('service_id', payload.service_id);
            ev.setExtendedProp('assistant_id', payload.assistant_id);
            ev.setExtendedProp('amount', payload.amount);
            ev.setExtendedProp('notes', payload.notes);
            return true;
          }

          function getSlotDurationMinutes() {
            const dur = calendar?.getOption?.('slotDuration');
            if (!dur) return 15;
            if (typeof dur === 'string') {
              const parts = dur.split(':').map(Number);
              if (parts.length >= 2 && parts.every(n => !Number.isNaN(n))) {
                return (parts[0] * 60) + parts[1] + Math.floor((parts[2] || 0) / 60);
              }
            }
            if (typeof dur === 'object') {
              const mins = Number(dur.minutes || 0) + Number(dur.hours || 0) * 60;
              if (!Number.isNaN(mins) && mins > 0) return mins;
            }
            return 15;
          }

          function addEventOptimistically(payload, createdId) {
            if (!calendar || !payload || !createdId || !payload.start) return false;
            const startDate = new Date(payload.start);
            if (Number.isNaN(startDate.getTime())) return false;
            const endDate = new Date(startDate.getTime() + getSlotDurationMinutes() * 60000);
            const titleText = payload.appointment_type === 'blocked'
              ? (payload.notes || 'ä¸ç´„æ™‚æ®µ')
              : (payload.customer_name || 'æœªå‘½å') + (payload.service_id ? ' - ' + payload.service_id : '');
            const ev = calendar.addEvent({
              id: String(createdId),
              resourceId: String(payload.employee_id || ''),
              start: startDate,
              end: endDate,
              title: titleText,
              extendedProps: {
                customer_name: payload.customer_name,
                customer_phone: payload.customer_phone,
                service_id: payload.service_id,
                notes: payload.notes,
                appointment_type: payload.appointment_type,
                amount: payload.amount,
                assistant_id: payload.assistant_id
              }
            });
            return !!ev;
          }

          function removeEventOptimistically(eventId) {
            if (!calendar || !eventId) return false;
            const ev = calendar.getEventById(String(eventId));
            if (!ev) return false;
            ev.remove();
            return true;
          }

          /**
             * ç¶å®šé é¢ä¸Šæ‰€æœ‰ã€Œäº’å‹•äº‹ä»¶ã€
             * - inputï¼šé›»è©±è‡ªå‹•æ ¼å¼åŒ–ã€ç•™è¨€è¼¸å…¥ç‹€æ…‹
             * - clickï¼šå„²å­˜ç•™è¨€ã€é—œé–‰å½ˆçª—ã€åˆªé™¤/å„²å­˜é ç´„ã€åˆªé™¤/å„²å­˜æ’ä¼‘
             * - changeï¼šé ç´„é¡å‹åˆ‡æ›ï¼ˆä¸€èˆ¬é ç´„ vs ä¸ç´„æ™‚æ®µï¼‰
             */
          function bindEventListeners() {
            // console.log('Binding listeners...');
            // é›»è©±è¼¸å…¥ï¼šåªå…è¨±æ•¸å­—ä¸¦åŠ ä¸Šç°¡å–®æ ¼å¼ï¼ˆ09xx-xxx-xxxï¼‰
            phoneEl.addEventListener('input', (e) => {
              let d = e.target.value.replace(/\D/g, '').slice(0, 10);
              if (d.length >= 7) e.target.value = d.replace(/^(\d{4})(\d{3})(\d{0,3}).*$/, function (_, a, b, c) { return c ? `${a}-${b}-${c}` : `${a}-${b}` });
              else if (d.length >= 5) e.target.value = d.replace(/^(\d{4})(\d{0,3}).*$/, '$1-$2');
              else e.target.value = d;
            });

            let notesSaveTimeout;
            // ç•™è¨€å…§å®¹è®Šå‹•ï¼šæ¨™è¨˜æˆã€Œæœªå„²å­˜ã€
            notesTextarea.addEventListener('input', function () {
              document.querySelector('.notes-meta span').textContent = 'æœªå„²å­˜';
            });

            // æ‰‹å‹•å„²å­˜ç•™è¨€ï¼ˆå¯«å…¥é›²ç«¯ï¼‰
            document.getElementById('save-notes-btn').addEventListener('click', async function () {
              const meta = document.querySelector('.notes-meta span');
              meta.textContent = 'å„²å­˜ä¸­...';
              try {
                const payload = {
                  action: 'saveNotes',
                  date: currentYmd || ymd(new Date()),
                  content: notesTextarea.value
                };
                const r = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                  method: 'POST',
                  mode: 'cors',
                  body: JSON.stringify(payload)
                });
                const j = await r.json();
                if (j.status !== 'success') {
                  throw new Error(j.message || 'å¯«å…¥å¤±æ•—');
                }
                meta.textContent = 'å·²å„²å­˜ âœ“';
              } catch (e) {
                meta.textContent = 'å„²å­˜å¤±æ•— âŒ';
              }
            });


            // æ’ä¼‘è¡¨å–®é€å‡ºï¼šå„²å­˜æ’ä¼‘åŸå› 
            leaveForm.addEventListener('submit', async function (e) {
              e.preventDefault();
              const payload = {
                action: 'saveLeave',
                resourceId: document.getElementById('leaveResourceId').value,
                date: document.getElementById('leaveDate').value,
                reason: document.getElementById('leaveReason').value.trim() || 'æ’ä¼‘'
              };
              try {
                const res = await fetch(APPS_SCRIPT_WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'cors' });
                const result = await res.json();
                if (result.status !== 'success') throw new Error(result.message);
                calendar.refetchEvents(); // âœ… é€šçŸ¥ FullCalendar é‡æ–°å–å¾—æ‰€æœ‰äº‹ä»¶
                leaveModal.style.display = 'none';

              } catch (error) {
                alert('å„²å­˜æ’ä¼‘å¤±æ•—: ' + error.message);
              }
            });

            // å–æ¶ˆæ’ä¼‘ï¼šåˆªé™¤è©²æ—¥è©²è¨­è¨ˆå¸«çš„æ’ä¼‘è³‡æ–™
            deleteLeaveBtn.addEventListener('click', async function () {
              if (!confirm('ç¢ºå®šè¦å–æ¶ˆé€™ç­†æ’ä¼‘å—ï¼Ÿ')) return;
              const payload = {
                action: 'deleteLeave',
                resourceId: document.getElementById('leaveResourceId').value,
                date: document.getElementById('leaveDate').value
              };
              try {
                const res = await fetch(APPS_SCRIPT_WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'cors' });
                const result = await res.json();
                if (result.status !== 'success') throw new Error(result.message);
                calendar.refetchEvents(); // âœ… é€šçŸ¥ FullCalendar é‡æ–°å–å¾—æ‰€æœ‰äº‹ä»¶
                leaveModal.style.display = 'none';

              } catch (error) {
                alert('åˆªé™¤æ’ä¼‘å¤±æ•—: ' + error.message);
              }
            });

            /* å–æ¶ˆè¦†è“‹å±¤é»æ“Šé–‹çª—çš„äº‹ä»¶å§”æ´¾ï¼ˆåƒ…ä¿ç•™è¡¨é ­ã€Œæ’ä¼‘ã€æŒ‰éˆ•å¯ç”¨ï¼‰ */

            // é ç´„è¡¨å–®é€å‡ºï¼šæ–°å¢ or æ›´æ–°ï¼ˆç”± event_id æ˜¯å¦å­˜åœ¨åˆ¤æ–·ï¼‰
            form.addEventListener('submit', async function (e) {
              e.preventDefault();
              const isEditing = !!eventIdInput.value;
              const fd = new FormData(form);
              const amountRaw = fd.get('amount_input');
              const parsedAmount = amountRaw === null || amountRaw === '' ? NaN : parseInt(amountRaw, 10);
              const amountValue = Number.isFinite(parsedAmount) ? String(Math.max(0, parsedAmount)) : '';
              const payload = {
                action: isEditing ? 'edit' : 'create',
                id: fd.get('event_id') || undefined,
                employee_id: fd.get('employee_id'),
                start: fd.get('start_time'),
                appointment_type: fd.get('appointment_type'),
                customer_name: fd.get('customer_name') || '',
                customer_phone: (fd.get('customer_phone') || '').replace(/\D/g, ''),
                service_id: fd.get('service_id') || '',
                assistant_id: fd.get('assistant_select') || '',
                amount: amountValue,
                notes: fd.get('notes') || ''
              };
              submitBtn.disabled = true;
              appointmentModal.style.display = 'none';
              showToast('å„²å­˜ä¸­...', 'loading', 3000);
              let optimisticApplied = false;
              let optimisticCreated = false;
              let saveOk = false;
              try {
                const res = await fetch(APPS_SCRIPT_WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'cors' });
                const data = await res.json();
                if (!res.ok || data.status !== 'success') throw new Error(data.message || 'å„²å­˜å¤±æ•—');
                if (isEditing) {
                  optimisticApplied = applyOptimisticEventUpdate(payload);
                } else if (data && data.id) {
                  optimisticCreated = addEventOptimistically(payload, data.id);
                }
                saveOk = true;
              } catch (err) {
                alert('âŒ å„²å­˜å¤±æ•—ï¼š' + err.message);
              } finally {
                submitBtn.disabled = false;
                if (isEditing && optimisticApplied) {
                  calendar.rerenderEvents();
                } else if (!isEditing && optimisticCreated) {
                  calendar.rerenderEvents();
                } else {
                  calendar.refetchEvents();
                }
                if (saveOk) showToast('å·²å„²å­˜', 'success', 2000);
                else showToast('å„²å­˜å¤±æ•—', 'error', 3000);
              }
            });

            // åˆªé™¤é ç´„ï¼šéœ€è¦ event_id æ‰èƒ½åˆªé™¤
            deleteBtn.onclick = async function () {
              const eventId = eventIdInput.value.trim();
              if (!eventId || !confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†é ç´„å—ï¼Ÿ')) return;
              let removed = false;
              try {
                const res = await fetch(APPS_SCRIPT_WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id: eventId }), mode: 'cors' });
                const data = await res.json();
                if (!res.ok || data.status !== 'success') throw new Error(data.message || 'åˆªé™¤å¤±æ•—');
                removed = removeEventOptimistically(eventId);
              } catch (err) {
                alert('âŒ åˆªé™¤å¤±æ•—ï¼š' + err.message);
              } finally {
                appointmentModal.style.display = 'none';
                if (!removed) calendar.refetchEvents();
              }
            };




            // Modal Close Events
            if (appointmentCloseButton) appointmentCloseButton.onclick = () => appointmentModal.style.display = 'none';
            if (leaveCloseButton) leaveCloseButton.onclick = () => leaveModal.style.display = 'none';
            if (reportCloseButton) reportCloseButton.onclick = () => reportModal.style.display = 'none';

            window.addEventListener('click', (e) => {
              if (e.target === appointmentModal) appointmentModal.style.display = 'none';
              if (e.target === leaveModal) leaveModal.style.display = 'none';
              if (e.target === reportModal) reportModal.style.display = 'none';
            });

            // è¦–çª—å°ºå¯¸è®Šå‹•ï¼šé‡æ–°è¨ˆç®—æ¯ä½è¨­è¨ˆå¸«æ¬„ä½å…§çš„æ™‚é–“è»¸ä½ç½®ï¼ˆé¿å…å­—ç´š/é«˜åº¦è®Šå‹•å¾Œè·‘ä½ï¼‰
            window.addEventListener('resize', () => {
              schedulePerResourceTimeAxis(150);
              applyMobileResourceVisibility();
            });

            // åˆ‡æ›ã€Œä¸€èˆ¬é ç´„ / ä¸ç´„æ™‚æ®µã€ï¼šæ±ºå®šæ˜¯å¦é¡¯ç¤ºé¡§å®¢è³‡æ–™æ¬„ä½ã€æŒ‰éˆ•æ–‡å­—
            document.querySelectorAll('input[name="appointment_type"]').forEach(radio => {
              radio.addEventListener('change', function () {
                const isBlocked = this.value === 'blocked';
                const isEditing = !!eventIdInput.value;
                document.getElementById('customer-fields-left').style.display = isBlocked ? 'none' : 'block';
                
                // æ±ºå®šæ˜¯å¦é¡¯ç¤ºå³å´å¡ç‰‡ï¼šåƒ…åœ¨ã€Œç·¨è¼¯ã€æ¨¡å¼ä¸”ã€Œéä¸ç´„æ™‚æ®µã€æ™‚é¡¯ç¤º
                const showSettlement = isEditing && !isBlocked;
                document.getElementById('settlement-col').style.display = showSettlement ? 'block' : 'none';
                document.getElementById('notes').placeholder = isBlocked ? 'ä¸ç´„æ™‚æ®µå‚™è¨»...' : 'è«‹è¼¸å…¥å‚™è¨»è³‡è¨Š...';
                
                // æ ¹æ“šæ˜¯å¦é¡¯ç¤ºå³å´å¡ç‰‡èª¿æ•´æ’ç‰ˆ
                const actions = document.querySelector('.modal-actions');
                const content = document.querySelector('.modal-content');
                if (showSettlement) {
                  actions.style.gridColumn = '1 / -1';
                  content.style.maxWidth = '900px';
                } else {
                  actions.style.gridColumn = '1 / 2';
                  content.style.maxWidth = '450px';
                }
                
                // Blocked: clear certain fields
                if (isBlocked) {
                  assistantSelect.value = '';
                  amountInput.value = '';

                  const permSelect = document.getElementById('perm_select');
                  if (permSelect) permSelect.value = '';

                  const retailItem = document.getElementById('retail_item');
                  const retailPrice = document.getElementById('retail_price');
                  if (retailItem) retailItem.value = '';
                  if (retailPrice) retailPrice.value = '';

                  const bleach4000CostWrap = document.getElementById('bleach4000-cost-wrap');
                  const bleach4000CostInput = document.getElementById('bleach4000_cost');
                  if (bleach4000CostWrap) bleach4000CostWrap.style.display = 'none';
                  if (bleach4000CostInput) bleach4000CostInput.value = '270';

                  // uncheck prices
		                  document.querySelectorAll('input[name="cut_price"][value="0"]').forEach(r => r.checked = true);
		                  document.querySelectorAll('input[name="other_item"]').forEach(c => c.checked = false);
		                  updateCalculatedTotal();
                }
                
                if (isBlocked) {
                  submitBtn.textContent = 'è¨­å®šä¸ç´„æ™‚æ®µ';
                } else {
                  submitBtn.textContent = isEditing ? 'æ›´æ–°é ç´„' : 'å„²å­˜é ç´„';
                }
              });
            });

            // ç¶å®šåƒ¹æ ¼è¨ˆç®—äº‹ä»¶
			            const priceInputs = document.querySelectorAll('input[name="cut_price"], input[name="other_item"], #perm_select, #retail_price, #bleach4000_cost');
		            priceInputs.forEach(input => {
		                input.addEventListener('change', updateCalculatedTotal);
		                if (input.id === 'retail_price') input.addEventListener('input', updateCalculatedTotal); // Immediate update for text input
		            });

		            // æ¼‚4000ï¼šå‹¾é¸æ™‚é¡¯ç¤ºææ–™è²»è¼¸å…¥æ¡†ï¼ˆå¯è‡ªå¡«æˆæœ¬ï¼‰
		            const bleach4000Checkbox = document.querySelector('input[name="other_item"][value="4000"]');
			            const bleach4000CostWrap = document.getElementById('bleach4000-cost-wrap');
			            const bleach4000CostInput = document.getElementById('bleach4000_cost');
			            const syncBleach4000CostUI = () => {
			              const checked = !!bleach4000Checkbox?.checked;
			              // ç”¨ grid æ‰èƒ½è®“ã€Œlabel + inputã€åŒåˆ—ä¸¦æ’ï¼ˆæœƒè¦†è“‹ CSS çš„ display:gridï¼‰
			              if (bleach4000CostWrap) bleach4000CostWrap.style.display = checked ? 'grid' : 'none';
			              if (checked && bleach4000CostInput && !bleach4000CostInput.value) bleach4000CostInput.value = '270';
			              if (!checked && bleach4000CostInput) bleach4000CostInput.value = '270';
			            };
		            bleach4000Checkbox?.addEventListener('change', () => {
		              syncBleach4000CostUI();
		              updateCalculatedTotal();
		            });
		            bleach4000CostInput?.addEventListener('input', updateCalculatedTotal);
		            syncBleach4000CostUI();

	            // æ”¹å›æœªçµå¸³ï¼šæ¸…ç©ºé‡‘é¡ä¸¦ç«‹å³å„²å­˜
	            if (unsetPaidBtn) {
	              unsetPaidBtn.addEventListener('click', function () {
	                if (!eventIdInput.value) return;
	                const apptType = document.querySelector('input[name="appointment_type"]:checked')?.value;
	                if (apptType === 'blocked') return;
	                if (!confirm('è¦æŠŠé€™ç­†æ”¹å›æœªçµå¸³å—ï¼Ÿ\\n\\næœƒæ¸…ç©ºå…¥å¸³é‡‘é¡èˆ‡åŠ©ç†ï¼Œä¸¦ç«‹åˆ»å„²å­˜ã€‚')) return;

		                // Reset settlement UI
			                document.querySelectorAll('input[name="cut_price"][value="0"]').forEach(r => r.checked = true);
			                document.querySelectorAll('input[name="other_item"]').forEach(c => c.checked = false);
			                const permSelect = document.getElementById('perm_select');
			                if (permSelect) permSelect.value = '';
			                const bleach4000CostWrap = document.getElementById('bleach4000-cost-wrap');
			                const bleach4000CostInput = document.getElementById('bleach4000_cost');
			                if (bleach4000CostWrap) bleach4000CostWrap.style.display = 'none';
			                if (bleach4000CostInput) bleach4000CostInput.value = '270';
			                const retailItem = document.getElementById('retail_item');
			                const retailPrice = document.getElementById('retail_price');
			                if (retailItem) retailItem.value = '';
			                if (retailPrice) retailPrice.value = '';
	                if (assistantSelect) assistantSelect.value = '';
	                if (amountInput) amountInput.value = '';
	                updateCalculatedTotal();

	                if (typeof form?.requestSubmit === 'function') form.requestSubmit(submitBtn);
	                else submitBtn.click();
	              });
	            }
	          }

          /**
           * è¨ˆç®—ç¸½é‡‘é¡èˆ‡å…¥å¸³é‡‘é¡
           * è¦å‰‡ï¼š
           * - ç¸½é‡‘é¡ (Display Total): å„é …å–®åƒ¹åŠ ç¸½
           * - å…¥å¸³é‡‘é¡ (Net Amount): (å–®åƒ¹ - æˆæœ¬) åŠ ç¸½ â†’ é€™æ˜¯è¦å­˜é€² DB çš„ amount
           */
          function updateCalculatedTotal() {
              let cutPrice = 0;
              let chemTotal = 0;
              let totalCost = 0;

              // 1. å‰ªé«® (Radio)
              const cut = document.querySelector('input[name="cut_price"]:checked');
              if (cut) {
                  cutPrice = parseInt(cut.value, 10) || 0;
                  totalCost += parseInt(cut.dataset.cost || 0, 10);
              }

		              // 2. å…¶ä»–é …ç›® (Checkbox: æ´—é«®, æŸ“é«®, æ¼‚é«®...)
		              document.querySelectorAll('input[name="other_item"]:checked').forEach(item => {
		                  const p = parseInt(item.value, 10) || 0;
		                  let c = parseInt(item.dataset.cost || 0, 10) || 0;
		                  // æ¼‚4000ï¼šææ–™è²»å¯è‡ªå¡«ï¼ˆæœªå¡«å‰‡ç”¨é è¨­ 270ï¼‰
		                  if (String(item.value) === '4000') {
		                      const bleach4000CostInput = document.getElementById('bleach4000_cost');
		                      const customCost = bleach4000CostInput ? (parseInt(bleach4000CostInput.value, 10) || 0) : 0;
		                      c = customCost > 0 ? customCost : c;
		                  }
		                  chemTotal += p;
		                  totalCost += c;
		              });

	              // 3. ç‡™é«® (Select, å–®é¸ + ææ–™è²»)
	              const permSelect = document.getElementById('perm_select');
	              let permPrice = 0;
	              if (permSelect) {
	                  permPrice = parseInt(permSelect.value, 10) || 0;
	                  const opt = permSelect.selectedOptions && permSelect.selectedOptions[0] ? permSelect.selectedOptions[0] : null;
	                  const permCost = opt ? (parseInt(opt.dataset.cost || 0, 10) || 0) : 0;
	                  totalCost += permCost;
	              }

	              // 4. åº—è²© (Retail)
	              const retailInput = document.getElementById('retail_price');
	              let retailVal = 0;
	              if (retailInput) {
	                  retailVal = parseInt(retailInput.value, 10) || 0;
	              }

	              // è¨ˆç®—
	              const displayTotal = cutPrice + chemTotal + permPrice + retailVal;
              // å…¥å¸³é‡‘é¡ = ç¸½é‡‘é¡ - æˆæœ¬
              const netAmount = displayTotal - totalCost;

              // æ›´æ–° UI
              document.getElementById('display-total').textContent = '$' + displayTotal;
              document.getElementById('display-net').textContent = '$' + netAmount;
              
	              // æ›´æ–° hidden input
	              const finalAmount = netAmount > 0 ? netAmount : '';
	              document.getElementById('amount_input').value = finalAmount;
	              syncUnsettleButton();
	          }

	          function syncUnsettleButton() {
	              if (!unsetPaidBtn || !amountInput || !eventIdInput) return;
	              const isEditing = !!eventIdInput.value;
	              const apptType = document.querySelector('input[name="appointment_type"]:checked')?.value;
	              const isBlocked = apptType === 'blocked';
	              const amt = Number(amountInput.value);
	              const show = isEditing && !isBlocked && Number.isFinite(amt) && amt > 0;
	              unsetPaidBtn.style.display = show ? 'inline-flex' : 'none';
	          }

          /**
             * æŠŠ employeeLeaveData ç•«åˆ°æ—¥æ›†æ ¼å­ä¸Šï¼ˆè¦–è¦ºè¦†è“‹å±¤/å¤–æ¡†ï¼‰
             *
             * è¦å‰‡ï¼š
             * - reason === 'å·²ç´„æ»¿'ï¼šåªç•«å¤–æ¡†ï¼ˆä¸é®ä½å…§å®¹ï¼‰ï¼Œè¡¨ç¤ºã€Œä¸å†æ¥å—æ–°å¢ã€
             * - å…¶ä»– reasonï¼šç•«åŠé€æ˜è¦†è“‹å±¤ + æ–‡å­—ï¼ˆä¾‹å¦‚ï¼šç‰¹ä¼‘ã€é€²ä¿®ã€åº—ä¼‘ï¼‰
             *
             * æŠ€è¡“åšæ³•ï¼š
             * - FullCalendar æ¯å€‹æ ¼å­ column æœƒæœ‰ `.fc-timegrid-col`
             * - æˆ‘å€‘ç”¨ data-date + data-resource-id æ‰¾åˆ°ç‰¹å®šè¨­è¨ˆå¸«åœ¨ç‰¹å®šæ—¥æœŸçš„æ¬„ä½
             * - ç„¶å¾Œ append ä¸€å€‹è‡ªè¨‚çš„ div é€²å»
             */
          function paintEmployeeLeave() {
            // å…ˆæ¸…æ‰èˆŠå±¤ï¼ˆé¿å…é‡è¤‡ç–ŠåŠ ï¼‰
            document.querySelectorAll('#calendar .leave-overlay').forEach(n => n.remove());
            document.querySelectorAll('#calendar .fully-booked-outline').forEach(n => n.remove());
            if (!Array.isArray(employeeLeaveData)) return;

            employeeLeaveData.forEach(leave => {
              const targetColumn = document.querySelector(
                `#calendar .fc-timegrid-col[data-date="${leave.date}"][data-resource-id="${leave.resourceId}"]`
              );
              if (!targetColumn) return;

              // æ—¥è¦–åœ–æœ‰ .fc-timegrid-col-frame (card-style)ï¼Œæ”¹æ›åœ¨é‚£è£¡æ‰ä¸æœƒè¶…å‡ºé‚Šè·
              const frame = targetColumn.querySelector('.fc-timegrid-col-frame');
              const container = frame || targetColumn;

              if (leave.reason === 'å·²ç´„æ»¿') {
                // åªç•«å¤–æ¡†ï¼Œä¸è¦†è“‹å…§å®¹
                const o = document.createElement('div');
                o.className = 'fully-booked-outline';
                container.appendChild(o);
                return;
              }

              const ov = document.createElement('div');
              ov.className = 'closed-overlay leave-overlay';
              const label = document.createElement('span');
              label.className = 'overlay-label';
              label.textContent = leave.reason;
              ov.appendChild(label);
              ov.dataset.resourceId = leave.resourceId;
              ov.dataset.date = leave.date;
              container.appendChild(ov);
            });
          }



          /**
             * é–‹å•Ÿã€Œæ’ä¼‘å½ˆçª—ã€ä¸¦å¡«å…¥é è¨­å€¼
             *
             * @param {Date} date - ç›®å‰æ—¥æ›†çš„æ—¥æœŸï¼ˆé€šå¸¸æ˜¯ calendar.view.currentStartï¼‰
             * @param {Object} resource - FullCalendar çš„ resourceï¼ˆè¨­è¨ˆå¸«ï¼‰
             */
          function openLeaveModal(date, resource) {
            const ymd = d => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            const dateStr = ymd(date);
            const existingLeave = Array.isArray(employeeLeaveData) ? employeeLeaveData.find(l => l.date === dateStr && l.resourceId === resource.id) : null;
            document.getElementById('leaveResourceId').value = resource.id;
            document.getElementById('leaveDate').value = dateStr;
            document.getElementById('leaveModalResourceName').textContent = resource.title;
            document.getElementById('leaveModalDate').textContent = dateStr;
            document.getElementById('leaveReason').value = existingLeave ? existingLeave.reason : resource.title + 'æ’ä¼‘';
            deleteLeaveBtn.style.display = existingLeave ? 'inline-block' : 'none';
            leaveModal.style.display = 'block';
          }

          /**
             * é–‹å•Ÿã€Œæ–°å¢é ç´„ã€å½ˆçª—
             *
             * @param {Date} startDate - ä½¿ç”¨è€…é»åˆ°/é¸åˆ°çš„é–‹å§‹æ™‚é–“
             * @param {Object} resource - å“ªä½è¨­è¨ˆå¸«ï¼ˆè³‡æºæ¬„ä½ï¼‰
             */
	          function openApptModalForCreate(startDate, resource) {
            // alert('Open Modal: ' + (resource ? resource.title : 'No resource'));
            if (!resource) return;
            // reset() æœƒæŠŠè¡¨å–®æ¬„ä½æ¸…ç©ºæˆé è¨­å€¼
            form.reset();
            eventIdInput.value = '';
            submitBtn.textContent = 'å„²å­˜';
            deleteBtn.style.display = 'none';
            document.querySelector('input[name="appointment_type"][value="normal"]').checked = true;
            document.getElementById('customer-fields-left').style.display = 'block';
	            document.getElementById('settlement-col').style.display = 'none'; // âœ… æ–°å¢æ¨¡å¼ä¸é¡¯ç¤ºç¶ è‰²å¡ç‰‡
	            placeAppointmentActions('create');
	            // èª¿æ•´æŒ‰éˆ•å€åŸŸåªä½”å·¦å´æ¬„ä½å¯¬åº¦
	            document.querySelector('.modal-actions').style.gridColumn = '1 / 2';
	            // èª¿æ•´å½ˆçª—å¯¬åº¦ç‚ºçª„ç‰ˆï¼ˆåªæœ‰å·¦å´å¡ç‰‡ï¼‰
	            if (appointmentContent) appointmentContent.style.maxWidth = '450px';
	            document.getElementById('notes').placeholder = 'è«‹è¼¸å…¥å‚™è¨»è³‡è¨Š.';
	            document.getElementById('employee_id').value = resource.id;
            
            // Check resource for Xiaobai rule (ID: 3)
            const isXiaobai = String(resource.id) === '3';
            document.getElementById('xiaobai-cut-opt').style.display = isXiaobai ? 'flex' : 'none';

            assistantSelect.value = '';
            amountInput.value = '';
            
		            // Reset billing
		            document.querySelectorAll('input[name="cut_price"][value="0"]').forEach(r => r.checked = true);
		            document.querySelectorAll('input[name="other_item"]').forEach(c => c.checked = false);
		            const permSelect = document.getElementById('perm_select');
		            if (permSelect) permSelect.value = '';
		            // Reset Retail
		            document.getElementById('retail_item').value = '';
		            document.getElementById('retail_price').value = '';
		            const bleach4000CostWrap = document.getElementById('bleach4000-cost-wrap');
		            const bleach4000CostInput = document.getElementById('bleach4000_cost');
		            if (bleach4000CostWrap) bleach4000CostWrap.style.display = 'none';
		            if (bleach4000CostInput) bleach4000CostInput.value = '270';
		            
	            updateCalculatedTotal();

            const minuteSelect = document.getElementById('minute_select');
            minuteSelect.innerHTML = '';
            const baseMin = startDate.getMinutes();
            // åªæä¾› 3 å€‹é¸é …ï¼šç¾åœ¨åˆ†é˜ã€+5ã€+10ï¼ˆè®“ä½¿ç”¨è€…å¾®èª¿ï¼Œé¿å…æ‰‹å‹•è¼¸å…¥ï¼‰
            for (let i = 0; i < 3; i++) {
              const currentMinute = baseMin + (i * 5);
              const opt = document.createElement('option');
              opt.value = currentMinute;
              opt.textContent = String(currentMinute).padStart(2, '0');
              if (i === 0) opt.selected = true;
              minuteSelect.appendChild(opt);
            }
            updateHiddenStartTime(startDate);
            minuteSelect.onchange = function () { updateHiddenStartTime(startDate) };
            appointmentModal.style.display = 'block';
          }

          /**
             * é–‹å•Ÿã€Œç·¨è¼¯é ç´„ã€å½ˆçª—
             * - æœƒæŠŠäº‹ä»¶è³‡æ–™ï¼ˆextendedPropsï¼‰å›å¡«åˆ°è¡¨å–®
             *
             * @param {FullCalendar.EventApi} event - FullCalendar çš„äº‹ä»¶ç‰©ä»¶
             */
		          function openApptModalForEdit(event) {
	            form.reset();
	            const ep = event.extendedProps || {};
	            eventIdInput.value = event.id;
	            deleteBtn.style.display = 'inline-block';
	            const rs = event.getResources();
	            document.getElementById('employee_id').value = (rs && rs[0] ? rs[0].id : '');
	            document.getElementById('customer_phone').value = ep.customer_phone || '';
	            document.getElementById('customer_name').value = ep.customer_name || '';
	            const serviceSelect = document.getElementById('service_id');
	            const serviceValue = ep.service_id || '';
	            if (serviceSelect) {
	              if (serviceValue && !Array.from(serviceSelect.options).some(o => o.value === serviceValue)) {
	                const opt = document.createElement('option');
	                opt.value = serviceValue;
	                opt.textContent = serviceValue;
	                serviceSelect.insertBefore(opt, serviceSelect.options[1] || null);
	              }
	              serviceSelect.value = serviceValue;
	            }
	            document.getElementById('notes').value = ep.notes || '';
	            assistantSelect.value = ep.assistant_id || '';
	            amountInput.value = ep.amount !== undefined && ep.amount !== null ? ep.amount : '';
	            const isBlocked = ep.appointment_type === 'blocked';
            document.querySelector(`input[name="appointment_type"][value="${isBlocked ? 'blocked' : 'normal'}"]`).checked = true;
	            document.getElementById('customer-fields-left').style.display = isBlocked ? 'none' : 'block';
	            document.getElementById('settlement-col').style.display = isBlocked ? 'none' : 'block';
	            placeAppointmentActions('edit');
	            // èª¿æ•´æŒ‰éˆ•å€åŸŸï¼šä¸ç´„æ™‚æ®µåªä½”å·¦å´ï¼Œä¸€èˆ¬é ç´„è·¨è¶Šå…©æ¬„
	            document.querySelector('.modal-actions').style.gridColumn = isBlocked ? '1 / 2' : '1 / -1';
	            // èª¿æ•´å½ˆçª—å¯¬åº¦ï¼šä¸ç´„æ™‚æ®µçª„ç‰ˆï¼Œä¸€èˆ¬é ç´„å¯¬ç‰ˆ
	            if (appointmentContent) appointmentContent.style.maxWidth = isBlocked ? '450px' : '900px';
            
            // Check Xiaobai rule
            const isXiaobai = (rs && rs[0] && String(rs[0].id) === '3');
            document.getElementById('xiaobai-cut-opt').style.display = isXiaobai ? 'flex' : 'none';

            // IMPORTANT: We do not have detailed breakdown (Cut vs Dye) stored in DB individually,
            // we only have the total 'amount' (net).
            // So we cannot auto-populate the checkboxes perfectly from history unless we change DB schema.
            // For now, we just reset them or leave them empty, OR imply from amount if possible?
            // User requirement: "Create event -> later click to input amount".
            // So usually the amount should be 0 initially.
            // If editing a settled event, the user might want to see what was selected.
            // But we didn't save "which items were selected" to DB, only the single amount.
            // So: Keep it simple: Reset checkboxes to default (None) and let user re-select if they are "editing settlement".
            // OR checks if amount > 0, maybe show "Previously Settled: $xxx"
	            // For now, reset billing widgets to default to avoid confusion.
	             document.querySelectorAll('input[name="cut_price"][value="0"]').forEach(r => r.checked = true);
	             document.querySelectorAll('input[name="other_item"]').forEach(c => c.checked = false);
	             const permSelect = document.getElementById('perm_select');
	             if (permSelect) permSelect.value = '';
	             const bleach4000CostWrap = document.getElementById('bleach4000-cost-wrap');
	             const bleach4000CostInput = document.getElementById('bleach4000_cost');
	             if (bleach4000CostWrap) bleach4000CostWrap.style.display = 'none';
	             if (bleach4000CostInput) bleach4000CostInput.value = '270';
	             updateCalculatedTotal();
             
             // If there IS an amount, we fill the hidden and maybe show it?
             // But re-selecting items will overwrite it. This is tricky without changing DB.
             // Workaround: We will respect the fetched 'ep.amount' and put it in hidden.
             // The UI widgets will show $0. If user touches widgets, amount updates.
	             if (ep.amount) {
	                 amountInput.value = ep.amount;
	                 document.getElementById('display-net').textContent = '$' + ep.amount;
	                 // We can't know the Display Total (Gross) without reverse engineering.
	                 // Showing "(Database Value)" might be safer.
	                 document.getElementById('display-total').textContent = '(å·²å­˜: $' + ep.amount + ')';
		          }
	             syncUnsettleButton();

	            submitBtn.textContent = 'å„²å­˜';
	            const startDate = event.start;
	            const minuteSelect = document.getElementById('minute_select');
            minuteSelect.innerHTML = '';
            const startMinute = startDate.getMinutes();
            for (let m = 0; m < 60; m += 5) {
              const opt = document.createElement('option');
              opt.value = m;
              opt.textContent = String(m).padStart(2, '0');
              if (m === startMinute) opt.selected = true;
              minuteSelect.appendChild(opt);
            }
            updateHiddenStartTime(startDate);
            minuteSelect.onchange = function () { updateHiddenStartTime(startDate) };
            appointmentModal.style.display = 'block';
          }

          /**
             * æ ¹æ“š minute_select çš„å€¼ï¼Œæ›´æ–° hidden æ¬„ä½ `#start_time`
             * - å¾Œç«¯é€šå¸¸éœ€è¦ä¸€å€‹ç¢ºå®šçš„é–‹å§‹æ™‚é–“å­—ä¸²
             * - é€™è£¡ç”¨ ISOï¼ˆtoISOStringï¼‰å¯ä»¥é¿å…å‰å¾Œç«¯æ™‚å€è™•ç†æ··äº‚ï¼ˆä½†ä»è¦æ³¨æ„å¾Œç«¯å¦‚ä½•è§£æï¼‰
             *
             * @param {Date} baseDate - ä»¥é€™å€‹æ—¥æœŸ/å°æ™‚ç‚ºåŸºæº–ï¼Œåªèª¿æ•´åˆ†é˜
             */
          function updateHiddenStartTime(baseDate) {
            const selectedMinute = parseInt(document.getElementById('minute_select').value, 10);
            const dt = new Date(baseDate.getTime());
            dt.setMinutes(selectedMinute, 0, 0);
            document.getElementById('start_time').value = dt.toISOString();
          }

          /**
           * æ’ç¨‹ï¼šç¨å¾Œé‡ç¹ªã€Œæ¯ä½è¨­è¨ˆå¸«æ¬„ä½å…§çš„æ™‚é–“è»¸ã€
           * - å› ç‚º FullCalendar åˆ‡æ›è¦–åœ–/é‡æ’ç‰ˆé¢å¯èƒ½æ˜¯éåŒæ­¥çš„
           * - ç”¨ setTimeout + æ¸…é™¤èˆŠ timerï¼Œé¿å…é€£çºŒè§¸ç™¼é€ æˆå¡é “
           */
          function schedulePerResourceTimeAxis(delayMs = 0) {
            if (perResourceAxisTimer) window.clearTimeout(perResourceAxisTimer);
            perResourceAxisTimer = window.setTimeout(renderPerResourceTimeAxis, delayMs);
          }

          // æŠŠæ—¥æ›†æ°´å¹³æ²å‹•æ‹‰å›æœ€å·¦é‚Šï¼ˆé¿å…ç‰ˆé¢é‡ç®—å¾Œåœåœ¨ä¸­é–“ï¼Œå°è‡´åº—é•·æ¬„è¢«æ“ å‡ºç•«é¢ï¼‰
          function resetCalendarHorizontalScroll() {
            const scrollers = document.querySelectorAll('#calendar .fc-scroller');
            scrollers.forEach(s => {
              if (s && s.scrollWidth > s.clientWidth) s.scrollLeft = 0;
            });
          }

          /**
           * åœ¨ã€Œæ—¥è¦–åœ–ã€ä¸­ï¼Œç‚ºæ¯ä½è¨­è¨ˆå¸«çš„å¡ç‰‡åŒ–æ¬„ä½å»ºç«‹ä¸€æ¢è‡ªå·±çš„æ™‚é–“è»¸ï¼ˆåƒå·¦é‚Šæ™‚é–“è»¸çš„è¤‡è£½ç‰ˆï¼‰
           *
           * åšæ³•ï¼š
           * 1) è®€å– FullCalendar å·¦å´æ™‚é–“è»¸æ¯ä¸€æ ¼çš„ DOM ä½ç½®ï¼ˆgetBoundingClientRectï¼‰
           * 2) å°æ¯å€‹è¨­è¨ˆå¸«æ¬„ä½ï¼ˆdata-resource-idï¼‰å»ºç«‹ `.per-resource-time-axis`
           * 3) åœ¨è»¸å…§ç”¨ absolute å®šä½æŠŠã€Œ12:00 / 12:15 / ...ã€å°é½Šåˆ°æ­£ç¢ºé«˜åº¦
           */
          function renderPerResourceTimeAxis() {
            // æ¸…æ‰èˆŠçš„ï¼ˆé¿å…é‡è¤‡æ’å…¥ï¼‰
            document.querySelectorAll('#calendar .per-resource-time-axis').forEach(n => n.remove());

            if (!calendar || calendar.view?.type !== 'resourceTimeGridDay') return;
            resetCalendarHorizontalScroll();

            // âš ï¸ ä¸ä¾è³´ã€Œæœ€å·¦é‚Šæ™‚é–“è»¸ã€çš„ DOM
            // å› ç‚ºä½ æƒ³æŠŠæœ€å·¦é‚Šæ™‚é–“è»¸æ•´å€‹ç§»é™¤æ‰ï¼ˆé¿å…å¤šä¸€æ¬„ï¼‰
            // æ‰€ä»¥é€™è£¡æ”¹ç”¨ã€Œtimegrid çš„æ¯ä¸€åˆ— slot-laneã€ä¾†è¨ˆç®— y åº§æ¨™ï¼š
            // - `data-time="12:00:00"` é€™ç¨®å±¬æ€§ä¸€å®šå­˜åœ¨ï¼ˆæ¯ä¸€åˆ—éƒ½æœ‰ï¼‰
            // - æœƒå‡ºç¾å¤šå€‹ï¼ˆæ¯å€‹è¨­è¨ˆå¸«æ¬„ä½å„ä¸€ä»½ï¼‰ï¼Œæˆ‘å€‘åªå–æ¯å€‹æ™‚é–“é»çš„ç¬¬ä¸€å€‹
            const laneCells = Array.from(
              document.querySelectorAll('#calendar .fc-resourceTimeGridDay-view td.fc-timegrid-slot.fc-timegrid-slot-lane[data-time]')
            );
            if (!laneCells.length) return;

            const byTime = new Map();
            laneCells.forEach(cell => {
              const t = cell.getAttribute('data-time');
              if (!t) return;
              if (!byTime.has(t)) byTime.set(t, cell);
            });

            const labelInfos = Array.from(byTime.entries())
              .sort((a, b) => (a[0] < b[0] ? -1 : a[0] > b[0] ? 1 : 0))
              .map(([t, cell]) => {
                // t: "12:15:00" â†’ é¡¯ç¤º "12:15"
                const text = String(t).slice(0, 5);
                const rect = cell.getBoundingClientRect();
                const minute = parseInt(String(t).slice(3, 5), 10);
                const kind = minute === 0 || minute === 30 ? 'major' : 'minor';
                return { text, rect, kind };
              });

            // æ¯ä½è¨­è¨ˆå¸«æ¬„ä½ï¼ˆåªæŠ“æœ‰ resource-id çš„æ¬„ï¼‰
            const frames = Array.from(
              document.querySelectorAll('#calendar .fc-resourceTimeGridDay-view .fc-timegrid-col[data-resource-id] .fc-timegrid-col-frame')
            );
            if (!frames.length) return;

            frames.forEach(frame => {
              const axis = document.createElement('div');
              axis.className = 'per-resource-time-axis';
              axis.setAttribute('aria-hidden', 'true');

              const frameRect = frame.getBoundingClientRect();

              labelInfos.forEach(info => {
                const item = document.createElement('div');
                item.className = `per-resource-time-item ${info.kind === 'major' ? 'is-major' : 'is-minor'}`;
                item.textContent = info.text;
                const y = info.rect.top - frameRect.top + info.rect.height / 2;
                item.style.top = `${y}px`;
                axis.appendChild(item);
              });

              frame.appendChild(axis);
            });
          }

          /**
             * å»ºç«‹ï¼ˆæˆ–å–å¾—å·²å­˜åœ¨çš„ï¼‰ã€Œæ—¥æœŸæ»‘å‹•åˆ— / è¦–åœ–åˆ‡æ›åˆ—ã€UI
             *
             * é€™æ˜¯è‡ªè¨‚ UIï¼ˆä¸æ˜¯ FullCalendar å…§å»º toolbarï¼‰ï¼š
             * - å·¦å´ï¼šå¹´æœˆã€æ—¥
             * - ä¸­é–“ï¼šå¯å·¦å³æ»‘å‹•çš„æ—¥æœŸæŒ‰éˆ•ï¼ˆå‰å¾Œå¹¾å¤©ï¼‰
             * - å³å´ï¼šæ—¥/é€±/æœˆ è¦–åœ–åˆ‡æ›æŒ‰éˆ•
             * - ä¹ŸæœƒæŠŠã€Œæœˆçµå ±è¡¨ã€æŒ‰éˆ• append åˆ°å³å´å€åŸŸ
             */
          function ensureDateScroller() {
            const cal = document.getElementById('calendar');
            if (!cal) return null;
            let scroller = cal.querySelector('.fc-date-scroller');
            if (scroller) return scroller;
            const toolbar = cal.querySelector('.fc-header-toolbar');
            const viewHarness = cal.querySelector('.fc-view-harness');
            scroller = document.createElement('div');
            scroller.className = 'fc-date-scroller';
            // ä½¿ç”¨ template literal çµ„ä¸€æ®µ HTMLï¼Œç›´æ¥å¡é€² scroller
            scroller.innerHTML = `
        <div class="date-row">
          <div class="date-left-col">
            <div class="date-label" aria-live="polite">
              <span class="date-header-month"></span>
              <span class="date-header-day"></span>
            </div>
            <div class="date-toggle" role="tablist" aria-label="è¦–åœ–åˆ‡æ›">
              <button type="button" class="date-toggle-btn" data-view="resourceTimeGridDay">æ—¥</button>
              <button type="button" class="date-toggle-btn" data-view="resourceTimeGridWeek">é€±</button>
              <button type="button" class="date-toggle-btn" data-view="dayGridMonth">æœˆ</button>
            </div>
            <div class="mobile-resource-toggle" role="tablist" aria-label="è¨­è¨ˆå¸«åˆ‡æ›"></div>
          </div>
          <div class="date-strip" role="listbox" aria-label="æ—¥æœŸé¸æ“‡"></div>
        </div>
      `;
            if (toolbar) {
              toolbar.insertAdjacentElement('afterend', scroller);
            } else if (viewHarness) {
              viewHarness.insertAdjacentElement('beforebegin', scroller);
            } else {
              cal.prepend(scroller);
            }
            const reportBtn = document.getElementById('open-report-btn');
            const toggleRow = scroller.querySelector('.date-toggle');
            if (reportBtn && toggleRow) {
              // æŠŠã€Œæœˆçµå ±è¡¨ã€æŒ‰éˆ•æŒªåˆ°å·¦å´åˆ‡æ›æŒ‰éˆ•æ—é‚Š
              toggleRow.appendChild(reportBtn);
            }
            ensureMobileResourceToggle(scroller);
            return scroller;
          }

          /**
             * æ›´æ–°æ—¥æœŸæ»‘å‹•åˆ—ï¼ˆæ¯æ¬¡åˆ‡æ›æ—¥æœŸ/åˆ‡æ›è¦–åœ–æ™‚å‘¼å«ï¼‰
             *
             * @param {Object} info - FullCalendar çš„ datesSet callback åƒæ•¸
             */
          function updateDateScroller(info) {
            const cal = document.getElementById('calendar');
            if (!cal || !info || !info.view) return;
            cal.classList.add('is-date-scroller');

            const scroller = ensureDateScroller();
            if (!scroller) return;
            scroller.hidden = false;
            ensureMobileResourceToggle(scroller);

            // åœ¨æ—¥è¦–åœ–æ™‚ï¼ŒæŠŠä½¿ç”¨è€…æ­£åœ¨çœ‹çš„æ—¥æœŸè¨˜éŒ„ä¸‹ä¾†ï¼ˆé¿å…åˆ‡æ›è¦–åœ–å¾Œæ‰¾ä¸åˆ°åŸºæº–æ—¥ï¼‰
            if (info.view.type === 'resourceTimeGridDay') {
              // âš ï¸ ç”¨ã€Œæœ¬åœ°æ™‚é–“ä¸­åˆã€ä¾†å­˜ï¼Œé¿å…æ™‚å€/UTC è½‰æ›é€ æˆã€Œé» 18 è®Š 17ã€çš„æ—¥æœŸåç§»
              selectedDate = new Date(info.view.currentStart);
              selectedDate.setHours(12, 0, 0, 0);
            }
            if (!selectedDate) {
              selectedDate = new Date(calendar.getDate());
              selectedDate.setHours(12, 0, 0, 0);
            }
            const activeDate = selectedDate ? new Date(selectedDate) : calendar.getDate();
            const dateLocale = 'zh-TW';
            const monthFmt = new Intl.DateTimeFormat(dateLocale, { month: 'numeric' });
            const weekdayFmt = new Intl.DateTimeFormat(dateLocale, { weekday: 'narrow' });
            const monthRaw = monthFmt.format(activeDate);
            const monthLabel = monthRaw.includes('æœˆ') ? monthRaw : `${monthRaw}æœˆ`;
            // å·¦å´ï¼šå¹´æœˆã€æ—¥
            scroller.querySelector('.date-header-month').textContent = `${activeDate.getFullYear()}å¹´${monthLabel}`;
            scroller.querySelector('.date-header-day').textContent = `${activeDate.getDate()}æ—¥`;

            // å³å´ï¼šè¦–åœ–åˆ‡æ›æŒ‰éˆ• active ç‹€æ…‹
            syncDateToggleState(scroller, info.view.type);
            bindDateToggleActions(scroller);

            const strip = scroller.querySelector('.date-strip');
            const todayKey = ymd(new Date());
            const currentKey = ymd(activeDate);

            // ä¸­é–“ï¼šå»ºç«‹å‰å¾Œå¹¾å¤©çš„æ—¥æœŸæŒ‰éˆ•ï¼ˆå›ºå®š 21 å¤©ï¼‰
            // éœ€æ±‚ï¼šäº®èµ·ä¾†ï¼ˆis-activeï¼‰çš„é‚£å¤©è¦åœ¨ã€Œæ­£ä¸­é–“ã€
            // - æ‰€ä»¥ç”¨ã€Œå‰ 10 å¤© + å¾Œ 10 å¤©ã€è®“ activeDate ç½®ä¸­ï¼ˆç¬¬ 11 å€‹ï¼‰
            // - ä¸è‡ªå‹•æ“´å¤§ç¯„åœï¼ˆç¶­æŒä½ å¸Œæœ›çš„åŸæœ¬å¯¬åº¦/æ•¸é‡ï¼‰
            // - å¦å¤–ï¼šå› ç‚ºæ—¥è¦–åœ– hiddenDays: [1]ï¼ˆé€±ä¸€ä¸é¡¯ç¤ºï¼‰ï¼Œæ—¥æœŸåˆ—ä¹ŸåŒæ­¥ã€Œç§»é™¤é€±ä¸€ã€
            strip.innerHTML = '';

            // ä»¥ã€Œå¯è¦‹æ—¥æœŸã€ç‚ºåŸºæº–çµ„ 21 å€‹ï¼ˆå‰ 10 + ç•¶å¤© + å¾Œ 10ï¼‰ï¼Œä¸¦è·³éé€±ä¸€
            // é€™æ¨£å°±ä¸æœƒå‡ºç¾ã€Œæ—¥æœŸåˆ—æœ‰é€±ä¸€ï¼Œä½†æ—¥è¦–åœ–å…¶å¯¦è·³ä¸åˆ°é€±ä¸€ã€çš„éŒ¯è¦ºã€‚
            const dates = [];
            const activeBase = new Date(activeDate);
            activeBase.setHours(12, 0, 0, 0);
            if (activeBase.getDay() === 1) activeBase.setDate(activeBase.getDate() + 1); // ä¿éšªï¼šé€±ä¸€ â†’ é€±äºŒ

            const before = [];
            const after = [];

            let cursor = new Date(activeBase);
            while (before.length < 10) {
              cursor.setDate(cursor.getDate() - 1);
              if (cursor.getDay() === 1) continue; // è·³éé€±ä¸€
              before.push(new Date(cursor));
            }

            cursor = new Date(activeBase);
            while (after.length < 10) {
              cursor.setDate(cursor.getDate() + 1);
              if (cursor.getDay() === 1) continue; // è·³éé€±ä¸€
              after.push(new Date(cursor));
            }

            dates.push(...before.reverse(), activeBase, ...after);

            dates.forEach(d => {
              const dateKey = ymd(d);
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'date-item';
              if (dateKey === currentKey) btn.classList.add('is-active');
              if (dateKey === todayKey) btn.classList.add('is-today');
              btn.setAttribute('role', 'option');
              btn.setAttribute('aria-selected', dateKey === currentKey ? 'true' : 'false');
              btn.dataset.date = dateKey;
              btn.innerHTML = `<span class="date-item-weekday">${weekdayFmt.format(d)}</span><span class="date-item-day">${d.getDate()}</span>`;
              strip.appendChild(btn);
            });

            // å»ºç«‹å®Œæ—¥æœŸæŒ‰éˆ•å¾Œå†å•Ÿç”¨æ‹–æ›³ï¼ˆé¿å…æœªæ¸²æŸ“å®Œæˆæ™‚çš„æ‰‹å‹¢å¹²æ“¾ï¼‰
            enableDragScroll(strip);

            // åšå¼§å½¢/ç¸®æ”¾çš„è¦–è¦ºæ•ˆæœï¼ˆç´” UIï¼Œä¸å½±éŸ¿åŠŸèƒ½ï¼‰
            applyDateStripCurve(strip);
            // ä¸è¦å¼·åˆ¶æŠŠã€Œé¸ä¸­çš„æ—¥æœŸã€æ°¸é ç½®ä¸­ï¼ˆæœƒè®“ä½¿ç”¨è€…è¦ºå¾—ã€Œæ€éº¼æ»¾éƒ½å›ä¸­é–“ã€ï¼‰
            // åªè¦ç¢ºä¿å®ƒåœ¨å¯è¦–ç¯„åœå…§å³å¯ã€‚
            const active = strip.querySelector('.date-item.is-active');
            if (active) {
              const shouldCenter = strip.dataset.centerOnNextUpdate === '1';
              if (shouldCenter) {
                delete strip.dataset.centerOnNextUpdate;
                const maxScrollLeft = Math.max(0, strip.scrollWidth - strip.clientWidth);
                const targetLeft = active.offsetLeft - (strip.clientWidth - active.clientWidth) / 2;
                const nextLeft = Math.max(0, Math.min(targetLeft, maxScrollLeft));
                if (typeof strip.scrollTo === 'function') strip.scrollTo({ left: nextLeft, behavior: 'smooth' });
                else strip.scrollLeft = nextLeft;
              } else {
                active.scrollIntoView({ block: 'nearest', inline: 'nearest' });
              }
            }
          }

          function isMobileLayout() {
            return !!(window.matchMedia && window.matchMedia(MOBILE_RESOURCE_MEDIA_QUERY).matches);
          }

          // æ‰‹æ©Ÿ/å¹³æ¿ã€Œå–®ä¸€è¨­è¨ˆå¸«ã€åˆ‡æ›ï¼šå…è¨± 'all' ä»£è¡¨é¡¯ç¤ºå…¨éƒ¨è¨­è¨ˆå¸«æ¬„ä½
          function getValidResourceId(id) {
            const normalized = String(id || '').trim();
            if (!normalized) return null;
            if (normalized === 'all') return 'all';
            return RESOURCE_LIST.some(r => String(r.id) === normalized) ? normalized : null;
          }

          function getStoredResourceId() {
            try {
              return getValidResourceId(localStorage.getItem(MOBILE_RESOURCE_STORAGE_KEY));
            } catch (err) {
              return null;
            }
          }

          function storeResourceId(id) {
            try {
              localStorage.setItem(MOBILE_RESOURCE_STORAGE_KEY, id);
            } catch (err) {
              // ignore storage errors (private mode / quota)
            }
          }

          function ensureMobileResourceId() {
            const valid = getValidResourceId(mobileSelectedResourceId) || getStoredResourceId() || String(RESOURCE_LIST[0]?.id || '1');
            mobileSelectedResourceId = valid;
            return valid;
          }

          function ensureMobileResourceToggle(scroller) {
            if (!scroller) return;
            const wrap = scroller.querySelector('.mobile-resource-toggle');
            if (!wrap || wrap.dataset.bound === '1') return;
            wrap.dataset.bound = '1';
            // å¤šä¸€é¡†ã€Œå…¨éƒ¨ã€æŒ‰éˆ•ï¼šåœ¨ 1024 æ¨¡å¼å¯ä¸€æ¬¡é¡¯ç¤ºä¸‰ä½è¨­è¨ˆå¸«
            const allBtn = `<button type="button" class="resource-toggle-btn" data-resource-id="all">å…¨éƒ¨</button>`;
            const resourceBtns = RESOURCE_LIST.map(resource => {
              const rid = String(resource.id);
              const title = resource.title || rid;
              return `<button type="button" class="resource-toggle-btn" data-resource-id="${rid}">${title}</button>`;
            }).join('');
            wrap.innerHTML = allBtn + resourceBtns;
            wrap.querySelectorAll('.resource-toggle-btn').forEach(btn => {
              btn.addEventListener('click', () => {
                const rid = getValidResourceId(btn.dataset.resourceId);
                if (!rid) return;
                mobileSelectedResourceId = rid;
                storeResourceId(rid);
                applyMobileResourceVisibility();
                schedulePerResourceTimeAxis(80);
              });
            });
          }

          function syncMobileResourceToggleState(scroller) {
            if (!scroller) return;
            const wrap = scroller.querySelector('.mobile-resource-toggle');
            if (!wrap) return;
            const activeId = ensureMobileResourceId();
            wrap.querySelectorAll('.resource-toggle-btn').forEach(btn => {
              const isActive = String(btn.dataset.resourceId) === String(activeId);
              btn.classList.toggle('is-active', isActive);
              btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
            });
          }

          function applyMobileResourceVisibility(info) {
            const cal = document.getElementById('calendar');
            if (!cal) return;
            const viewType = info?.view?.type || calendar?.view?.type || '';
            const isDayView = viewType === 'resourceTimeGridDay';
            const shouldShowSingle = isDayView && isMobileLayout();
            const scroller = cal.querySelector('.fc-date-scroller');
            if (scroller) {
              ensureMobileResourceToggle(scroller);
              scroller.classList.toggle('is-mobile-resource', shouldShowSingle);
              syncMobileResourceToggleState(scroller);
            }
            if (!shouldShowSingle) {
              cal.removeAttribute('data-mobile-resource');
              return;
            }
            cal.setAttribute('data-mobile-resource', ensureMobileResourceId());
          }

          /**
             * è¦–è¦ºæ•ˆæœï¼šè®“æ—¥æœŸæŒ‰éˆ•å‘ˆç¾ã€Œä¸­é–“æ”¾å¤§ã€å…©å´ç¸®å°ã€çš„å¼§å½¢æ’åˆ—æ„Ÿ
             * - é€éè¨­å®š CSS è®Šæ•¸ï¼ˆ--arc-offset / --arc-scale / --arc-opacity / --arc-font-scaleï¼‰
             * 
             * ğŸ¨ èª¿æ•´æŒ‡å—ï¼ˆä¿®æ”¹ä¸‹æ–¹æ•¸å€¼å³å¯ï¼‰ï¼š
             * - offsetï¼šè·é›¢é¸ä¸­æ—¥æœŸè¶Šé ï¼Œå¾€ä¸‹åç§»è¶Šå¤šï¼ˆå¼§å½¢çš„ä¸‹æ²‰æ„Ÿï¼‰
             * - scaleï¼šè·é›¢é¸ä¸­æ—¥æœŸè¶Šé ï¼Œæ•´é«”ç¸®å°è¶Šå¤š
             * - opacityï¼šè·é›¢é¸ä¸­æ—¥æœŸè¶Šé ï¼Œé€æ˜åº¦è¶Šä½ï¼ˆæ·¡å‡ºæ•ˆæœï¼‰
             * - fontScaleï¼šè·é›¢é¸ä¸­æ—¥æœŸè¶Šé ï¼Œå­—é«”è¶Šå°
             */
          function applyDateStripCurve(strip) {
  if (!strip || strip.dataset.curveRendering === '1') return;
  strip.dataset.curveRendering = '1';
  
  requestAnimationFrame(() => {
    const items = Array.from(strip.querySelectorAll('.date-item'));
    if (!items.length) {
      strip.dataset.curveRendering = '0';
      return;
    }
    const activeIndex = items.findIndex(item => item.classList.contains('is-active'));
    if (activeIndex === -1) {
      strip.dataset.curveRendering = '0';
      return;
    }
    
    items.forEach((item, idx) => {
      const dist = Math.abs(idx - activeIndex);
      const offset = Math.min(22, dist * 6);
      const scale = dist === 0 ? 1.1 : Math.max(0.84, 1 - dist * 0.06);
      const opacity = dist === 0 ? 1 : Math.max(0.45, 1 - dist * 0.12);
      const fontScale = dist === 0 ? 1 : Math.max(0.7, 1 - dist * 0.08);
      
      item.style.setProperty('--arc-offset', `${offset}px`);
      item.style.setProperty('--arc-scale', scale.toFixed(2));
      item.style.setProperty('--arc-opacity', opacity.toFixed(2));
      item.style.setProperty('--arc-font-scale', fontScale.toFixed(2));
    });
    
    strip.dataset.curveRendering = '0';
  });
}

          /**
             * é»æ“Šæ—¥æœŸæŒ‰éˆ•å¾Œï¼šåˆ‡åˆ°æ—¥è¦–åœ–ä¸¦è·³åˆ°è©²å¤©
             * @param {HTMLElement} item - `.date-item` button
             */
          function selectDateFromItem(item) {
            if (!item || !item.dataset.date) return;
            const dateStr = String(item.dataset.date);
            const parts = dateStr.split('-').map(Number);
            if (parts.length !== 3) return;

            // ç”¨ä¸­åˆé¿å… UTC è½‰æ›è·¨æ—¥ï¼ˆä½ é‡åˆ°çš„ã€Œé» 17 è·³å…©å¤© / é» 18 è·³ä¸€å¤©ã€å°±æ˜¯é€™ç¨®ç‹€æ³ï¼‰
            const pickedNoon = new Date(parts[0], parts[1] - 1, parts[2], 12, 0, 0, 0);
            selectedDate = pickedNoon;

            // ç”¨ YYYY-MM-DD å­—ä¸²å°èˆªï¼ŒFullCalendar æœƒç•¶ä½œã€Œæ—¥æœŸã€è™•ç†ï¼Œæ¯” Date ç‰©ä»¶æ›´ä¸å®¹æ˜“å‡ºç¾è·¨æ—¥åç§»
            calendar.changeView('resourceTimeGridDay', dateStr);
            calendar.gotoDate(dateStr);
          }

          /**
             * è¦–åœ–åˆ‡æ›æŒ‰éˆ•ç‹€æ…‹åŒæ­¥ï¼šæŠŠç›®å‰è¦–åœ–çš„æŒ‰éˆ•åŠ ä¸Š active æ¨£å¼
             * @param {HTMLElement} scroller - `.fc-date-scroller`
             * @param {string} viewType - FullCalendar çš„ view.type
             */
          function syncDateToggleState(scroller, viewType) {
            scroller.querySelectorAll('.date-toggle-btn').forEach(btn => {
              const isActive = viewType === btn.dataset.view;
              btn.classList.toggle('is-active', isActive);
              btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
            });
          }

          /**
             * ç¶å®šè¦–åœ–åˆ‡æ›æŒ‰éˆ•ï¼ˆé¿å…é‡è¤‡ç¶å®šï¼Œä½¿ç”¨ dataset.toggleBound åšè¨˜è™Ÿï¼‰
             */
          function bindDateToggleActions(scroller) {
            if (!scroller || scroller.dataset.toggleBound === '1') return;
            scroller.dataset.toggleBound = '1';
            scroller.querySelectorAll('.date-toggle-btn').forEach(btn => {
              btn.addEventListener('click', () => {
                const view = btn.dataset.view;
                const baseDate = selectedDate ? new Date(selectedDate) : new Date(calendar.getDate());
                baseDate.setHours(12, 0, 0, 0);
                if (view === 'resourceTimeGridDay') {
                  // æ—¥è¦–åœ–ï¼šä¸€å¾‹å›åˆ°ä»Šå¤©
                  const today = new Date();
                  today.setHours(12, 0, 0, 0);
                  const todayKey = ymd(today);
                  selectedDate = today;
                  calendar.changeView(view, todayKey);
                  calendar.gotoDate(todayKey);
                  return;
                }
                const baseKey = ymd(baseDate);
                if (calendar.view && calendar.view.type === view) return;
                calendar.changeView(view, baseKey);
              });
            });
          }

          /**
             * è®“å…ƒç´ æ”¯æ´ã€Œæ»‘é¼ æŒ‰ä½æ‹–æ›³æ²å‹•ã€ï¼ˆä¹Ÿæ”¯æ´è§¸æ§ / Pointer Eventsï¼‰
             * - moved=false æ™‚ä»£è¡¨æ˜¯ã€Œé»æ“Šã€ï¼Œæœƒè§¸ç™¼é¸æ—¥æœŸ
             * - moved=true æ™‚ä»£è¡¨æ˜¯ã€Œæ‹–æ›³ã€ï¼Œä¸è§¸ç™¼é¸æ—¥æœŸï¼ˆé¿å…èª¤é»ï¼‰
             *
             * @param {HTMLElement} strip - è¦æ²å‹•çš„å®¹å™¨ (.date-strip)
             */
          function enableDragScroll(strip) {
            if (!strip || strip.dataset.dragBound === '1') return;
            strip.dataset.dragBound = '1';
            // åŒæ™‚æ”¯æ´ Pointer Events + Mouse Eventsï¼ˆéƒ¨åˆ†ç’°å¢ƒ pointer äº‹ä»¶ä¸ç©©æ™‚ï¼Œæ»‘é¼ ä»å¯æ‹–æ›³ï¼‰
            let isDown = false;
            let startX = 0;
            let scrollLeft = 0;
            let moved = false;
            let downItem = null;
            let activeMode = null; // 'pointer' | 'mouse' | null

            const beginDrag = (clientX, item) => {
              isDown = true;
              moved = false;
              downItem = item;
              startX = clientX;
              scrollLeft = strip.scrollLeft;
              strip.classList.add('active'); // å°æ‡‰ CSSï¼šcursor grabbing / é¿å…èª¤è§¸
            };

            const moveDrag = (clientX) => {
              if (!isDown) return;
              const dx = clientX - startX;
              if (Math.abs(dx) > 6 && !moved) {
                moved = true;
                strip.classList.add('is-dragging');
              }
              const walk = dx * 2; // æ‹–æ›³é€Ÿåº¦ï¼šæ•¸å­—è¶Šå¤§æ»‘è¶Šå¿«
              strip.scrollLeft = scrollLeft - walk;
            };

            const endDrag = () => {
              if (!isDown) return;
              isDown = false;
              strip.classList.remove('is-dragging');
              strip.classList.remove('active');
              if (!moved && downItem) {
                // é»æ“Šæ—¥æœŸå¾Œï¼šä¸‹ä¸€æ¬¡é‡ç¹ªæ—¥æœŸåˆ—æ™‚ï¼ŒæŠŠè©²æ—¥æœŸç½®ä¸­ï¼ˆè¦–è¦ºæ•ˆæœæ›´ç›´è¦ºï¼‰
                strip.dataset.centerOnNextUpdate = '1';
                selectDateFromItem(downItem);
              }
              downItem = null;
              activeMode = null;
            };

            // é˜²æ­¢ç€è¦½å™¨æŠŠæ‹–æ›³ç•¶æˆåŸç”Ÿ drag è¡Œç‚ºï¼ˆæŸäº›ç€è¦½å™¨æœƒå‡ºç¾ ghost imageï¼‰
            strip.addEventListener('dragstart', (e) => e.preventDefault());

            const onPointerDown = (e) => {
              if (activeMode === 'touch') return;
              if (e.button && e.button !== 0) return;
              // è®“æ‹–æ›³æ»¾å‹•æ›´ç©©ï¼šé¿å…ç€è¦½å™¨æŠŠå®ƒç•¶æˆæ–‡å­—é¸å–/é»æ“Š
              e.preventDefault();
              activeMode = 'pointer';
              const item = e.target && e.target.closest ? e.target.closest('.date-item') : null;
              beginDrag(e.clientX, item);
              try { strip.setPointerCapture(e.pointerId); } catch { }
            };

            const onPointerMove = (e) => {
              if (activeMode !== 'pointer') return;
              e.preventDefault();
              moveDrag(e.clientX);
            };

            const onPointerUp = (e) => {
              if (activeMode !== 'pointer') return;
              e.preventDefault();
              try { strip.releasePointerCapture(e.pointerId); } catch { }
              endDrag();
            };

            // Mouse fallbackï¼šæœ‰äº›ç’°å¢ƒ pointerdown/move ä¸æœƒæ­£å¸¸é‹ä½œï¼ˆæˆ–è¢«ç€è¦½å™¨æ‰‹å‹¢æ””æˆªï¼‰
            const onMouseDown = (e) => {
              if (activeMode === 'touch') return;
              if (activeMode === 'pointer') return;
              if (e.button !== 0) return;
              e.preventDefault();
              activeMode = 'mouse';
              const item = e.target && e.target.closest ? e.target.closest('.date-item') : null;
              beginDrag(e.clientX, item);
            };

            const onMouseMove = (e) => {
              if (activeMode !== 'mouse') return;
              e.preventDefault();
              moveDrag(e.clientX);
            };

            const onMouseUp = (e) => {
              if (activeMode !== 'mouse') return;
              e.preventDefault();
              endDrag();
            };

            // Touch fallbackï¼šiOS èˆŠç‰ˆ Safari/ç‰¹å®š WebView å¯èƒ½æ²’æœ‰ç©©å®šçš„ Pointer Events
            const onTouchStart = (e) => {
              if (activeMode === 'pointer' || activeMode === 'mouse') return;
              if (!e.touches || e.touches.length !== 1) return;
              e.preventDefault();
              activeMode = 'touch';
              const t = e.touches[0];
              const item = e.target && e.target.closest ? e.target.closest('.date-item') : null;
              beginDrag(t.clientX, item);
            };

            const onTouchMove = (e) => {
              if (activeMode !== 'touch') return;
              if (!e.touches || e.touches.length !== 1) return;
              e.preventDefault();
              const t = e.touches[0];
              moveDrag(t.clientX);
            };

            const onTouchEnd = (e) => {
              if (activeMode !== 'touch') return;
              e.preventDefault();
              endDrag();
            };

            strip.addEventListener('pointerdown', onPointerDown, { passive: false });
            strip.addEventListener('pointermove', onPointerMove, { passive: false });
            strip.addEventListener('pointerup', onPointerUp, { passive: false });
            strip.addEventListener('pointercancel', onPointerUp, { passive: false });
            strip.addEventListener('pointerleave', onPointerUp, { passive: false });

            strip.addEventListener('mousedown', onMouseDown, { passive: false });
            window.addEventListener('mousemove', onMouseMove, { passive: false });
            window.addEventListener('mouseup', onMouseUp, { passive: false });

            strip.addEventListener('touchstart', onTouchStart, { passive: false });
            strip.addEventListener('touchmove', onTouchMove, { passive: false });
            strip.addEventListener('touchend', onTouchEnd, { passive: false });
            strip.addEventListener('touchcancel', onTouchEnd, { passive: false });
          }

          /**
             * æ›´æ–° FullCalendar åŸæœ¬ toolbar title çš„æ–‡å­—
             * - æœˆè¦–åœ–ï¼šé¡¯ç¤ºã€ŒYYYY å¹´ M æœˆã€
             * - æ—¥è¦–åœ–ï¼šé¡¯ç¤ºã€ŒYYYY å¹´ M æœˆ D æ—¥ < é€±X >ã€
             */
          function updateToolbarTitle(info) {
            const el = document.querySelector('#calendar .fc-toolbar-title');
            if (!el || !info || !info.view) return;

            const type = info.view.type;
            const d = info.view.currentStart;
            const y = d.getFullYear();
            const m = d.getMonth() + 1;
            const day = d.getDate();
            const wdMap = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

            if (type === 'dayGridMonth') {
              el.classList.add('is-month-title');
              el.innerHTML = `<span class="title-month-text">${y} å¹´ ${m} æœˆ</span>`;
              return;
            }

            el.classList.remove('is-month-title');
            if (type === 'resourceTimeGridDay') {
              el.textContent = `${y} å¹´ ${m} æœˆ ${day} æ—¥ < ${wdMap[d.getDay()]} >`;
            } else {
              el.textContent = info.view.title;
            }
          }


          /**
             * åœ¨é€±ä¸€çš„æ¬„ä½ç•«å‡ºã€Œå…¬ä¼‘ã€è¦†è“‹å±¤ï¼ˆå¦‚æœè©²æ—¥æœŸå€é–“åŒ…å«é€±ä¸€ï¼‰
             *
             * å‚™è¨»ï¼š
             * - æœ¬å°ˆæ¡ˆå…¨åŸŸè¨­å®š hiddenDays: [1] æœƒéš±è—é€±ä¸€ï¼ˆè¦–åœ–ä¸æœƒé¡¯ç¤ºï¼‰
             * - ä»ä¿ç•™é€™æ®µç¨‹å¼ï¼šç”¨æ–¼æœªä¾†å¯èƒ½æ”¹æˆé¡¯ç¤ºé€±ä¸€æ™‚ï¼Œå¯ä»¥ç›´æ¥å‘ˆç¾ã€Œå…¬ä¼‘ã€æç¤º
             */
          function paintMondayClosed(info) {
            document.querySelectorAll('#calendar .closed-overlay:not(.leave-overlay)').forEach(n => n.remove());
            const start = info.start, end = info.end;
            const ymd = d => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            for (let d = new Date(start); d < end; d.setDate(d.getDate() + 1)) {
              if (d.getDay() !== 1) continue;
              const dateStr = ymd(d);
              document.querySelectorAll(`#calendar .fc-timegrid-col[data-date="${dateStr}"]`).forEach(col => {
                const frame = col.querySelector('.fc-timegrid-col-frame');
                const container = frame || col;
                const ov = document.createElement('div');
                ov.className = 'closed-overlay';
                ov.textContent = 'å…¬ä¼‘';
                container.appendChild(ov);
              });
            }
          }
        });

        // ==========================================
        // å ±è¡¨å‰ç«¯é‚è¼¯
        //
        // æ¶æ§‹ï¼š
        // - é€™æ®µç¨‹å¼ç¢¼å¯«åœ¨ DOMContentLoaded å¤–é¢ï¼Œä½†å› ç‚º <script> æ”¾åœ¨ body æœ€åº•éƒ¨
        //   æ‰€ä»¥ HTML å·²ç¶“è¢«ç€è¦½å™¨è§£æå®Œæˆï¼ŒgetElementById ä»ç„¶æŠ“å¾—åˆ°å…ƒç´ ã€‚
        //
        // æµç¨‹ï¼š
        // 1) é»ã€ŒæŸ¥çœ‹æœˆçµå ±è¡¨ã€â†’ æ‰“é–‹å½ˆçª— + åˆå§‹åŒ–èµ·è¨–æ—¥
        // 2) é»ã€ŒæŸ¥è©¢ã€â†’ fetch action=getReport
        // 3) renderReport() æŠŠè³‡æ–™æ¸²æŸ“æˆè¡¨æ ¼
        // ==========================================
        // const reportModal = document.getElementById('reportModal'); // Moved to global

        const openReportBtn = document.getElementById('open-report-btn');
        const closeReportBtn = document.querySelector('.report-close-button');
        const fetchReportBtn = document.getElementById('fetch-report-btn');
        const reportResult = document.getElementById('report-result');
        const repStart = document.getElementById('report-start');
        const repEnd = document.getElementById('report-end');

        /**
         * åˆå§‹åŒ–èµ·è¨–æ—¥ï¼ˆé è¨­ï¼šæœ¬æœˆ 1 æ—¥ ï½ ä»Šæ—¥ï¼‰
         */
        function initReportDateRange() {
          const pad2 = (n) => String(n).padStart(2, '0');
          const fmt = (d) => `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
          const now = new Date();
          const first = new Date(now.getFullYear(), now.getMonth(), 1);
          if (!repStart.value) repStart.value = fmt(first);
          if (!repEnd.value) repEnd.value = fmt(now);
        }

        // 2. é–‹é—œè¦–çª—
        if (openReportBtn) {
          openReportBtn.addEventListener('click', () => {
            reportModal.style.display = 'block';
            initReportDateRange();
          });
        }
        if (closeReportBtn) {
          closeReportBtn.addEventListener('click', () => {
            reportModal.style.display = 'none';
          });
        }

        // 3. æŸ¥è©¢å‹•ä½œ
        if (fetchReportBtn) {
          fetchReportBtn.addEventListener('click', async () => {
            const start = repStart.value;
            const end = repEnd.value;
            if (!start || !end) {
              reportResult.innerHTML = '<div style="color:#ffb74d; text-align:center; padding:20px;">è«‹é¸æ“‡èµ·è¨–æ—¥æœŸ</div>';
              return;
            }
            if (start > end) {
              reportResult.innerHTML = '<div style="color:#ffb74d; text-align:center; padding:20px;">èµ·æ—¥ä¸å¯æ™šæ–¼è¿„æ—¥</div>';
              return;
            }
            reportResult.innerHTML = '<div style="text-align:center; padding:20px;">â³ è³‡æ–™è¨ˆç®—ä¸­...</div>';
            try {
              // å‘¼å«å¾Œç«¯ (getReport)
              const url = APPS_SCRIPT_WEB_APP_URL + `?action=getReport&startDate=${encodeURIComponent(start)}&endDate=${encodeURIComponent(end)}`;
              const res = await fetch(url);
              const data = await res.json();
              renderReport(data);
            } catch (e) {
              console.error(e);
              reportResult.innerHTML = '<div style="color:#ff6b6b; text-align:center;">âŒ è®€å–å¤±æ•—</div>';
            }
          });
        }

        /**
         * æŠŠå¾Œç«¯å›ä¾†çš„å ±è¡¨è³‡æ–™æ¸²æŸ“æˆ HTML è¡¨æ ¼
         * - é¡¯ç¤ºç¸½å®¢æ•¸
         * - é€ä½è¨­è¨ˆå¸«åˆ—å‡ºï¼šå®¢æ•¸ + æœå‹™é …ç›®åˆ†ä½ˆ
         *
         * @param {Object} data - å¾Œç«¯ action=getReport å›å‚³çš„ JSON
         */
        function renderReport(data) {
          if (!data || (!Object.keys(data.designers).length && !Object.keys(data.assistants).length)) {
            reportResult.innerHTML = '<div style="text-align:center; padding:20px; color:#ccc;">è©²å€é–“å°šç„¡é ç´„è³‡æ–™</div>';
            return;
          }

          let html = '';

          // 1. è¨­è¨ˆå¸«æ¥­ç¸¾å ±è¡¨
          html += `<h4 style="margin-top:0; border-left:4px solid var(--accent-color); padding-left:10px;">è¨­è¨ˆå¸«æ¥­ç¸¾ (40%)</h4>`;
          html += `<table class="report-table" style="margin-bottom:20px;">
                <thead>
                  <tr>
                    <th width="18%">è¨­è¨ˆå¸«</th>
                    <th width="10%">å®¢æ•¸</th>
                    <th width="9%">å‰ª</th>
                    <th width="9%">ç‡™</th>
                    <th width="9%">æŸ“</th>
                    <th width="22%">ç¸½é‡‘é¡</th>
                    <th width="23%">æ¥­ç¸¾æŠ½æˆ</th>
                  </tr>
                </thead>
                <tbody>`;

          // éæ­·è¨­è¨ˆå¸«è³‡æ–™
          const designerMap = { '1': 'åº—é•·', '2': 'é›…å©·', '3': 'å°ç™½' };
          for (const [id, info] of Object.entries(data.designers)) {
            const name = designerMap[id] || `è¨­è¨ˆå¸«(${id})`;
            const totalAmt = info.totalAmount || 0;
            const count = info.count || 0;
            const cutCount = (typeof info.cutCount === 'number') ? info.cutCount : count;
            const permCount = info.permCount || 0;
            const dyeCount = info.dyeCount || 0;
            const commission = Math.round(totalAmt * 0.4);

            html += `<tr>
                    <td style="text-align:center; font-weight:bold; color:#fff;">${name}</td>
                    <td class="num-cell">${count}</td>
                    <td class="num-cell">${cutCount}</td>
                    <td class="num-cell">${permCount}</td>
                    <td class="num-cell">${dyeCount}</td>
                    <td class="num-cell">$${totalAmt.toLocaleString()}</td>
                    <td class="num-cell" style="color:#ffeb3b; font-weight:bold;">$${commission.toLocaleString()}</td>
                  </tr>`;
          }
          html += `</tbody></table>`;

          // 2. åŠ©ç†æ¥­ç¸¾å ±è¡¨
          html += `<h4 style="margin-top:0; border-left:4px solid #ff9800; padding-left:10px;">åŠ©ç†æ´—é ­æ¥­ç¸¾ (è¶…é300é¡†, æ¯é¡†$20)</h4>`;
          html += `<table class="report-table">
                <thead>
                  <tr>
                    <th width="30%">åŠ©ç†å§“å</th>
                    <th width="30%">æ´—é ­æ•¸</th>
                    <th width="40%">æ¥­ç¸¾çé‡‘</th>
                  </tr>
                </thead>
                <tbody>`;

          // éæ­·åŠ©ç†è³‡æ–™ (æ³¨æ„ï¼šassistant_id å°±æ˜¯å§“å)
          if (Object.keys(data.assistants).length === 0) {
            html += `<tr><td colspan="3" style="text-align:center; color:#888;">ç„¡è³‡æ–™</td></tr>`;
          } else {
            for (const [name, info] of Object.entries(data.assistants)) {
              if (!name || name === 'undefined') continue;
              const count = info.washCount || 0;
              // è¦å‰‡ï¼šè¶…é 300 é¡†çš„éƒ¨åˆ†ï¼Œæ¯é¡† $20
              const excess = Math.max(0, count - 300);
              const bonus = excess * 20;

              html += `<tr>
                      <td style="text-align:center; font-weight:bold;">${name}</td>
                      <td class="num-cell">${count} <span style="font-size:0.8em; color:#aaa;">(è¶…é¡ ${excess})</span></td>
                      <td class="num-cell" style="color:#ff9800; font-weight:bold;">$${bonus.toLocaleString()}</td>
                    </tr>`;
            }
          }
          html += `</tbody></table>`;

          reportResult.innerHTML = html;
        }

      })();
    </script>
</body>

</html>
