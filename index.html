<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>預約管理日曆 - 桔梗主題</title>
    
    <!-- FullCalendar 相關 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.11.5/main.min.css">
    
    <!-- Google Fonts - 優雅的中文字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
<style>
/* ==================== 🎨 桔梗主題配色設定區 ==================== */
/* 所有顏色都集中在這裡，方便統一調整 */
:root {
  /* 🌸 主要桔梗色系 */
  --kikyo-primary: #5D4E75;           /* 桔梗主色 - 優雅紫色 */
  --kikyo-light: #8B7CA3;             /* 桔梗淺色 - 用於懸停效果 */
  --kikyo-dark: #4A3D5C;              /* 桔梗深色 - 用於強調 */
  --kikyo-ultra-light: #F5F3F8;       /* 桔梗極淺色 - 用於背景 */
  
  /* 🎭 輔助色彩 */
  --accent-gold: #D4AF37;             /* 金色 - 用於重點裝飾 */
  --accent-cream: #FFF8DC;            /* 奶油色 - 溫暖背景 */
  --accent-lavender: #E6E0F0;         /* 薰衣草色 - 柔和背景 */
  
  /* 📝 文字顏色 */
  --text-primary: #2D2D2D;            /* 主要文字 - 深灰色 */
  --text-secondary: #666666;          /* 次要文字 - 中灰色 */
  --text-light: #FFFFFF;              /* 淺色文字 - 白色 */
  --text-muted: #999999;              /* 淡化文字 - 淺灰色 */
  
  /* 🏠 背景顏色 */
  --bg-main: linear-gradient(135deg, #F8F6FB 0%, #EDE7F6 100%);  /* 主背景漸層 */
  --bg-card: #FFFFFF;                 /* 卡片背景 */
  --bg-hover: #F0EDF5;                /* 懸停背景 */
  --bg-active: var(--kikyo-ultra-light); /* 活動背景 */
  
  /* 📅 日曆專用色彩 */
  --calendar-header-bg: var(--kikyo-primary);     /* 日曆表頭背景 */
  --calendar-header-text: var(--text-light);      /* 日曆表頭文字 */
  --calendar-content-odd: #FFFFFF;                 /* 日曆奇數行背景 */
  --calendar-content-even: var(--accent-cream);   /* 日曆偶數行背景 */
  --calendar-border: #E0D4E8;                     /* 日曆邊框 */
  
  /* ⏰ 時間標籤顏色 */
  --time-major: var(--text-primary);             /* 整點時間文字 */
  --time-minor: var(--text-muted);               /* 15/45分時間文字 */
  
  /* 🎫 事件卡片顏色 */
  --event-default-bg: var(--kikyo-primary);      /* 預設事件背景 */
  --event-default-text: var(--text-light);       /* 預設事件文字 */
  --event-blocked-bg: #E74C3C;                   /* 不約時段背景 */
  --event-blocked-text: var(--text-light);       /* 不約時段文字 */
  
  /* 👥 設計師專屬顏色 */
  --stylist-1-bg: #3498DB;                       /* 店長 - 藍色 */
  --stylist-1-text: var(--text-light);
  --stylist-2-bg: #9B59B6;                       /* 雅婷 - 紫色 */
  --stylist-2-text: var(--text-light);
  --stylist-3-bg: #E91E63;                       /* 小白 - 粉色 */
  --stylist-3-text: var(--text-light);
  
  /* 🔘 按鈕顏色 */
  --button-primary-bg: var(--kikyo-primary);     /* 主要按鈕背景 */
  --button-primary-text: var(--text-light);      /* 主要按鈕文字 */
  --button-secondary-bg: var(--bg-card);         /* 次要按鈕背景 */
  --button-secondary-text: var(--text-primary);  /* 次要按鈕文字 */
  --button-border: var(--calendar-border);       /* 按鈕邊框 */
  
  /* 🪟 彈窗顏色 */
  --modal-overlay: rgba(93, 78, 117, 0.6);       /* 彈窗遮罩 */
  --modal-bg: var(--bg-card);                    /* 彈窗背景 */
  --modal-border: var(--calendar-border);        /* 彈窗邊框 */
  
  /* 💬 留言區顏色 */
  --notes-bg: var(--bg-card);                    /* 留言區背景 */
  --notes-border: var(--calendar-border);        /* 留言區邊框 */
  --notes-shadow: 0 4px 12px rgba(93, 78, 117, 0.1); /* 留言區陰影 */
  
  /* 📏 尺寸設定 */
  --border-radius: 12px;                         /* 圓角大小 */
  --border-radius-small: 8px;                    /* 小圓角 */
  --shadow-soft: 0 2px 8px rgba(93, 78, 117, 0.1); /* 柔和陰影 */
  --shadow-medium: 0 4px 16px rgba(93, 78, 117, 0.15); /* 中等陰影 */
}

/* ==================== 🌐 基礎樣式設定 ==================== */
html, body {
  margin: 0; 
  padding: 0;
  /* 使用 Google Fonts 的 Noto Sans TC 字體，提供更好的中文顯示效果 */
  font-family: 'Noto Sans TC', 'Microsoft JhengHei', '微軟正黑體', Arial, sans-serif;
  font-size: 14px;
  font-weight: 400;
  height: auto;
  overflow-x: hidden;
  overflow-y: auto;
  color: var(--text-primary);
  background: var(--bg-main);
  line-height: 1.6;
  /* 平滑滾動效果 */
  scroll-behavior: smooth;
}

/* 日曆容器樣式 - 佔滿螢幕寬度 */
#calendar-container {
  position: relative;
  width: 100%;
  padding: 5px 20px;
  padding-bottom: 10px;
  max-width: none;
  margin: 0;
}

/* 日曆主體樣式 */
#calendar {
  width: 100% !important;
  max-width: none;
  margin: 0;
  height: auto !important;
  background: var(--bg-card);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow-medium);
  overflow: hidden;
}

/* 修正 FullCalendar 的滾動設定 */
.fc .fc-scroller {
    overflow-y: visible !important;
    height: auto !important;
}

.fc-view-harness {
    height: auto !important;
}

/* ==================== 🪟 彈窗樣式 ==================== */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  inset: 0;
  overflow: auto;
  background: var(--modal-overlay);
  /* 彈窗出現動畫 */
  backdrop-filter: blur(4px);
}

.modal-content {
  background: var(--modal-bg);
  margin: 5% auto;
  padding: 30px;
  border: 1px solid var(--modal-border);
  width: 90%;
  max-width: 500px;
  border-radius: var(--border-radius);
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow-medium);
  /* 彈窗內容動畫 */
  transform: translateY(-20px);
  animation: modalSlideIn 0.3s ease-out forwards;
}

@keyframes modalSlideIn {
  to {
    transform: translateY(0);
  }
}

/* 關閉按鈕樣式 */
.close-button {
  color: var(--text-muted);
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  transition: color 0.3s ease;
  line-height: 1;
}

.close-button:hover,
.close-button:focus {
  color: var(--kikyo-primary);
  transform: scale(1.1);
}

/* 表單樣式 */
#appointmentForm h3 {
  color: var(--kikyo-primary);
  font-weight: 500;
  margin-bottom: 20px;
  font-size: 20px;
}

#appointmentForm label {
  margin-top: 15px;
  display: block;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 5px;
}

#appointmentForm input,
#appointmentForm select,
#appointmentForm textarea {
  width: 100%;
  padding: 12px;
  margin-top: 4px;
  border: 2px solid var(--calendar-border);
  border-radius: var(--border-radius-small);
  box-sizing: border-box;
  font-family: inherit;
  font-size: 14px;
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

#appointmentForm input:focus,
#appointmentForm select:focus,
#appointmentForm textarea:focus {
  outline: none;
  border-color: var(--kikyo-primary);
  box-shadow: 0 0 0 3px rgba(93, 78, 117, 0.1);
}

/* 預約類型選擇區域 */
.appointment-type-section {
  margin: 20px 0;
  padding: 15px;
  border: 2px solid var(--calendar-border);
  border-radius: var(--border-radius-small);
  background: var(--bg-active);
}

.appointment-type-section label {
  margin-top: 0 !important;
  margin-bottom: 10px;
  font-weight: 500;
  color: var(--kikyo-primary);
}

.radio-group {
  display: flex;
  gap: 20px;
  margin-top: 8px;
}

.radio-group input[type="radio"] {
  width: auto !important;
  margin-right: 8px;
  accent-color: var(--kikyo-primary);
}

.radio-group label {
  margin-top: 0 !important;
  font-weight: normal !important;
  display: flex;
  align-items: center;
  color: var(--text-primary);
  cursor: pointer;
  transition: color 0.3s ease;
}

.radio-group label:hover {
  color: var(--kikyo-primary);
}

/* 提交按鈕樣式 */
#submit-btn {
  background: linear-gradient(135deg, var(--kikyo-primary) 0%, var(--kikyo-light) 100%);
  color: var(--button-primary-text);
  border: none;
  padding: 12px 24px;
  border-radius: var(--border-radius-small);
  cursor: pointer;
  font-weight: 500;
  font-size: 16px;
  transition: all 0.3s ease;
  box-shadow: var(--shadow-soft);
}

#submit-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-medium);
}

#submit-btn:active {
  transform: translateY(0);
}

/* ==================== 📅 FullCalendar 工具列樣式 ==================== */
#calendar .fc-header-toolbar {
    display: flex;
    align-items: center;
    gap: 1rem;
    background: var(--calendar-header-bg);
    padding: 15px 20px;
    margin-bottom: 0 !important;
    border-radius: var(--border-radius) var(--border-radius) 0 0;
}

#calendar .fc-toolbar-chunk {
  display: flex;
  align-items: center;
  gap: 0.8rem;
}

#calendar .fc-toolbar-title {
  display: flex;
  align-items: center;
  color: var(--calendar-header-text);
  font-weight: 500;
  font-size: 18px;
}

#calendar .fc-toolbar-chunk .fc-button {
  color: var(--calendar-header-text);
}

/* 工具列按鈕樣式 */
.fc-button {
  background-color: rgba(255, 255, 255, 0.2) !important;
  border: 1px solid rgba(255, 255, 255, 0.3) !important;
  color: var(--text-light) !important;
  height: 36px;
  border-radius: var(--border-radius-small) !important;
  font-weight: 400;
  transition: all 0.3s ease;
}

.fc-button:hover {
  background-color: rgba(255, 255, 255, 0.3) !important;
  transform: translateY(-1px);
}

.fc-button:focus {
  box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3) !important;
}

/* ==================== 📋 日曆表頭樣式 ==================== */
#calendar .fc-col-header {
    height: 50px;
    background: var(--bg-card);
    border-bottom: 2px solid var(--calendar-border);
}

#calendar .fc-col-header-cell {
  height: 100%;
  padding: 0 !important;
}

#calendar .fc-col-header-cell .fc-scrollgrid-sync-inner {
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

#calendar .fc-col-header-cell-cushion {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  padding: 0 !important;
  line-height: 1 !important;
  font-size: 18px;
  font-weight: 500;
  color: var(--kikyo-primary);
}

/* 避免表頭出現垂直滾動條 */
#calendar .fc-scrollgrid-section-header .fc-scroller {
  overflow-y: hidden !important;
}

#calendar .fc-scrollgrid {
  border-top: 1px solid var(--calendar-border);
}

/* ==================== 📊 日曆內容區樣式 ==================== */
/* 移除內容表格的多餘邊距 */
#calendar .fc-timegrid-slots table {
  margin: 0 !important;
  height: auto !important;
  padding: 0 !important;
  box-sizing: border-box !important;
}

/* 統一每格的行高 */
#calendar .fc-timegrid-slot,
#calendar .fc-timegrid-slot.fc-timegrid-slot-label {
  height: 2.5em !important;
}

/* 清除預設背景色 */
#calendar .fc-timegrid-slot-lane {
  background-color: transparent !important;
}

/* 內容區交錯背景色 */
#calendar .fc-timegrid-slots tbody tr:nth-child(odd) td.fc-timegrid-slot-lane {
  background: var(--calendar-content-odd) !important;
}

#calendar .fc-timegrid-slots tbody tr:nth-child(even) td.fc-timegrid-slot-lane {
  background: var(--calendar-content-even) !important;
}

/* ==================== ⏰ 時間標籤樣式 ==================== */
/* 整點和半點時間標籤 */
#calendar .fc-timegrid-slot-label.slot-major-0030 .fc-timegrid-slot-label-cushion {
    font-size: 14px !important;
    font-weight: 600 !important;
    color: var(--time-major) !important;
}

/* 15分和45分時間標籤 */
#calendar .fc-timegrid-slot.fc-minor .fc-timegrid-slot-label .fc-timegrid-slot-label-cushion {
    font-size: 12px !important;
    font-weight: 400 !important;
    color: var(--time-minor) !important;
}

/* 所有時間標籤的基礎樣式 */
#calendar .fc-timegrid-slot-label .fc-timegrid-slot-label-cushion {
  font-size: 14px;
  font-weight: 400;
  color: var(--text-primary);
}

/* ==================== 🎫 事件卡片樣式 ==================== */
/* 事件容器 - 固定寬度50% */
#calendar .fc-timegrid-event-harness {
  width: calc(50% - 6px) !important;
  margin: 0 3px !important;
  padding: 0 !important;
  box-sizing: border-box;
}

/* 事件卡片本體 */
#calendar .fc-timegrid-event {
  width: 100% !important;
  min-width: 0 !important;
  height: 2.7em !important;
  min-height: 0 !important;
  overflow: hidden;
  border-radius: var(--border-radius-small);
  box-shadow: var(--shadow-soft);
  transition: all 0.3s ease;
}

#calendar .fc-timegrid-event:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-medium);
}

/* 事件文字樣式 */
#calendar .fc-timegrid-event .fc-event-title {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  padding: 0 8px;
  font-size: 13px;
  font-weight: 400;
  line-height: 1.3;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  letter-spacing: 0.3px;
}

/* 不約時段特殊樣式 */
#calendar .fc-event.blocked-time {
  background: var(--event-blocked-bg) !important;
  border-color: var(--event-blocked-bg) !important;
  color: var(--event-blocked-text) !important;
  opacity: 0.9;
}

/* ==================== 👥 設計師專屬顏色 ==================== */
#calendar .fc-event.sty-1 {
  background: var(--stylist-1-bg);
  border-color: var(--stylist-1-bg);
  color: var(--stylist-1-text);
}

#calendar .fc-event.sty-2 {
  background: var(--stylist-2-bg);
  border-color: var(--stylist-2-bg);
  color: var(--stylist-2-text);
}

#calendar .fc-event.sty-3 {
  background: var(--stylist-3-bg);
  border-color: var(--stylist-3-bg);
  color: var(--stylist-3-text);
}

/* 不約時段強制覆蓋設計師顏色 */
#calendar .fc-event.blocked-time {
  background-color: var(--event-blocked-bg) !important;
  border-color: var(--event-blocked-bg) !important;
  color: var(--event-blocked-text) !important;
}

/* ==================== 📱 手機版響應式設計 ==================== */
@media (max-width: 768px) {
  #calendar-container {
    padding: 10px;
  }
  
  #calendar {
    width: 100vw !important;
    margin: 0 -10px;
    border-radius: 0;
  }
  
  .modal-content {
    width: 95%;
    margin: 2% auto;
    padding: 20px;
  }
  
  #calendar .fc-timegrid-event {
    min-height: 1.8em !important;
    max-height: 2.2em !important;
  }
  
  #calendar .fc-timegrid-event .fc-event-title {
    font-size: 12px;
    line-height: 1.2;
    padding: 0 6px;
  }
  
  #calendar .fc-header-toolbar {
    flex-wrap: nowrap;
    justify-content: space-between;
    padding: 10px 15px;
  }
  
  .fc-button {
    font-size: 0.75em;
    padding: 0.3em 0.6em;
    line-height: 1;
  }
}

/* ==================== 🔗 日曆欄位分隔線 ==================== */
/* 在每個設計師欄位右側添加分隔線 */
#calendar .fc-timegrid-body .fc-timegrid-col {
  position: relative;
}

#calendar .fc-timegrid-body .fc-timegrid-col:not(:last-child)::after {
  content: "";
  position: absolute;
  top: 0;
  bottom: 0;
  right: 0;
  width: 1px;
  background: var(--calendar-border);
  pointer-events: none;
  z-index: 100;
}

/* ==================== 💬 留言區全新設計 ==================== */
#notes-section {
    width: 100%;
    max-width: none;
    margin: 10px 0;
    padding: 0 15px;
}

.notes-container {
    background: var(--notes-bg);
    border: 2px solid var(--notes-border);
    border-radius: var(--border-radius);
    padding: 25px;
    box-shadow: var(--notes-shadow);
    transition: all 0.3s ease;
}

.notes-container:hover {
    box-shadow: var(--shadow-medium);
    transform: translateY(-2px);
}

.notes-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--calendar-border);
}

.notes-header h4 {
    margin: 0;
    color: var(--kikyo-primary);
    font-size: 20px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 10px;
}

.notes-header h4::before {
    content: "💭";
    font-size: 24px;
}

.notes-meta {
    margin-left: auto;
    color: var(--text-muted);
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.notes-meta::before {
    content: "💾";
    font-size: 14px;
}

#notes-content {
    width: 100%;
    min-height: 200px;
    padding: 20px;
    box-sizing: border-box;
    border: 2px solid var(--calendar-border);
    border-radius: var(--border-radius-small);
    font-size: 14px;
    line-height: 1.6;
    font-family: inherit;
    background: var(--bg-card);
    color: var(--text-primary);
    resize: vertical;
    transition: all 0.3s ease;
}

#notes-content:focus {
    outline: none;
    border-color: var(--kikyo-primary);
    box-shadow: 0 0 0 3px rgba(93, 78, 117, 0.1);
    background: var(--bg-active);
}

#notes-content::placeholder {
    color: var(--text-muted);
    font-style: italic;
}

/* 留言區響應式設計 */
@media (max-width: 768px) {
    #notes-section {
        padding: 0 10px;
        margin: 20px auto;
    }
    
    .notes-container {
        padding: 20px;
    }
    
    .notes-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .notes-meta {
        margin-left: 0;
    }
    
    #notes-content {
        min-height: 150px;
        padding: 15px;
    }
}

/* ==================== ✨ 額外的視覺增強效果 ==================== */
/* 平滑的載入動畫 */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

#calendar-container {
  animation: fadeInUp 0.6s ease-out;
}

#notes-section {
  animation: fadeInUp 0.8s ease-out;
}

/* 選擇文字時的顏色 */
::selection {
  background-color: var(--kikyo-light);
  color: var(--text-light);
}

::-moz-selection {
  background-color: var(--kikyo-light);
  color: var(--text-light);
}

/* 滾動條美化 */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: var(--bg-active);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: var(--kikyo-light);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--kikyo-primary);
}

</style>

</head>
<body>
    <!-- 日曆主容器 -->
    <div id="calendar-container">
        <div id="calendar"></div>

        <!-- 預約彈窗 -->
        <div id="appointmentModal" class="modal">
          <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>✨ 新增預約</h3>
            <form id="appointmentForm">
              <!-- 隱藏欄位：開始時間和員工ID -->
              <input type="hidden" id="start_time" name="start_time">
              <input type="hidden" id="employee_id" name="employee_id">

              <!-- 開始分鐘選擇 -->
              <label for="minute_select">🕐 開始分鐘</label>
              <select id="minute_select"></select>

              <!-- 預約類型選擇 -->
              <div class="appointment-type-section">
                <label>📋 預約類型</label>
                <div class="radio-group">
                  <label>
                    <input type="radio" name="appointment_type" value="normal" checked>
                    ✅ 一般預約
                  </label>
                  <label>
                    <input type="radio" name="appointment_type" value="blocked">
                    🚫 不約時段
                  </label>
                </div>
              </div>

              <!-- 客戶資訊欄位 -->
              <div id="customer-fields">
                <label for="customer_phone">📞 顧客電話</label>
                <input type="tel" id="customer_phone" name="customer_phone" placeholder="請輸入電話號碼">

                <label for="customer_name">👤 顧客姓名</label>
                <input type="text" id="customer_name" name="customer_name" placeholder="請輸入顧客姓名">

                <label for="service_id">💇 服務項目 (可選)</label>
                <select id="service_id" name="service_id">
                  <option value="">-- 請選擇服務 (可不選) --</option>
                  <option value="剪髮">✂️ 剪髮</option>
                  <option value="剪+染">✂️🎨 剪+染</option>
                  <option value="剪+燙">✂️🌀 剪+燙</option>
                  <option value="剪+染+燙">✂️🎨🌀 剪+染+燙</option>
                  <option value="剪+頭皮護理">✂️💆 剪+頭皮護理</option>
                </select>
              </div>

              <!-- 備註欄位 -->
              <label for="notes">📝 備註</label>
              <textarea id="notes" name="notes" rows="3" placeholder="請輸入備註資訊..."></textarea>

              <!-- 提交按鈕 -->
              <div style="margin-top: 20px; text-align: right;">
  <input type="hidden" id="edit_id">
  <button type="button" id="primaryBtn">💾 儲存預約</button>
  <button type="button" id="deleteBtn" style="display:none">🗑️ 刪除預約</button>
</div>
            </form>
          </div>
        </div>
    </div>

    <!-- 全新設計的留言區 -->
    <div id="notes-section">
        <div class="notes-container">
            <div class="notes-header">
                <h4>留言板</h4>
                <div class="notes-meta">
                    <span>自動儲存</span>
                </div>
            </div>
            <textarea id="notes-content" placeholder="💭 在此輸入您的筆記、想法或重要提醒...

✨ 小提示：
• 這裡的內容會自動儲存到瀏覽器
• 可以記錄客戶的特殊需求
• 或是店內的重要事項提醒"></textarea>
        </div>
    </div>

    <!-- FullCalendar JavaScript 檔案 -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.11.5/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/locales/zh-tw.js"></script>

    <script>
    // 🔗 Google Apps Script Web App URL (後端 API 端點)
    const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzC2kGwWTsAB4I8Z0VjeNTZPugoAUFZw3_4MMCDR_1SD1gIvCVW-VwExNtmaVLXU11xaA/exec';
    
    // 🚀 主要 JavaScript 程式碼區域
    (function(){
      // 📅 等待 DOM 載入完成後執行
      document.addEventListener('DOMContentLoaded', function(){
        // 🔍 取得頁面元素
        var modal = document.getElementById('appointmentModal');
        var form = document.getElementById('appointmentForm');
        var closeButton = document.querySelector('.close-button');
        var calendarEl = document.getElementById('calendar');
        var customerFields = document.getElementById('customer-fields');
        var primaryBtn = document.getElementById('primaryBtn');
        var deleteBtn = document.getElementById('deleteBtn');
        var editIdInput = document.getElementById('edit_id');
        var notesTextarea = document.getElementById('notes-content');
        function setCreateMode(){
          editIdInput.value = '';
          primaryBtn.textContent = '💾 儲存預約';
          deleteBtn.style.display = 'none';
        }
        function setEditMode(id){
          editIdInput.value = id;
          primaryBtn.textContent = '✅ 更新預約';
          deleteBtn.style.display = 'inline-flex';
        }


        // 💾 從 localStorage 載入儲存的留言內容
        const savedNotes = localStorage.getItem('userNotes');
        if (savedNotes) {
            notesTextarea.value = savedNotes;
        }

        // 💾 當留言內容變動時，自動儲存到 localStorage
        notesTextarea.addEventListener('input', function() {
            localStorage.setItem('userNotes', notesTextarea.value);
            // 🎯 更新儲存狀態提示
            const metaElement = document.querySelector('.notes-meta span');
            metaElement.textContent = '已儲存 ✓';
            setTimeout(() => {
                metaElement.textContent = '自動儲存';
            }, 2000);
        });

        // 🔧 修正兩個重疊事件的顯示問題
        function fixTwoEvents() {
          // 🎯 檢查兩個元素是否重疊
          function overlap(a, b) {
            const r1 = a.getBoundingClientRect();
            const r2 = b.getBoundingClientRect();
            return r1.top < r2.bottom && r2.top < r1.bottom;
          }

          // 🔄 處理每個日曆欄位
          document.querySelectorAll('#calendar .fc-timegrid-col').forEach(col => {
            const harnesses = Array.from(col.querySelectorAll('.fc-timegrid-event-harness'));

            // 🧹 清除舊的樣式設定
            harnesses.forEach(h => { 
              h.classList.remove('two-evt'); 
              h.style.width = ''; 
            });

            // 🔍 找到 left:50% 的事件，配對同時段的 left:0% 事件
            harnesses.forEach(h => {
              const s = (h.getAttribute('style') || '').replace(/\s+/g, '');
              if (s.includes('left:50%')) {
                const partner = harnesses.find(p => {
                  if (p === h) return false;
                  const sp = (p.getAttribute('style') || '').replace(/\s+/g, '');
                  return sp.includes('left:0%') && overlap(p, h);
                });
                if (partner) {
                  // 🎨 設定兩個事件的寬度為各50%
                  h.style.width = 'calc(50% - 4px)';
                  partner.style.width = 'calc(50% - 4px)';
                  h.classList.add('two-evt');
                  partner.classList.add('two-evt');
                }
              }
            });
          });
        }

        // 🔄 預約類型切換邏輯
        var appointmentTypeRadios = document.querySelectorAll('input[name="appointment_type"]');
        appointmentTypeRadios.forEach(function(radio) {
          radio.addEventListener('change', function() {
            if (this.value === 'blocked') {
              // 🚫 不約時段：隱藏客戶資訊欄位
              customerFields.style.display = 'none';
              primaryBtn.innerHTML = '🚫 設定不約時段';
              document.getElementById('notes').placeholder = '請輸入不約原因 (例如：設計師請假、店內會議等)';
            } else {
              // ✅ 一般預約：顯示客戶資訊欄位
              customerFields.style.display = 'block';
              primaryBtn.innerHTML = '💾 儲存預約';
              document.getElementById('notes').placeholder = '請輸入備註資訊...';
            }
          });
        });
        
        // 🪟 開啟預約彈窗的函數
        function openApptModal(startDate, resourceId) {
          if (!resourceId) return;
          
          // 🔄 重置表單
          form.reset();
          
          
          setCreateMode();
// 🎯 預設選擇一般預約
          document.querySelector('input[name="appointment_type"][value="normal"]').checked = true;
          customerFields.style.display = 'block';
          primaryBtn.innerHTML = '💾 儲存預約';
          document.getElementById('notes').placeholder = '請輸入備註資訊...';

          // 📝 設定員工ID
          document.getElementById('employee_id').value = resourceId;

          // --- BEGIN: 「開始分鐘」下拉選單邏輯 (已包含修正) ---
          const minuteSelect = document.getElementById('minute_select');
          minuteSelect.innerHTML = '';

          // 使用 Intl.DateTimeFormat 確保取得的是 'Asia/Taipei' 時區的小時和分鐘
          const options = { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Asia/Taipei' };
          const formattedTime = new Intl.DateTimeFormat('zh-TW', options).format(startDate);
          const [calendarHourStr, calendarMinuteStr] = formattedTime.split(':');
          const baseHour = parseInt(calendarHourStr, 10);
          const baseMin = parseInt(calendarMinuteStr, 10);

          // 產生三個選項 (以5分鐘為間隔)，從點擊的 15 分鐘區間開始
          for (let i = 0; i < 3; i++) { 
            const currentMinute = baseMin + (i * 5); 
            
            const opt = document.createElement('option');
            opt.value = currentMinute; 
            opt.textContent = String(currentMinute).padStart(2, '0'); // 只顯示分鐘，不顯示小時
            
            // 預選點擊的確切開始時間（即第一個選項）
            if (i === 0) {
              opt.selected = true;
            }
            
            minuteSelect.appendChild(opt);
          }
          
          // 用於設定 hidden input #start_time 的基礎日期部分
          const year = startDate.getFullYear();
          const month = String(startDate.getMonth() + 1).padStart(2, '0');
          const day = String(startDate.getDate()).padStart(2, '0');

          // 函數用於根據下拉選單選擇的值更新隱藏的 start_time
          function updateHiddenStartTime() {
              const selectedMinute = minuteSelect.value;
              const composedHour = String(baseHour).padStart(2, '0'); // 使用時區校正過的小時
              document.getElementById('start_time').value = `${year}-${month}-${day}T${composedHour}:${String(selectedMinute).padStart(2, '0')}:00`;
          }
          
          // 初始設定 hidden input 的值
          updateHiddenStartTime();
          // 當下拉選單改變時，更新 hidden input 的值
          minuteSelect.onchange = updateHiddenStartTime;
          // --- END: 「開始分鐘」下拉選單邏輯 ---
          
          // 🪟 顯示彈窗
          modal.style.display = 'block';
        }

        // 📅 初始化 FullCalendar
        var calendar = new FullCalendar.Calendar(calendarEl, {
          // --- BEGIN: 修正 Scheduler 授權金鑰 ---
          schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source', // 添加此行以移除開發期間的授權訊息
          // --- END: 修正 Scheduler 授權金鑰 ---

          // 🌏 基本設定
          locale: 'zh-tw',
          timeZone: 'Asia/Taipei',
          initialView: 'resourceTimeGridDay',
          
          // 🎛️ 工具列設定
          headerToolbar: { 
            left: 'prev,next today', 
            center: 'title', 
            right: 'resourceTimeGridDay,resourceTimeGridWeek' 
          },
          
          // ⏰ 時間設定
          allDaySlot: false,                    // 不顯示全天事件欄
          slotMinTime: '12:00:00',             // 最早時間 12:00
          slotMaxTime: '21:00:00',             // 最晚時間 21:00
          slotDuration: '00:15:00',            // 每格15分鐘
          slotLabelInterval: '00:15:00',       // 時間標籤間隔15分鐘
          slotLabelFormat: { 
            hour:'2-digit', 
            minute:'2-digit', 
            hour12:false 
          },
          
          // 🎨 顯示設定
          displayEventTime: false,             // 不在事件上顯示時間
          height: 'auto',                      // 自動高度
          expandRows: false,                   // 不展開行
          handleWindowResize: true,            // 處理視窗大小變化
          
          // 👆 互動設定
          longPressDelay: 250,                 // 長按延遲
          selectLongPressDelay: 250,           // 選擇長按延遲
          selectMirror: true,                  // 選擇時顯示鏡像

          // 🏷️ 時間標籤樣式設定
          slotLabelDidMount: function (arg) {
            const m = arg.date.getMinutes();
            // 🎯 為整點和半點添加特殊樣式類別
            arg.el.classList.toggle('slot-major-0030', m === 0 || m === 30);
            arg.el.classList.toggle('slot-minor-1545', m === 15 || m === 45);
          },

          // 🎨 視圖載入後的樣式調整
          viewDidMount: function () {
            // 🔧 修正重疊事件顯示
            fixTwoEvents();
          },
          
          // 👆 點擊日期時開啟預約彈窗
          dateClick: function(info) {
            openApptModal(info.date, info.resource ? info.resource.id : null);
          },

          // 🎫 事件載入後的處理
          eventDidMount: function(info) {
            // 🏷️ 設定事件的 tooltip
            info.el.setAttribute("title", info.event.title);
            
            // 🚫 為不約時段添加特殊樣式
            if (info.event.extendedProps && info.event.extendedProps.status === 'blocked') {
              info.el.classList.add('blocked-time');
            }
            
            // 🔧 修正重疊事件顯示
            fixTwoEvents();
          },

          // 🎨 根據設計師設定事件樣式類別
          eventClassNames: function(arg) {
            const r = arg.event.getResources()[0];
            return r ? ['sty-' + r.id] : [];
          },

          // 📝 自訂事件內容顯示格式
          eventContent: function(arg) {
            const event = arg.event;
            const extendedProps = event.extendedProps;
            let contentText = '';

            // ⏰ 格式化開始時間 (確保使用日曆的時區)
            const startTime = event.start ? event.start.toLocaleTimeString('zh-TW', { 
              hour: '2-digit', 
              minute: '2-digit', 
              hour12: false,
              timeZone: 'Asia/Taipei' // 確保時間顯示與日曆時區一致
            }) : '';

            if (extendedProps && extendedProps.status === 'blocked') {
              // 🚫 不約時段的顯示格式
              contentText = `🚫 ${startTime} ${event.title || '不約時段'}`;
            } else {
              // ✅ 一般預約的顯示格式
              const service = extendedProps.service_id || '';
              const customerName = extendedProps.customer_name || '無姓名';
              const customerPhone = extendedProps.customer_phone || '無電話';
              
              // 🎯 根據服務項目組裝顯示字串
              let serviceDisplay = service ? ` ${service}` : '';
              contentText = `${startTime}${serviceDisplay} ${customerName} ${customerPhone}`;
            }

            return { html: `<div class='fc-event-title'>${contentText}</div>` };
          },
          
          // 🚫 禁用事件編輯功能
          editable: false,
          eventDurationEditable: false,

          // 👆 點擊事件時的處理 (刪除確認)
          eventClick: function(info){
            setEditMode(info.event.id);
            var ep = info.event.extendedProps || {};
            document.getElementById('customer_phone').value = ep.customer_phone || '';
            document.getElementById('customer_name').value  = ep.customer_name  || '';
            document.getElementById('service_id').value    = ep.service_id    || '';
            document.getElementById('notes').value         = ep.notes         || '';
            if (ep.status === 'blocked') {
              document.querySelector('input[name="appointment_type"][value="blocked"]').checked = true;
              document.getElementById('customer-fields').style.display = 'none';
              document.getElementById('notes').placeholder = '請輸入「不約時段」說明，例如：店內會議等';
            } else {
              document.querySelector('input[name="appointment_type"][value="normal"]').checked = true;
              document.getElementById('customer-fields').style.display = 'block';
              document.getElementById('notes').placeholder = '請輸入備註資訊...';
            }
            document.getElementById('appointmentModal').style.display = 'block';

              fetch(APPS_SCRIPT_WEB_APP_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ action: "delete", id: info.event.id })
})
.then(r => r.json())
.then(res => {
  if (res.status === "success") info.view.calendar.refetchEvents();
  else alert("刪除失敗");
})
.catch(() => alert("刪除失敗"));

          },

          // 🔄 拖拽事件時的處理
          

          // 📏 調整事件大小時的處理
          

          // 👥 設計師資源設定
          resources: [
            { 
              id: '1', 
              title: ' 店長', 
              eventColor: '#3498DB', 
              eventTextColor: '#ffffff' 
            },
            { 
              id: '2', 
              title: '雅婷', 
              eventColor: '#9B59B6', 
              eventTextColor: '#ffffff' 
            },
            { 
              id: '3', 
              title: '小白', 
              eventColor: '#E91E63', 
              eventTextColor: '#ffffff' 
            }
          ],

          // 📊 事件資料來源 URL
          events: `${APPS_SCRIPT_WEB_APP_URL}?action=get`,

          // 👆 選擇功能設定
          selectable: true,
          select: function (info) {
            openApptModal(info.start, info.resource ? info.resource.id : null);
          },
        });

        // 🚀 渲染日曆
        calendar.render();
        
        // 🔧 初始修正重疊事件
        fixTwoEvents();
        
        // 🪟 關閉彈窗的事件處理
        closeButton.onclick = function(){ 
          modal.style.display = 'none'; 
        };
        
        window.onclick = function(e){ 
          if(e.target === modal) modal.style.display = 'none'; 
        };

        
        // 🔘 按鈕行為：新增或更新
        primaryBtn.onclick = function(){
          var id = editIdInput.value.trim();
          if (!id){
            // 新增：沿用原本 submit 流程
            document.getElementById('appointmentForm').requestSubmit();
            return;
          }
          // 更新：只送需要的欄位
          var payload = {
            action: 'edit',
            id: id,
            customer_phone: document.getElementById('customer_phone').value.trim(),
            customer_name:  document.getElementById('customer_name').value.trim(),
            service_id:     document.getElementById('service_id').value.trim(),
            notes:          document.getElementById('notes').value.trim(),
            appointment_type: document.querySelector('input[name="appointment_type"]:checked').value
          };
          fetch(APPS_SCRIPT_WEB_APP_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          })
          .then(r=>r.json())
          .then(res=>{
            if (res.status === 'success') { document.getElementById('appointmentModal').style.display='none'; calendar.refetchEvents(); }
            else alert('更新失敗');
          })
          .catch(()=>alert('更新失敗'));
        };

        // 🗑️ 刪除
        deleteBtn.onclick = function(){
          var id = editIdInput.value.trim();
          if (!id) return;
          if (!confirm('確定刪除這筆預約？')) return;
          fetch(APPS_SCRIPT_WEB_APP_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action:'delete', id })
          })
          .then(r=>r.json())
          .then(res=>{
            if (res.status === 'success') { document.getElementById('appointmentModal').style.display='none'; calendar.refetchEvents(); }
            else alert('刪除失敗');
          })
          .catch(()=>alert('刪除失敗'));
        };
// 📝 表單提交處理
        form.addEventListener('submit', function(e){
          e.preventDefault();
          var fd = new FormData(form);
          
          // 🎯 根據預約類型進行不同的驗證
          var appointmentType = document.querySelector('input[name="appointment_type"]:checked').value;
          
          if (appointmentType === 'normal') {
            // ✅ 一般預約：檢查客戶資訊
            var customerName = fd.get('customer_name');
            var customerPhone = fd.get('customer_phone');
            
            if (!customerName && !customerPhone) {
              alert('⚠️ 請至少填寫客戶姓名或電話');
              return;
            }
          } else {
            // 🚫 不約時段：清空客戶相關欄位
            fd.set('customer_name', '');
            fd.set('customer_phone', '');
            fd.set('service_id', '');
          }
          
          // 📝 添加預約類型到表單資料
          fd.append('appointment_type', appointmentType);
          
          // 🚀 提交表單到後端
          fetch(APPS_SCRIPT_WEB_APP_URL, { 
            method:'POST', 
            body: fd 
          })
          .then(r => r.json())
          .then(data => {
            if (data.status === 'success') {
              // ✅ 成功：關閉彈窗並重新載入事件
              modal.style.display = 'none';
              calendar.refetchEvents();
            } else {
              // ❌ 失敗：顯示錯誤訊息
              alert('❌ 錯誤: ' + (data.message || '未知錯誤'));
            }
          })
          .catch(err => { 
            console.error(err); 
            alert('❌ 提交失敗，請檢查網路連線'); 
          });
        });
      });
    })();
    </script>
</body>
</html>