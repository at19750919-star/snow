<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸–ç´€é«®å»Š  æ™¯ç¾åº—</title>
    
    <!-- FullCalendar ç›¸é—œ CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.11.5/main.min.css">
    
    <!-- Google Fonts - å„ªé›…çš„ä¸­æ–‡å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
<style>
/* ==================== ğŸ¨ æ¡”æ¢—ä¸»é¡Œé…è‰²è¨­å®šå€ ==================== */
/* æ‰€æœ‰é¡è‰²éƒ½é›†ä¸­åœ¨é€™è£¡ ï¼Œæ–¹ä¾¿çµ±ä¸€èª¿æ•´ */
:root {
  /* ğŸŒ¸ ä¸»è¦æ¡”æ¢—è‰²ç³» */
  --kikyo-primary: #5D4E75;           /* æ¡”æ¢—ä¸»è‰² - å„ªé›…ç´«è‰² */
  --kikyo-light: #8B7CA3;             /* æ¡”æ¢—æ·ºè‰² - ç”¨æ–¼æ‡¸åœæ•ˆæœ */
  --kikyo-dark: #4A3D5C;              /* æ¡”æ¢—æ·±è‰² - ç”¨æ–¼å¼·èª¿ */
  --kikyo-ultra-light: #F5F3F8;       /* æ¡”æ¢—æ¥µæ·ºè‰² - ç”¨æ–¼èƒŒæ™¯ */
  
  /* ğŸ­ è¼”åŠ©è‰²å½© */
  --accent-gold: #D4AF37;             /* é‡‘è‰² - ç”¨æ–¼é‡é»è£é£¾ */
  --accent-cream: #FFF8DC;            /* å¥¶æ²¹è‰² - æº«æš–èƒŒæ™¯ */
  --accent-lavender: #E6E0F0;         /* è–°è¡£è‰è‰² - æŸ”å’ŒèƒŒæ™¯ */
  
  /* ğŸ“ æ–‡å­—é¡è‰² */
  --text-primary: #2D2D2D;            /* ä¸»è¦æ–‡å­— - æ·±ç°è‰² */
  --text-secondary: #666666;          /* æ¬¡è¦æ–‡å­— - ä¸­ç°è‰² */
  --text-light: #FFFFFF;              /* æ·ºè‰²æ–‡å­— - ç™½è‰² */
  --text-muted: #999999;              /* æ·¡åŒ–æ–‡å­— - æ·ºç°è‰² */
  
  /* ğŸ  èƒŒæ™¯é¡è‰² */
  --bg-main: linear-gradient(135deg, #F8F6FB 0%, #EDE7F6 100%);  /* ä¸»èƒŒæ™¯æ¼¸å±¤ */
  --bg-card: #FFFFFF;                 /* å¡ç‰‡èƒŒæ™¯ */
  --bg-hover: #F0EDF5;                /* æ‡¸åœèƒŒæ™¯ */
  --bg-active: var(--kikyo-ultra-light); /* æ´»å‹•èƒŒæ™¯ */
  
  /* ğŸ“… æ—¥æ›†å°ˆç”¨è‰²å½© */
  --calendar-header-bg: var(--kikyo-primary);     /* æ—¥æ›†è¡¨é ­èƒŒæ™¯ */
  --calendar-header-text: var(--text-light);      /* æ—¥æ›†è¡¨é ­æ–‡å­— */
  --calendar-content-odd: #FFFFFF;                 /* æ—¥æ›†å¥‡æ•¸è¡ŒèƒŒæ™¯ */
  --calendar-content-even: var(--accent-cream);   /* æ—¥æ›†å¶æ•¸è¡ŒèƒŒæ™¯ */
  --calendar-border: #E0D4E8;                     /* æ—¥æ›†é‚Šæ¡† */
  
  /* â° æ™‚é–“æ¨™ç±¤é¡è‰² */
  --time-major: var(--text-primary);             /* æ•´é»æ™‚é–“æ–‡å­— */
  --time-minor: var(--text-muted);               /* 15/45åˆ†æ™‚é–“æ–‡å­— */
  
  /* ğŸ« äº‹ä»¶å¡ç‰‡é¡è‰² */
  --event-default-bg: var(--kikyo-primary);      /* é è¨­äº‹ä»¶èƒŒæ™¯ */
  --event-default-text: var(--text-light);       /* é è¨­äº‹ä»¶æ–‡å­— */
  --event-blocked-bg: #CC6341;                   /* ä¸ç´„æ™‚æ®µèƒŒæ™¯ */
  --event-blocked-text: var(--text-light);       /* ä¸ç´„æ™‚æ®µæ–‡å­— */
  
  /* ğŸ‘¥ è¨­è¨ˆå¸«å°ˆå±¬é¡è‰² (å·²æ›´æ–°) */
  --stylist-1-bg: #958BCB;                       /* åº—é•·  */
  --stylist-1-text: var(--text-light);
  --stylist-2-bg: #C47BB4;                       /* é›…å©·  */
  --stylist-2-text: var(--text-light);
  --stylist-3-bg: #69689F;                       /* å°ç™½  */
  --stylist-3-text: var(--text-light);
  
  /* ğŸ”˜ æŒ‰éˆ•é¡è‰² */
  --button-primary-bg: var(--kikyo-primary);     /* ä¸»è¦æŒ‰éˆ•èƒŒæ™¯ */
  --button-primary-text: var(--text-light);      /* ä¸»è¦æŒ‰éˆ•æ–‡å­— */
  --button-secondary-bg: var(--bg-card);         /* æ¬¡è¦æŒ‰éˆ•èƒŒæ™¯ */
  --button-secondary-text: var(--text-primary);  /* æ¬¡è¦æŒ‰éˆ•æ–‡å­— */
  --button-border: var(--calendar-border);       /* æŒ‰éˆ•é‚Šæ¡† */
  
  /* ğŸªŸ å½ˆçª—é¡è‰² */
  --modal-overlay: rgba(93, 78, 117, 0.6);       /* å½ˆçª—é®ç½© */
  --modal-bg: var(--bg-card);                    /* å½ˆçª—èƒŒæ™¯ */
  --modal-border: var(--calendar-border);        /* å½ˆçª—é‚Šæ¡† */
  
  /* ğŸ’¬ ç•™è¨€å€é¡è‰² */
  --notes-bg: var(--bg-card);                    /* ç•™è¨€å€èƒŒæ™¯ */
  --notes-border: var(--calendar-border);        /* ç•™è¨€å€é‚Šæ¡† */
  --notes-shadow: 0 4px 12px rgba(93, 78, 117, 0.1); /* ç•™è¨€å€é™°å½± */
  
  /* ğŸ“ å°ºå¯¸è¨­å®š */
  --border-radius: 12px;                         /* åœ“è§’å¤§å° */
  --border-radius-small: 8px;                    /* å°åœ“è§’ */
  --shadow-soft: 0 2px 8px rgba(93, 78, 117, 0.1); /* æŸ”å’Œé™°å½± */
  --shadow-medium: 0 4px 16px rgba(93, 78, 117, 0.15); /* ä¸­ç­‰é™°å½± */
}

/* ==================== ğŸŒ åŸºç¤æ¨£å¼è¨­å®š ==================== */
html, body {
  margin: 0; 
  padding: 0;
  /* ä½¿ç”¨ Google Fonts çš„ Noto Sans TC å­—é«”ï¼Œæä¾›æ›´å¥½çš„ä¸­æ–‡é¡¯ç¤ºæ•ˆæœ */
  font-family: 'Noto Sans TC', 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', Arial, sans-serif;
  font-size: 14px;
  font-weight: 400;
  height: auto;
  overflow-x: hidden;
  overflow-y: auto;
  color: var(--text-primary);
  background: var(--bg-main);
  line-height: 1.6;
  /* å¹³æ»‘æ»¾å‹•æ•ˆæœ */
  scroll-behavior: smooth;
}

/* æ—¥æ›†å®¹å™¨æ¨£å¼ - ä½”æ»¿è¢å¹•å¯¬åº¦ */
#calendar-container {
  position: relative;
  width: 100%;
  padding: 5px 20px;
  padding-bottom: 10px;
  max-width: none;
  margin: 0;
}

/* æ—¥æ›†ä¸»é«”æ¨£å¼ */
#calendar {
  width: 100% !important;
  max-width: none;
  margin: 0;
  height: auto !important;
  background: var(--bg-card);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow-medium);
  overflow: hidden;
}

/* ä¿®æ­£ FullCalendar çš„æ»¾å‹•è¨­å®š */
.fc .fc-scroller {
    overflow-y: visible !important;
    height: auto !important;
}

.fc-view-harness {
    height: auto !important;
}

/* ==================== ğŸªŸ å½ˆçª—æ¨£å¼ ==================== */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  inset: 0;
  overflow: auto;
  background: var(--modal-overlay);
  /* å½ˆçª—å‡ºç¾å‹•ç•« */
  backdrop-filter: blur(4px);
}

.modal-content {
  background: var(--modal-bg);
  margin: 5% auto;
  padding: 30px;
  border: 1px solid var(--modal-border);
  width: 90%;
  max-width: 500px;
  border-radius: var(--border-radius);
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow-medium);
  /* å½ˆçª—å…§å®¹å‹•ç•« */
  transform: translateY(-20px);
  animation: modalSlideIn 0.3s ease-out forwards;
}

@keyframes modalSlideIn {
  to {
    transform: translateY(0);
  }
}

/* é—œé–‰æŒ‰éˆ•æ¨£å¼ */
.close-button {
  color: var(--text-muted);
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  transition: color 0.3s ease;
  line-height: 1;
}

.close-button:hover,
.close-button:focus {
  color: var(--kikyo-primary);
  transform: scale(1.1);
}

/* è¡¨å–®æ¨£å¼ */
#appointmentForm h3 {
  color: var(--kikyo-primary);
  font-weight: 500;
  margin-bottom: 20px;
  font-size: 20px;
}

#appointmentForm label {
  margin-top: 15px;
  display: block;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 5px;
}

#appointmentForm input,
#appointmentForm select,
#appointmentForm textarea {
  width: 100%;
  padding: 12px;
  margin-top: 4px;
  border: 2px solid var(--calendar-border);
  border-radius: var(--border-radius-small);
  box-sizing: border-box;
  font-family: inherit;
  font-size: 14px;
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

#appointmentForm input:focus,
#appointmentForm select:focus,
#appointmentForm textarea:focus {
  outline: none;
  border-color: var(--kikyo-primary);
  box-shadow: 0 0 0 3px rgba(93, 78, 117, 0.1);
}

/* é ç´„é¡å‹é¸æ“‡å€åŸŸ */
.appointment-type-section {
  margin: 20px 0;
  padding: 15px;
  border: 2px solid var(--calendar-border);
  border-radius: var(--border-radius-small);
  background: var(--bg-active);
}

.appointment-type-section label {
  margin-top: 0 !important;
  margin-bottom: 10px;
  font-weight: 500;
  color: var(--kikyo-primary);
}

.radio-group {
  display: flex;
  gap: 20px;
  margin-top: 8px;
}

.radio-group input[type="radio"] {
  width: auto !important;
  margin-right: 8px;
  accent-color: var(--kikyo-primary);
}

.radio-group label {
  margin-top: 0 !important;
  font-weight: normal !important;
  display: flex;
  align-items: center;
  color: var(--text-primary);
  cursor: pointer;
  transition: color 0.3s ease;
}

.radio-group label:hover {
  color: var(--kikyo-primary);
}

/* æäº¤æŒ‰éˆ•æ¨£å¼ */
#submit-btn, #deleteBtn {
  color: var(--button-primary-text);
  border: none;
  padding: 12px 24px;
  border-radius: var(--border-radius-small);
  cursor: pointer;
  font-weight: 500;
  font-size: 16px;
  transition: all 0.3s ease;
  box-shadow: var(--shadow-soft);
}

#submit-btn {
  background: linear-gradient(135deg, var(--kikyo-primary) 0%, var(--kikyo-light) 100%);
}

#submit-btn:hover, #deleteBtn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-medium);
}

#submit-btn:active, #deleteBtn:active {
  transform: translateY(0);
}

#deleteBtn {
    background: #C0392B;
}
#deleteBtn:hover {
    background: #E74C3C;
}

/* ==================== ğŸ“… FullCalendar å·¥å…·åˆ—æ¨£å¼ ==================== */
#calendar .fc-header-toolbar {
    display: flex;
    align-items: center;
    gap: 1rem;
    background: var(--calendar-header-bg);
    padding: 15px 20px;
    margin-bottom: 0 !important;
    border-radius: var(--border-radius) var(--border-radius) 0 0;
}

#calendar .fc-toolbar-chunk {
  display: flex;
  align-items: center;
  gap: 0.8rem;
}

#calendar .fc-toolbar-title {
  display: flex;
  align-items: center;
  color: var(--calendar-header-text);
  font-weight: 500;
  font-size: 18px;
}

#calendar .fc-toolbar-chunk .fc-button {
  color: var(--calendar-header-text);
}

/* å·¥å…·åˆ—æŒ‰éˆ•æ¨£å¼ */
.fc-button {
  background-color: rgba(255, 255, 255, 0.2) !important;
  border: 1px solid rgba(255, 255, 255, 0.3) !important;
  color: var(--text-light) !important;
  height: 36px;
  border-radius: var(--border-radius-small) !important;
  font-weight: 400;
  transition: all 0.3s ease;
}

.fc-button:hover {
  background-color: rgba(255, 255, 255, 0.3) !important;
  transform: translateY(-1px);
}

.fc-button:focus {
  box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3) !important;
}

/* ==================== ğŸ“‹ æ—¥æ›†è¡¨é ­æ¨£å¼ ==================== */
#calendar .fc-col-header {
    height: 50px;
    background: var(--bg-card);
    border-bottom: 2px solid var(--calendar-border);
}

#calendar .fc-col-header-cell {
  height: 100%;
  padding: 0 !important;
}

#calendar .fc-col-header-cell .fc-scrollgrid-sync-inner {
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

#calendar .fc-col-header-cell-cushion {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  padding: 0 !important;
  line-height: 1 !important;
  font-size: 18px;
  font-weight: 500;
  color: var(--kikyo-primary);
}

/* é¿å…è¡¨é ­å‡ºç¾å‚ç›´æ»¾å‹•æ¢ */
#calendar .fc-scrollgrid-section-header .fc-scroller {
  overflow-y: hidden !important;
}

#calendar .fc-scrollgrid {
  border-top: 1px solid var(--calendar-border);
}

/* ==================== ğŸ“Š æ—¥æ›†å…§å®¹å€æ¨£å¼ ==================== */
/* ç§»é™¤å…§å®¹è¡¨æ ¼çš„å¤šé¤˜é‚Šè· */
#calendar .fc-timegrid-slots table {
  margin: 0 !important;
  height: auto !important;
  padding: 0 !important;
  box-sizing: border-box !important;
}

/* çµ±ä¸€æ¯æ ¼çš„è¡Œé«˜ */
#calendar .fc-timegrid-slot,
#calendar .fc-timegrid-slot.fc-timegrid-slot-label {
  height: 2.5em !important;
}

/* æ¸…é™¤é è¨­èƒŒæ™¯è‰² */
#calendar .fc-timegrid-slot-lane {
  background-color: transparent !important;
}

/* å…§å®¹å€äº¤éŒ¯èƒŒæ™¯è‰² */
#calendar .fc-timegrid-slots tbody tr:nth-child(odd) td.fc-timegrid-slot-lane {
  background: var(--calendar-content-odd) !important;
}

#calendar .fc-timegrid-slots tbody tr:nth-child(even) td.fc-timegrid-slot-lane {
  background: var(--calendar-content-even) !important;
}

/* ==================== â° æ™‚é–“æ¨™ç±¤æ¨£å¼ ==================== */
/* æ•´é»å’ŒåŠé»æ™‚é–“æ¨™ç±¤ */
#calendar .fc-timegrid-slot-label.slot-major-0030 .fc-timegrid-slot-label-cushion {
    font-size: 14px !important;
    font-weight: 600 !important;
    color: var(--time-major) !important;
}

/* 15åˆ†å’Œ45åˆ†æ™‚é–“æ¨™ç±¤ */
#calendar .fc-timegrid-slot.fc-minor .fc-timegrid-slot-label .fc-timegrid-slot-label-cushion {
    font-size: 12px !important;
    font-weight: 400 !important;
    color: var(--time-minor) !important;
}

/* æ‰€æœ‰æ™‚é–“æ¨™ç±¤çš„åŸºç¤æ¨£å¼ */
#calendar .fc-timegrid-slot-label .fc-timegrid-slot-label-cushion {
  font-size: 14px;
  font-weight: 400;
  color: var(--text-primary);
}

/* ==================== ğŸ« äº‹ä»¶å¡ç‰‡æ¨£å¼ ==================== */
/* äº‹ä»¶å®¹å™¨ - å›ºå®šå¯¬åº¦50% */
#calendar .fc-timegrid-event-harness {
  width: calc(50% - 6px) !important;
  margin: 0 3px !important;
  padding: 0 !important;
  box-sizing: border-box;
}

/* äº‹ä»¶å¡ç‰‡æœ¬é«” */
#calendar .fc-timegrid-event {
  width: 100% !important;
  min-width: 0 !important;
  height: 2.7em !important;
  min-height: 0 !important;
  overflow: hidden;
  border-radius: var(--border-radius-small);
  box-shadow: var(--shadow-soft);
  transition: all 0.3s ease;
}

#calendar .fc-timegrid-event:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-medium);
}

/* äº‹ä»¶æ–‡å­—æ¨£å¼ */
#calendar .fc-timegrid-event .fc-event-title {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  padding: 0 8px;
  font-size: 13px;
  font-weight: 400;
  line-height: 1.3;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  letter-spacing: 0.3px;
}

/* ä¸ç´„æ™‚æ®µç‰¹æ®Šæ¨£å¼ */
#calendar .fc-event.blocked-time {
  background: var(--event-blocked-bg) !important;
  border-color: var(--event-blocked-bg) !important;
  color: var(--event-blocked-text) !important;
  opacity: 0.9;
}

/* ==================== ğŸ‘¥ è¨­è¨ˆå¸«å°ˆå±¬é¡è‰² ==================== */
#calendar .fc-event.sty-1 {
  background: var(--stylist-1-bg);
  border-color: var(--stylist-1-bg);
  color: var(--stylist-1-text);
}

#calendar .fc-event.sty-2 {
  background: var(--stylist-2-bg);
  border-color: var(--stylist-2-bg);
  color: var(--stylist-2-text);
}

#calendar .fc-event.sty-3 {
  background: var(--stylist-3-bg);
  border-color: var(--stylist-3-bg);
  color: var(--stylist-3-text);
}

/* ä¸ç´„æ™‚æ®µå¼·åˆ¶è¦†è“‹è¨­è¨ˆå¸«é¡è‰² */
#calendar .fc-event.blocked-time {
  background-color: var(--event-blocked-bg) !important;
  border-color: var(--event-blocked-bg) !important;
  color: var(--event-blocked-text) !important;
}

/* ==================== ğŸ“± æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼è¨­è¨ˆ ==================== */
@media (max-width: 768px) {
  #calendar-container {
    padding: 10px;
  }
  
  #calendar {
    width: 100vw !important;
    margin: 0 -10px;
    border-radius: 0;
  }
  
  .modal-content {
    width: 95%;
    margin: 2% auto;
    padding: 20px;
  }
  
  #calendar .fc-timegrid-event {
    min-height: 1.8em !important;
    max-height: 2.2em !important;
  }
  
  #calendar .fc-timegrid-event .fc-event-title {
    font-size: 12px;
    line-height: 1.2;
    padding: 0 6px;
  }
  
  #calendar .fc-header-toolbar {
    flex-wrap: nowrap;
    justify-content: space-between;
    padding: 10px 15px;
  }
  
  .fc-button {
    font-size: 0.75em;
    padding: 0.3em 0.6em;
    line-height: 1;
  }
}

/* ==================== ğŸ”— æ—¥æ›†æ¬„ä½åˆ†éš”ç·š ==================== */
/* åœ¨æ¯å€‹è¨­è¨ˆå¸«æ¬„ä½å³å´æ·»åŠ åˆ†éš”ç·š */
#calendar .fc-timegrid-body .fc-timegrid-col {
  position: relative;
}

#calendar .fc-timegrid-body .fc-timegrid-col:not(:last-child)::after {
  content: "";
  position: absolute;
  top: 0;
  bottom: 0;
  right: 0;
  width: 1px;
  background: var(--calendar-border);
  pointer-events: none;
  z-index: 100;
}

/* ==================== ğŸ’¬ ç•™è¨€å€å…¨æ–°è¨­è¨ˆ ==================== */
#notes-section {
    width: 100%;
    max-width: none;
    margin: 10px 0;
    padding: 0 15px;
}

.notes-container {
    background: var(--notes-bg);
    border: 2px solid var(--notes-border);
    border-radius: var(--border-radius);
    padding: 25px;
    box-shadow: var(--notes-shadow);
    transition: all 0.3s ease;
}

.notes-container:hover {
    box-shadow: var(--shadow-medium);
    transform: translateY(-2px);
}

.notes-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--calendar-border);
}

.notes-header h4 {
    margin: 0;
    color: var(--kikyo-primary);
    font-size: 20px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 10px;
}

.notes-header h4::before {
    content: "ğŸ’­";
    font-size: 24px;
}

.notes-meta {
    margin-left: auto;
    color: var(--text-muted);
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.notes-meta::before {
    content: "ğŸ’¾";
    font-size: 14px;
}

#notes-content {
    width: 100%;
    min-height: 200px;
    padding: 20px;
    box-sizing: border-box;
    border: 2px solid var(--calendar-border);
    border-radius: var(--border-radius-small);
    font-size: 14px;
    line-height: 1.6;
    font-family: inherit;
    background: var(--bg-card);
    color: var(--text-primary);
    resize: vertical;
    transition: all 0.3s ease;
}

#notes-content:focus {
    outline: none;
    border-color: var(--kikyo-primary);
    box-shadow: 0 0 0 3px rgba(93, 78, 117, 0.1);
    background: var(--bg-active);
}

#notes-content::placeholder {
    color: var(--text-muted);
    font-style: italic;
}

/* ç•™è¨€å€éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
    #notes-section {
        padding: 0 10px;
        margin: 20px auto;
    }
    
    .notes-container {
        padding: 20px;
    }
    
    .notes-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .notes-meta {
        margin-left: 0;
    }
    
    #notes-content {
        min-height: 150px;
        padding: 15px;
    }
}

/* ==================== âœ¨ é¡å¤–çš„è¦–è¦ºå¢å¼·æ•ˆæœ ==================== */
/* å¹³æ»‘çš„è¼‰å…¥å‹•ç•« */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

#calendar-container {
  animation: fadeInUp 0.6s ease-out;
}

#notes-section {
  animation: fadeInUp 0.8s ease-out;
}

/* é¸æ“‡æ–‡å­—æ™‚çš„é¡è‰² */
::selection {
  background-color: var(--kikyo-light);
  color: var(--text-light);
}

::-moz-selection {
  background-color: var(--kikyo-light);
  color: var(--text-light);
}

/* æ»¾å‹•æ¢ç¾åŒ– */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: var(--bg-active);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: var(--kikyo-light);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--kikyo-primary);
}
</style>

</head>
<body>
    <!-- æ—¥æ›†ä¸»å®¹å™¨ -->
    <div id="calendar-container">
        <div id="calendar"></div>

        <!-- é ç´„å½ˆçª— -->
        <div id="appointmentModal" class="modal">
          <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>âœ¨ æ–°å¢/ç·¨è¼¯é ç´„</h3>
            <form id="appointmentForm">
              <!-- éš±è—æ¬„ä½ï¼šäº‹ä»¶ID, é–‹å§‹æ™‚é–“, å“¡å·¥ID -->
              <input type="hidden" id="event_id" name="event_id">
              <input type="hidden" id="start_time" name="start_time">
              <input type="hidden" id="employee_id" name="employee_id">

              <!-- é–‹å§‹åˆ†é˜é¸æ“‡ -->
              <label for="minute_select">ğŸ• é–‹å§‹åˆ†é˜</label>
              <select id="minute_select" name="minute_select"></select>

              <!-- é ç´„é¡å‹é¸æ“‡ -->
              <div class="appointment-type-section">
                <label>ğŸ“‹ é ç´„é¡å‹</label>
                <div class="radio-group">
                  <label>
                    <input type="radio" name="appointment_type" value="normal" checked>
                    âœ… ä¸€èˆ¬é ç´„
                  </label>
                  <label>
                    <input type="radio" name="appointment_type" value="blocked">
                    ğŸš« ä¸ç´„æ™‚æ®µ
                  </label>
                </div>
              </div>

              <!-- å®¢æˆ¶è³‡è¨Šæ¬„ä½ -->
              <div id="customer-fields">
                <label for="customer_phone">ğŸ“ é¡§å®¢é›»è©±</label>
                <input type="tel" id="customer_phone" name="customer_phone" placeholder="è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼">

                <label for="customer_name">ğŸ‘¤ é¡§å®¢å§“å</label>
                <input type="text" id="customer_name" name="customer_name" placeholder="è«‹è¼¸å…¥é¡§å®¢å§“å">

                <label for="service_id">ğŸ’‡ æœå‹™é …ç›® (å¯é¸)</label>
                <select id="service_id" name="service_id">
                  <option value="">-- è«‹é¸æ“‡æœå‹™ (å¯ä¸é¸) --</option>
                  <option value="å‰ªé«®">âœ‚ï¸ å‰ªé«®</option>
                  <option value="å‰ª+æŸ“">âœ‚ï¸ğŸ¨ å‰ª+æŸ“</option>
                  <option value="å‰ª+ç‡™">âœ‚ï¸ğŸŒ€ å‰ª+ç‡™</option>
                  <option value="å‰ª+æŸ“+ç‡™">âœ‚ï¸ğŸ¨ğŸŒ€ å‰ª+æŸ“+ç‡™</option>
                  <option value="å‰ª+é ­çš®è­·ç†">âœ‚ï¸ğŸ’† å‰ª+é ­çš®è­·ç†</option>
                </select>
              </div>

              <!-- å‚™è¨»æ¬„ä½ -->
              <label for="notes">ğŸ“ å‚™è¨»</label>
              <textarea id="notes" name="notes" rows="3" placeholder="è«‹è¼¸å…¥å‚™è¨»è³‡è¨Š..."></textarea>

              <!-- æäº¤æŒ‰éˆ• -->
              <div style="margin-top: 20px; text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
                <button type="button" id="deleteBtn" style="display:none;">ğŸ—‘ï¸ åˆªé™¤é ç´„</button>
                <button type="submit" id="submit-btn">ğŸ’¾ å„²å­˜é ç´„</button>
              </div>
            </form>
          </div>
        </div>
    </div>

    <!-- å…¨æ–°è¨­è¨ˆçš„ç•™è¨€å€ -->
    <div id="notes-section">
        <div class="notes-container">
            <div class="notes-header">
                <h4>ç•™è¨€æ¿</h4>
                <div class="notes-meta">
                    <span>è‡ªå‹•å„²å­˜</span>
                </div>
            </div>
            <textarea id="notes-content" placeholder="ğŸ’­ åœ¨æ­¤è¼¸å…¥æ‚¨çš„ç­†è¨˜ã€æƒ³æ³•æˆ–é‡è¦æé†’...

âœ¨ å°æç¤ºï¼š
â€¢ é€™è£¡çš„å…§å®¹æœƒè‡ªå‹•å„²å­˜åˆ°ç€è¦½å™¨
â€¢ å¯ä»¥è¨˜éŒ„å®¢æˆ¶çš„ç‰¹æ®Šéœ€æ±‚
â€¢ æˆ–æ˜¯åº—å…§çš„é‡è¦äº‹é …æé†’"></textarea>
        </div>
    </div>

    <!-- FullCalendar JavaScript æª”æ¡ˆ -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.11.5/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/locales/zh-tw.js"></script>

    <script>
// ğŸ”— Google Apps Script Web App URL (å¾Œç«¯ API ç«¯é»)
const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxexZ8Bp2_VgIBN8Pj90LFVjd5SakuLZ6gIxHe1mYLj1KA2R5ZMP1MPznvDQngDJw7xLQ/exec';

// ğŸš€ ä¸»è¦ JavaScript ç¨‹å¼ç¢¼å€åŸŸ
(function( ){

      // ğŸ“… ç­‰å¾… DOM è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
      document.addEventListener('DOMContentLoaded', function(){
        // ğŸ” å–å¾—é é¢å…ƒç´ 
        var modal = document.getElementById('appointmentModal');
        var form = document.getElementById('appointmentForm');
        var closeButton = document.querySelector('.close-button');
        var calendarEl = document.getElementById('calendar');
        var customerFields = document.getElementById('customer-fields');
        var submitBtn = document.getElementById('submit-btn');
        var deleteBtn = document.getElementById('deleteBtn');
        var eventIdInput = document.getElementById('event_id');
        var notesTextarea = document.getElementById('notes-content');

        // ğŸ’¾ å¾ localStorage è¼‰å…¥å„²å­˜çš„ç•™è¨€å…§å®¹
        const savedNotes = localStorage.getItem('userNotes');
        if (savedNotes) {
            notesTextarea.value = savedNotes;
        }

        // ğŸ’¾ ç•¶ç•™è¨€å…§å®¹è®Šå‹•æ™‚ï¼Œè‡ªå‹•å„²å­˜åˆ° localStorage
        notesTextarea.addEventListener('input', function() {
            localStorage.setItem('userNotes', notesTextarea.value);
            // ğŸ¯ æ›´æ–°å„²å­˜ç‹€æ…‹æç¤º
            const metaElement = document.querySelector('.notes-meta span');
            metaElement.textContent = 'å·²å„²å­˜ âœ“';
            setTimeout(() => {
                metaElement.textContent = 'è‡ªå‹•å„²å­˜';
            }, 2000);
        });

        // ğŸ”§ ä¿®æ­£å…©å€‹é‡ç–Šäº‹ä»¶çš„é¡¯ç¤ºå•é¡Œ
        function fixTwoEvents() {
          // ğŸ¯ æª¢æŸ¥å…©å€‹å…ƒç´ æ˜¯å¦é‡ç–Š
          function overlap(a, b) {
            const r1 = a.getBoundingClientRect();
            const r2 = b.getBoundingClientRect();
            return r1.top < r2.bottom && r2.top < r1.bottom;
          }

          // ğŸ”„ è™•ç†æ¯å€‹æ—¥æ›†æ¬„ä½
          document.querySelectorAll('#calendar .fc-timegrid-col').forEach(col => {
            const harnesses = Array.from(col.querySelectorAll('.fc-timegrid-event-harness'));

            // ğŸ§¹ æ¸…é™¤èˆŠçš„æ¨£å¼è¨­å®š
            harnesses.forEach(h => { 
              h.classList.remove('two-evt'); 
              h.style.width = ''; 
            });

            // ğŸ” æ‰¾åˆ° left:50% çš„äº‹ä»¶ï¼Œé…å°åŒæ™‚æ®µçš„ left:0% äº‹ä»¶
            harnesses.forEach(h => {
              const s = (h.getAttribute('style') || '').replace(/\s+/g, '');
              if (s.includes('left:50%')) {
                const partner = harnesses.find(p => {
                  if (p === h) return false;
                  const sp = (p.getAttribute('style') || '').replace(/\s+/g, '');
                  return sp.includes('left:0%') && overlap(p, h);
                });
                if (partner) {
                  // ğŸ¨ è¨­å®šå…©å€‹äº‹ä»¶çš„å¯¬åº¦ç‚ºå„50%
                  h.style.width = 'calc(50% - 4px)';
                  partner.style.width = 'calc(50% - 4px)';
                  h.classList.add('two-evt');
                  partner.classList.add('two-evt');
                }
              }
            });
          });
        }

        // ğŸ”„ é ç´„é¡å‹åˆ‡æ›é‚è¼¯
        var appointmentTypeRadios = document.querySelectorAll('input[name="appointment_type"]');
        appointmentTypeRadios.forEach(function(radio) {
          radio.addEventListener('change', function() {
            const isBlocked = this.value === 'blocked';
            customerFields.style.display = isBlocked ? 'none' : 'block';
            document.getElementById('notes').placeholder = isBlocked 
                ? 'è«‹è¼¸å…¥ä¸ç´„åŸå›  (ä¾‹å¦‚ï¼šè¨­è¨ˆå¸«è«‹å‡ã€åº—å…§æœƒè­°ç­‰)' 
                : 'è«‹è¼¸å…¥å‚™è¨»è³‡è¨Š...';
            
            // æ›´æ–°æŒ‰éˆ•æ–‡å­—
            const isEditing = !!eventIdInput.value;
            if (isBlocked) {
                submitBtn.innerHTML = 'ğŸš« è¨­å®šä¸ç´„æ™‚æ®µ';
            } else {
                submitBtn.innerHTML = isEditing ? 'âœ… æ›´æ–°é ç´„' : 'ğŸ’¾ å„²å­˜é ç´„';
            }
          });
        });
        
        // ğŸªŸ é–‹å•Ÿé ç´„å½ˆçª—çš„å‡½æ•¸
        function openApptModal(startDate, resourceId) {
          if (!resourceId) return;
          
          // ğŸ”„ é‡ç½®è¡¨å–®
          form.reset();
          eventIdInput.value = ''; // ç¢ºä¿æ˜¯æ–°å¢æ¨¡å¼
          
          // ğŸ¨ è¨­å®šç‚ºæ–°å¢æ¨¡å¼çš„ UI
          submitBtn.innerHTML = 'ğŸ’¾ å„²å­˜é ç´„';
          deleteBtn.style.display = 'none';
          document.querySelector('input[name="appointment_type"][value="normal"]').checked = true;
          customerFields.style.display = 'block';
          document.getElementById('notes').placeholder = 'è«‹è¼¸å…¥å‚™è¨»è³‡è¨Š...';

          // ğŸ“ è¨­å®šå“¡å·¥ID
          document.getElementById('employee_id').value = resourceId;

          // --- BEGIN: ã€Œé–‹å§‹åˆ†é˜ã€ä¸‹æ‹‰é¸å–®é‚è¼¯ ---
          const minuteSelect = document.getElementById('minute_select');
          minuteSelect.innerHTML = '';

          const baseHour = startDate.getHours();
          const baseMin = startDate.getMinutes();

          // ç”¢ç”Ÿä¸‰å€‹é¸é … (ä»¥5åˆ†é˜ç‚ºé–“éš”)ï¼Œå¾é»æ“Šçš„ 15 åˆ†é˜å€é–“é–‹å§‹
          for (let i = 0; i < 3; i++) { 
            const currentMinute = baseMin + (i * 5); 
            const opt = document.createElement('option');
            opt.value = currentMinute; 
            opt.textContent = String(currentMinute).padStart(2, '0');
            if (i === 0) opt.selected = true;
            minuteSelect.appendChild(opt);
          }
          
          // åˆå§‹è¨­å®š hidden input çš„å€¼
          updateHiddenStartTime(startDate);
          // ç•¶ä¸‹æ‹‰é¸å–®æ”¹è®Šæ™‚ï¼Œæ›´æ–° hidden input çš„å€¼
          minuteSelect.onchange = () => updateHiddenStartTime(startDate);
          // --- END: ã€Œé–‹å§‹åˆ†é˜ã€ä¸‹æ‹‰é¸å–®é‚è¼¯ ---
          
          // ğŸªŸ é¡¯ç¤ºå½ˆçª—
          modal.style.display = 'block';
        }

        // ğŸ•’ æ›´æ–°éš±è—çš„ start_time æ¬„ä½å€¼ (åŒ…å«æ™‚å€ä¿®æ­£)
        function updateHiddenStartTime(baseDate) {
            const selectedMinute = document.getElementById('minute_select').value;
            const newDate = new Date(baseDate);
            newDate.setMinutes(parseInt(selectedMinute, 10));
            newDate.setSeconds(0);
            newDate.setMilliseconds(0);

            // ç”¢ç”ŸåŒ…å«æ™‚å€åç§»çš„ ISO 8601 å­—ä¸² (e.g., "2025-09-24T14:05:00+08:00")
            const timezoneOffset = -newDate.getTimezoneOffset();
            const diff = timezoneOffset >= 0 ? '+' : '-';
            const pad = (num) => (num < 10 ? '0' : '') + num;
            const isoString = newDate.getFullYear() +
                '-' + pad(newDate.getMonth() + 1) +
                '-' + pad(newDate.getDate()) +
                'T' + pad(newDate.getHours()) +
                ':' + pad(newDate.getMinutes()) +
                ':' + pad(newDate.getSeconds()) +
                diff + pad(Math.floor(Math.abs(timezoneOffset) / 60)) +
                ':' + pad(Math.abs(timezoneOffset) % 60);
            
            document.getElementById('start_time').value = isoString;
        }

        // ğŸ“… åˆå§‹åŒ– FullCalendar
        var calendar = new FullCalendar.Calendar(calendarEl, {
          // --- BEGIN: ä¿®æ­£ Scheduler æˆæ¬Šé‡‘é‘° ---
          schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source', // æ·»åŠ æ­¤è¡Œä»¥ç§»é™¤é–‹ç™¼æœŸé–“çš„æˆæ¬Šè¨Šæ¯
          // --- END: ä¿®æ­£ Scheduler æˆæ¬Šé‡‘é‘° ---

          // ğŸŒ åŸºæœ¬è¨­å®š
          locale: 'zh-tw',
          timeZone: 'Asia/Taipei',
          initialView: 'resourceTimeGridDay',
          
          // ğŸ›ï¸ å·¥å…·åˆ—è¨­å®š
          headerToolbar: { 
            left: 'prev,next today', 
            center: 'title', 
            right: 'resourceTimeGridDay,resourceTimeGridWeek' 
          },
          
          // â° æ™‚é–“è¨­å®š
          allDaySlot: false,                    // ä¸é¡¯ç¤ºå…¨å¤©äº‹ä»¶æ¬„
          slotMinTime: '12:00:00',             // æœ€æ—©æ™‚é–“ 12:00
          slotMaxTime: '21:00:00',             // æœ€æ™šæ™‚é–“ 21:00
          slotDuration: '00:15:00',            // æ¯æ ¼15åˆ†é˜
          slotLabelInterval: '00:15:00',       // æ™‚é–“æ¨™ç±¤é–“éš”15åˆ†é˜
          slotLabelFormat: { 
            hour:'2-digit', 
            minute:'2-digit', 
            hour12:false 
          },
          
          // ğŸ¨ é¡¯ç¤ºè¨­å®š
          displayEventTime: false,             // ä¸åœ¨äº‹ä»¶ä¸Šé¡¯ç¤ºæ™‚é–“
          height: 'auto',                      // è‡ªå‹•é«˜åº¦
          expandRows: false,                   // ä¸å±•é–‹è¡Œ
          handleWindowResize: true,            // è™•ç†è¦–çª—å¤§å°è®ŠåŒ–
          
          // ğŸ‘† äº’å‹•è¨­å®š
          longPressDelay: 250,                 // é•·æŒ‰å»¶é²
          selectLongPressDelay: 250,           // é¸æ“‡é•·æŒ‰å»¶é²
          selectMirror: true,                  // é¸æ“‡æ™‚é¡¯ç¤ºé¡åƒ

          // ğŸ·ï¸ æ™‚é–“æ¨™ç±¤æ¨£å¼è¨­å®š
          slotLabelDidMount: function (arg) {
            const m = arg.date.getMinutes();
            // ğŸ¯ ç‚ºæ•´é»å’ŒåŠé»æ·»åŠ ç‰¹æ®Šæ¨£å¼é¡åˆ¥
            arg.el.classList.toggle('slot-major-0030', m === 0 || m === 30);
            arg.el.classList.toggle('slot-minor-1545', m === 15 || m === 45);
          },

          // ğŸ¨ è¦–åœ–è¼‰å…¥å¾Œçš„æ¨£å¼èª¿æ•´
          viewDidMount: function () {
            // ğŸ”§ ä¿®æ­£é‡ç–Šäº‹ä»¶é¡¯ç¤º
            fixTwoEvents();
          },
          
          // ğŸ‘† é»æ“Šæ—¥æœŸæ™‚é–‹å•Ÿé ç´„å½ˆçª—
          dateClick: function(info) {
            openApptModal(info.date, info.resource ? info.resource.id : null);
          },

          // ğŸ« äº‹ä»¶è¼‰å…¥å¾Œçš„è™•ç†
          eventDidMount: function(info) {
            // ğŸ·ï¸ è¨­å®šäº‹ä»¶çš„ tooltip
            info.el.setAttribute("title", info.event.title);
            
            // ğŸš« ç‚ºä¸ç´„æ™‚æ®µæ·»åŠ ç‰¹æ®Šæ¨£å¼
            if (info.event.extendedProps && info.event.extendedProps.status === 'blocked') {
              info.el.classList.add('blocked-time');
            }
            
            // ğŸ”§ ä¿®æ­£é‡ç–Šäº‹ä»¶é¡¯ç¤º
            fixTwoEvents();
          },

          // ğŸ¨ æ ¹æ“šè¨­è¨ˆå¸«è¨­å®šäº‹ä»¶æ¨£å¼é¡åˆ¥
          eventClassNames: function(arg) {
            const r = arg.event.getResources()[0];
            return r ? ['sty-' + r.id] : [];
          },

          // ğŸ“ è‡ªè¨‚äº‹ä»¶å…§å®¹é¡¯ç¤ºæ ¼å¼
          eventContent: function(arg) {
            const event = arg.event;
            const extendedProps = event.extendedProps;
            let contentText = '';

            // â° æ ¼å¼åŒ–é–‹å§‹æ™‚é–“ (ç¢ºä¿ä½¿ç”¨æ—¥æ›†çš„æ™‚å€)
            const startTime = event.start ? event.start.toLocaleTimeString('zh-TW', { 
              hour: '2-digit', 
              minute: '2-digit', 
              hour12: false,
              timeZone: 'Asia/Taipei' // ç¢ºä¿æ™‚é–“é¡¯ç¤ºèˆ‡æ—¥æ›†æ™‚å€ä¸€è‡´
            }) : '';

            if (extendedProps && extendedProps.status === 'blocked') {
              // ğŸš« ä¸ç´„æ™‚æ®µçš„é¡¯ç¤ºæ ¼å¼
              contentText = `ğŸš« ${startTime} ${event.title || 'ä¸ç´„æ™‚æ®µ'}`;
            } else {
              // âœ… ä¸€èˆ¬é ç´„çš„é¡¯ç¤ºæ ¼å¼
              const service = extendedProps.service_id || '';
              const customerName = extendedProps.customer_name || 'ç„¡å§“å';
              const customerPhone = extendedProps.customer_phone || 'ç„¡é›»è©±';
              
              // ğŸ¯ æ ¹æ“šæœå‹™é …ç›®çµ„è£é¡¯ç¤ºå­—ä¸²
              let serviceDisplay = service ? ` ${service}` : '';
              contentText = `${startTime}${serviceDisplay} ${customerName} ${customerPhone}`;
            }

            return { html: `<div class='fc-event-title'>${contentText}</div>` };
          },
          
          // ğŸš« ç¦ç”¨äº‹ä»¶æ‹–æ›³ç·¨è¼¯åŠŸèƒ½
          editable: false,

          // ğŸ‘† é»æ“Šäº‹ä»¶æ™‚çš„è™•ç† (é–‹å•Ÿç·¨è¼¯å½ˆçª—)
          eventClick: function(info){
            form.reset();
            const event = info.event;
            const ep = event.extendedProps || {};

            // ğŸ¨ è¨­å®šç‚ºç·¨è¼¯æ¨¡å¼çš„ UI
            eventIdInput.value = event.id;
            deleteBtn.style.display = 'inline-block';

            // ğŸ“ å¡«å……è¡¨å–®è³‡æ–™
            document.getElementById('employee_id').value = event.getResources()[0]?.id || '';
            document.getElementById('customer_phone').value = ep.customer_phone || '';
            document.getElementById('customer_name').value  = ep.customer_name  || '';
            document.getElementById('service_id').value    = ep.service_id    || '';
            document.getElementById('notes').value         = ep.notes         || '';

            // è™•ç†é ç´„é¡å‹
            const isBlocked = ep.status === 'blocked';
            document.querySelector(`input[name="appointment_type"][value="${isBlocked ? 'blocked' : 'normal'}"]`).checked = true;
            customerFields.style.display = isBlocked ? 'none' : 'block';
            submitBtn.innerHTML = isBlocked ? 'ğŸš« æ›´æ–°ä¸ç´„æ™‚æ®µ' : 'âœ… æ›´æ–°é ç´„';
            
            // å¡«å……æ™‚é–“ç›¸é—œæ¬„ä½
            const startDate = event.start;
            const minuteSelect = document.getElementById('minute_select');
            minuteSelect.innerHTML = ''; // æ¸…ç©º
            const startMinute = startDate.getMinutes();
            
            // å»ºç«‹ 00, 05, 10... 55 çš„é¸é …
            for (let m = 0; m < 60; m += 5) {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = String(m).padStart(2, '0');
                if (m === startMinute) opt.selected = true;
                minuteSelect.appendChild(opt);
            }
            
            // æ›´æ–°éš±è—çš„ start_time
            updateHiddenStartTime(startDate);
            minuteSelect.onchange = () => updateHiddenStartTime(startDate);

            modal.style.display = 'block';
          },
          
          // ğŸ‘¥ è¨­è¨ˆå¸«è³‡æºè¨­å®š (å·²ç§»é™¤é¡è‰²ï¼Œç”± CSS æ§åˆ¶)
          resources: [
            { id: '1', title: 'åº—é•·' },
            { id: '2', title: 'é›…å©·' },
            { id: '3', title: 'å°ç™½' }
          ],

          // ğŸ“Š äº‹ä»¶è³‡æ–™ä¾†æº URL
          events: `${APPS_SCRIPT_WEB_APP_URL}?action=get`,

          // ğŸ‘† é¸æ“‡åŠŸèƒ½è¨­å®š
          selectable: true,
          select: function (info) {
            openApptModal(info.start, info.resource ? info.resource.id : null);
          },
        });

        // ğŸš€ æ¸²æŸ“æ—¥æ›†
        calendar.render();
        
        // ğŸ”§ åˆå§‹ä¿®æ­£é‡ç–Šäº‹ä»¶
        fixTwoEvents();
        
        // ğŸªŸ é—œé–‰å½ˆçª—çš„äº‹ä»¶è™•ç†
        closeButton.onclick = function(){ 
          modal.style.display = 'none'; 
        };
        
        window.onclick = function(e){ 
          if(e.target === modal) modal.style.display = 'none'; 
        };

        // ğŸ—‘ï¸ åˆªé™¤æŒ‰éˆ•äº‹ä»¶
        deleteBtn.onclick = function(){
          var eventId = eventIdInput.value.trim();
          if (!eventId) return;
          if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†é ç´„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;

          const payload = {
            action: 'delete',
            id: eventId
          };

        // âœ… ä¿®æ­£å¾Œçš„å¯«æ³•
fetch(APPS_SCRIPT_WEB_APP_URL, {
  method: 'POST',
  // ã€æ ¸å¿ƒä¿®æ­£ã€‘å°‡ Content-Type æ”¹ç‚º text/plainï¼Œç¹é CORS é æª¢
  headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
  body: JSON.stringify(payload) // body å…§å®¹ä¸è®Š
})
// ...

          .then(r => r.json())
          .then(res => {
            if (res.status === 'success') {
              modal.style.display = 'none';
              calendar.refetchEvents();
            } else {
              alert('âŒ åˆªé™¤å¤±æ•—: ' + (res.message || 'æœªçŸ¥éŒ¯èª¤'));
            }
          })
          .catch(err => {
            console.error('Delete Error:', err);
            alert('âŒ åˆªé™¤è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
          });
        };

        // ğŸ“ è¡¨å–®æäº¤è™•ç† (çµ±ä¸€è™•ç†æ–°å¢èˆ‡æ›´æ–°)
        form.addEventListener('submit', function(e){
          e.preventDefault();
          const formData = new FormData(form);
          const eventId = formData.get('event_id');
          const isEditing = !!eventId;

          // æ ¹æ“šé ç´„é¡å‹é€²è¡Œé©—è­‰
          const appointmentType = formData.get('appointment_type');
          if (appointmentType === 'normal') {
            if (!formData.get('customer_name') && !formData.get('customer_phone')) {
              alert('âš ï¸ è«‹è‡³å°‘å¡«å¯«å®¢æˆ¶å§“åæˆ–é›»è©±');
              return;
            }
          }

          // æº–å‚™è¦ç™¼é€çš„è³‡æ–™
          const payload = {
            action: isEditing ? 'edit' : 'create',
            id: eventId,
            employee_id: formData.get('employee_id'),
            start: formData.get('start_time'), // å·²åŒ…å«æ™‚å€è³‡è¨Š
            appointment_type: appointmentType,
            customer_name: formData.get('customer_name'),
            customer_phone: formData.get('customer_phone'),
            service_id: formData.get('service_id'),
            notes: formData.get('notes')
          };

          // âœ… ä¿®æ­£å¾Œçš„å¯«æ³•
fetch(APPS_SCRIPT_WEB_APP_URL, { 
  method:'POST',
  // ã€æ ¸å¿ƒä¿®æ­£ã€‘å°‡ Content-Type æ”¹ç‚º text/plainï¼Œç¹é CORS é æª¢
  headers: { 'Content-Type': 'text/plain;charset=utf-8' },
  body: JSON.stringify(payload) // body å…§å®¹ä¸è®Š
})
// ...

          .then(r => r.json())
          .then(data => {
            if (data.status === 'success') {
              // âœ… æˆåŠŸï¼šé—œé–‰å½ˆçª—ä¸¦é‡æ–°è¼‰å…¥äº‹ä»¶
              modal.style.display = 'none';
              calendar.refetchEvents();
            } else {
              // âŒ å¤±æ•—ï¼šé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
              alert('âŒ éŒ¯èª¤: ' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
            }
          })
          .catch(err => { 
            console.error('Submit Error:', err); 
            alert('âŒ æäº¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š'); 
          });
        });
      });
    })();
    </script>
</body>
</html>    
