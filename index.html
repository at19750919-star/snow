<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸–ç´€é«®å»Š  æ™¯ç¾åº—</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.11.5/main.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
<style>
/* ==================== ğŸ¨ ä¸»é¡Œé…è‰²è¨­å®šï¼ˆå¯èª¿æ•´æ•´ç«™é¢¨æ ¼ï¼‰ ==================== */
:root {
  /* å“ç‰Œä¸»è‰²ç³»ï¼ˆä¸»è¦/è¼ƒäº®/è¼ƒæ·±/æ¥µæ·ºèƒŒæ™¯ï¼‰ */
  --kikyo-primary: #5D4E75;      /* ä¸»è¦è‰²ï¼Œç”¨åœ¨æ¨™é¡Œåˆ—ã€é‡é»æŒ‰éˆ• */
  --kikyo-light:   #8B7CA3;      /* è¼ƒäº®é»ç¶´ */
  --kikyo-dark:    #4A3D5C;      /* è¼ƒæ·±å°æ¯” */
  --kikyo-ultra-light: #F5F3F8;  /* è¶…æ·ºåº•è‰²ï¼ˆå€å¡ŠèƒŒæ™¯ï¼‰ */

  /* è¼”åŠ©è‰²ï¼ˆå¡ç‰‡åº•/é–“éš”ç”¨ï¼Œå¯è‡ªè¡Œæ›¿æ›ï¼‰ */
  --accent-gold:     #D4AF37;
  --accent-cream:    #f8f4fc;    /* æ™‚æ®µå¶æ•¸åˆ—èƒŒæ™¯ */
  --accent-lavender: #E6E0F0;

  /* æ–‡å­—è‰²ç³» */
  --text-primary:   #352e38;     /* ä¸»è¦æ–‡å­— */
  --text-secondary: #666666;     /* æ¬¡è¦æ–‡å­— */
  --text-light:     #FFFFFF;     /* æ·±åº•ä¸Šçš„ç™½å­— */
  --text-muted:     #999999;     /* è¨»è§£/ç°å­— */

  /* å…¨ç«™èƒŒæ™¯èˆ‡å¡ç‰‡ */
  --bg-main:  linear-gradient(135deg, #F8F6FB 0%, #EDE7F6 100%);
  --bg-card:  #FFFFFF;
  --bg-hover: #F0EDF5;
  --bg-active: var(--kikyo-ultra-light);

  /* è¡Œäº‹æ›†æ¡†ç·š/è¡¨é ­/æ™‚æ®µæ¨™ç±¤ */
  --calendar-header-bg:   var(--kikyo-primary);
  --calendar-header-text: var(--text-light);
  --calendar-content-odd:  #FFFFFF;
  --calendar-content-even: var(--accent-cream);
  --calendar-border:       #E0D4E8;
  --time-major: var(--text-primary); /* 00/30 åˆ† */
  --time-minor: var(--text-muted);   /* 15/45 åˆ† */


  /* æŒ‰éˆ•/å°è©±æ¡†/é™°å½±èˆ‡åœ“è§’ */
  --button-primary-bg:   var(--kikyo-primary);
  --button-primary-text: var(--text-light);
  --button-secondary-bg: var(--bg-card);
  --button-secondary-text: var(--text-primary);
  --button-border: var(--calendar-border);

  --modal-overlay: rgba(93,78,117,0.6);
  --modal-bg:      var(--bg-card);
  --modal-border:  var(--calendar-border);

  --notes-bg:     var(--bg-card);
  --notes-border: var(--calendar-border);
  --notes-shadow: 0 4px 12px rgba(93,78,117,0.1);

  --border-radius:       8px;  /* å¡ç‰‡åœ“è§’ */
  --border-radius-small: 8px;   /* å°å‹å…ƒä»¶åœ“è§’ */

  --shadow-soft:   0 2px 8px  rgba(93,78,117,0.1);
  --shadow-medium: 0 4px 16px rgba(93,78,117,0.15);
}

/* ==================== ğŸŒ åŸºç¤æ¨£å¼ ==================== */
html, body {
  margin: 0;
  padding: 0;
  font-family: 'Noto Sans TC', 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', Arial, sans-serif;
  font-size: 14px;
  font-weight: 400;
  height: auto;
  overflow-x: hidden;
  overflow-y: auto;
  color: var(--text-primary);
  background: var(--bg-main);
  line-height: 1.6;
  scroll-behavior: smooth;
}

#calendar-container {
  position: relative;
  width: 100%;
  padding: 5px 20px;
  padding-bottom: 10px;
  max-width: none;
  margin: 0;
  animation: fadeInUp 0.6s ease-out;
}

#calendar {
  width: 100% !important;
  max-width: none;
  margin: 0;
  height: auto !important;
  background: var(--bg-card);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow-medium);
  overflow: hidden;
}

/* é‚„åŸç”± FullCalendar è‡ªè¡Œç®¡ç†é«˜åº¦èˆ‡æ²å‹• */
.fc .fc-scroller { overflow-y: visible !important; height: auto !important; } 
.fc-view-harness { height: auto !important; } 
#calendar .fc-timegrid-slots table { height: auto !important; } 

/* ==================== ğŸªŸ å½ˆçª—æ¨£å¼ ==================== */

/* å½ˆçª—èƒŒæ™¯èˆ‡å¤–æ¡† - é®ç½©å±¤ï¼Œé è¨­éš±è— */
.modal { display: none; position: fixed; z-index: 1000; inset: 0; overflow: auto; background: var(--modal-overlay); backdrop-filter: blur(4px); }

/* å½ˆçª—å…§å®¹çš„ä¸»é«”å®¹å™¨ - èƒŒæ™¯ã€ä½ç½®ã€å°ºå¯¸èˆ‡å‹•ç•« */
.modal-content { background: var(--modal-bg); margin: 5% auto; padding: 30px; border: 1px solid var(--modal-border); width: 90%; max-width: 500px; border-radius: var(--border-radius); max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-medium); transform: translateY(-20px); animation: modalSlideIn 0.3s ease-out forwards; }

/* å½ˆçª—æ»‘å…¥å‹•ç•«æ•ˆæœ */
@keyframes modalSlideIn { to { transform: translateY(0); } }

/* å½ˆçª—å³ä¸Šè§’çš„é—œé–‰æŒ‰éˆ• (X) æ¨£å¼ */
.close-button { color: var(--text-muted); float: right; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s ease; line-height: 1; }

/* é—œé–‰æŒ‰éˆ•æ»‘éæ™‚çš„é¡è‰²èˆ‡æ”¾å¤§æ•ˆæœ */
.close-button:hover, .close-button:focus { color: var(--kikyo-primary); transform: scale(1.1); }

/* å½ˆçª—æ¨™é¡Œ (ä¾‹å¦‚ï¼šâœ¨ æ–°å¢/ç·¨è¼¯é ç´„) çš„æ¨£å¼ */
#appointmentForm h3 { color: var(--kikyo-primary); font-weight: 500; margin-bottom: 20px; font-size: 20px; }

/* è¡¨å–®æ¬„ä½æ¨™ç±¤ (Label) çš„å‚ç›´é–“è·èˆ‡å­—é«”æ¨£å¼ */
#appointmentForm label { margin-top: 15px; display: block; font-weight: 500; color: var(--text-primary); margin-bottom: 5px; }

/* æ‰€æœ‰è¼¸å…¥æ¡†ã€é¸å–®ã€æ–‡å­—å€ (input/select/textarea) çš„åŸºæœ¬æ¨£å¼ã€å¯¬åº¦èˆ‡é‚Šæ¡† */
#appointmentForm input, #appointmentForm select, #appointmentForm textarea { width: 100%; padding: 12px; margin-top: 4px; border: 2px solid var(--calendar-border); border-radius: var(--border-radius-small); box-sizing: border-box; font-family: inherit; font-size: 14px; transition: border-color 0.3s ease, box-shadow 0.3s ease; }

/* æ¬„ä½ç²å¾—ç„¦é» (focus) æ™‚çš„é‚Šæ¡†é¡è‰²èˆ‡é™°å½±æ•ˆæœ */
#appointmentForm input:focus, #appointmentForm select:focus, #appointmentForm textarea:focus { outline: none; border-color: var(--kikyo-primary); box-shadow: 0 0 0 3px rgba(93, 78, 117, 0.1); }

/* é ç´„é¡å‹ (ä¸€èˆ¬/ä¸ç´„) é¸æ“‡å€å¡Šçš„é‚Šæ¡†èˆ‡èƒŒæ™¯ */
.appointment-type-section { margin: 20px 0; padding: 15px; border: 2px solid var(--calendar-border); border-radius: var(--border-radius-small); background: var(--bg-active); }

/* é ç´„é¡å‹å€å¡Šå…§ Label çš„ç‰¹æ®Šæ¨£å¼ (è¦†è“‹å¤–å±¤çš„ margin-top) */
.appointment-type-section label { margin-top: 0 !important; margin-bottom: 10px; font-weight: 500; color: var(--kikyo-primary); }

/* å–®é¸éˆ•ç¾¤çµ„ (Radio Group) çš„ä½ˆå±€èˆ‡é–“è· */
.radio-group { display: flex; gap: 20px; margin-top: 8px; }

/* å–®é¸éˆ• (Radio) è¼¸å…¥å…ƒä»¶æœ¬èº«çš„å°ºå¯¸èˆ‡é¡è‰² */
.radio-group input[type="radio"] { width: auto !important; margin-right: 8px; accent-color: var(--kikyo-primary); }

/* å–®é¸éˆ•æ—é‚Š Label çš„å°é½Šèˆ‡æ–‡å­—æ¨£å¼ */
.radio-group label { margin-top: 0 !important; font-weight: normal !important; display: flex; align-items: center; color: var(--text-primary); cursor: pointer; transition: color 0.3s ease; }

/* å–®é¸éˆ• Label æ»‘éæ™‚çš„é¡è‰²è®ŠåŒ– */
.radio-group label:hover { color: var(--kikyo-primary); }

/* å„²å­˜/åˆªé™¤æŒ‰éˆ•çš„åŸºæœ¬æ¨£å¼ã€å…§é‚Šè·èˆ‡é™°å½± */
#submit-btn, #deleteBtn { color: var(--button-primary-text); border: none; padding: 12px 24px; border-radius: var(--border-radius-small); cursor: pointer; font-weight: 500; font-size: 16px; transition: all 0.3s ease; box-shadow: var(--shadow-soft); }

/* å„²å­˜æŒ‰éˆ•çš„æ¼¸å±¤èƒŒæ™¯ */
#submit-btn { background: linear-gradient(135deg, var(--kikyo-primary) 0%, var(--kikyo-light) 100%); }
/* æŒ‰éˆ•æ»‘éæ™‚çš„ä¸Šæµ®èˆ‡é™°å½±åŠ æ·±æ•ˆæœ */
#submit-btn:hover, #deleteBtn:hover { transform: translateY(-2px); box-shadow: var(--shadow-medium); }
/* æŒ‰éˆ•é»æ“Šæ™‚çš„ä¸‹å£“æ•ˆæœ */
#submit-btn:active, #deleteBtn:active { transform: translateY(0); }
/* åˆªé™¤æŒ‰éˆ•çš„èƒŒæ™¯é¡è‰² */
#deleteBtn { background: #C0392B; }
/* åˆªé™¤æŒ‰éˆ•æ»‘éæ™‚çš„èƒŒæ™¯é¡è‰² */
#deleteBtn:hover { background: #E74C3C; }

/* ==================== ğŸ“… æ—¥æ›†å·¥å…·åˆ— ==================== */
#calendar .fc-header-toolbar {
    display: flex;
    align-items: center;
    gap: 1rem;
    background: var(--calendar-header-bg);
    padding: 8px 30px;
    margin-bottom: 0 !important;
    border-radius: var(--border-radius) var(--border-radius) 0 0;
}

#calendar .fc-toolbar-chunk {
  display: flex;
  align-items: center;
  gap: 0.8rem;
}

#calendar .fc-toolbar-title {
  display: flex;
  align-items: center;
  color: var(--calendar-header-text);
  font-weight: 700;
  font-size: 24px;
  letter-spacing: 1px;
}

#calendar .fc-toolbar-chunk .fc-button { color: var(--calendar-header-text); }

.fc-button {
  background-color: rgba(255, 255, 255, 0.2) !important;
  border: 1px solid rgba(255, 255, 255, 0.3) !important;
  color: var(--text-light) !important;
  height: 36px;
  border-radius: var(--border-radius-small) !important;
  font-weight: 400;
  transition: all 0.3s ease;
}

.fc-button:hover {
  background-color: rgba(255, 255, 255, 0.3) !important;
  transform: translateY(-1px);
}

.fc-button:focus { box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3) !important; }

/* ==================== ğŸ“‹ æ—¥æ›†è¡¨é ­ ==================== */
#calendar .fc-col-header {
    height: 50px;
    background: var(--bg-card);
    border-bottom: 2px solid var(--calendar-border);
}

#calendar .fc-col-header-cell {
  height: 100%;
  padding: 0 !important;
}

#calendar .fc-col-header-cell .fc-scrollgrid-sync-inner {
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

#calendar .fc-col-header-cell-cushion {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  padding: 0 !important;
  line-height: 1 !important;
  font-size: 18px;
  font-weight: 500;
  color: #f1f1f5;

}

#calendar .fc-scrollgrid-section-header .fc-scroller { overflow-y: hidden !important; }
#calendar .fc-scrollgrid { border-top: 1px solid var(--calendar-border); }

/* ==================== ğŸ“Š æ—¥æ›†å…§å®¹å€ ==================== */
#calendar .fc-timegrid-slots table {
  margin: 0 !important;
  height: auto !important;
  padding: 0 !important;
  box-sizing: border-box !important;
}

#calendar .fc-timegrid-slot,
#calendar .fc-timegrid-slot.fc-timegrid-slot-label { height: 2.5em !important; }
#calendar .fc-timegrid-slot-lane { background-color: transparent !important; }
#calendar .fc-timegrid-slots tbody tr:nth-child(odd) td.fc-timegrid-slot-lane { background: var(--calendar-content-odd) !important; }
#calendar .fc-timegrid-slots tbody tr:nth-child(even) td.fc-timegrid-slot-lane { background: var(--calendar-content-even) !important; }

/* ==================== â° æ™‚é–“æ¨™ç±¤ ==================== */
#calendar .fc-timegrid-slot-label.slot-major-0030 .fc-timegrid-slot-label-cushion {
    font-size: 14px !important;
    font-weight: 600 !important;
    color: #592C63 !important;
}

#calendar .fc-timegrid-slot.fc-minor .fc-timegrid-slot-label .fc-timegrid-slot-label-cushion {
    font-size: 14px;
    font-weight: 500;
    color: #846691;
}


#calendar .fc-timegrid-slot-label .fc-timegrid-slot-label-cushion {
  font-size: 14px;
  font-weight: 400;
  color: var(--text-primary);
}


/* ==================== ğŸ“± æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼è¨­è¨ˆ ==================== */

/* å®šç¾©è¢å¹•å¯¬åº¦å°æ–¼æˆ–ç­‰æ–¼ 768 åƒç´ æ™‚çš„æ¨£å¼ */
@media (max-width: 768px) {
    /* æ—¥æ›†ä¸»å®¹å™¨çš„å·¦å³å…§é‚Šè· */
    #calendar-container { padding: 10px; }
    /* æ—¥æ›†ä¸»é«”å¼·åˆ¶å…¨å¯¬ï¼Œä¸¦å‘å¤–å»¶ä¼¸å¡«æ»¿è¢å¹•å·¦å³é‚Šç·£ */
    #calendar { width: 100vw !important; margin: 0 -10px; border-radius: 0; }
    /* å½ˆçª—å…§å®¹å€çš„å¯¬åº¦ã€ä½ç½®èˆ‡å…§é‚Šè· */
    .modal-content { width: 95%; margin: 2% auto; padding: 20px; }
    /* äº‹ä»¶å¡ç‰‡çš„æœ€å°èˆ‡æœ€å¤§é«˜åº¦ */
    #calendar .fc-timegrid-event { min-height: 1.8em !important; max-height: 2.2em !important; }
    /* äº‹ä»¶å¡ç‰‡å…§çš„æ–‡å­—å¤§å°ã€è¡Œé«˜èˆ‡å…§é‚Šè· */
    #calendar .fc-timegrid-event .fc-event-title { font-size: 12px; line-height: 1.2; padding: 0 6px; }
    /* æ—¥æ›†é ‚éƒ¨å·¥å…·åˆ—çš„ä½ˆå±€èˆ‡å…§é‚Šè· */
    #calendar .fc-header-toolbar { flex-wrap: nowrap; justify-content: space-between; padding: 8px 30px; }
    /* å·¥å…·åˆ—æŒ‰éˆ•çš„å­—é«”å¤§å°èˆ‡å…§é‚Šè· */
    .fc-button { font-size: 0.75em; padding: 0.3em 0.6em; line-height: 1; }
}

/* ==================== ğŸ”— æ—¥æ›†æ¬„ä½åˆ†éš”ç·š ==================== */
#calendar .fc-timegrid-body .fc-timegrid-col { position: relative; }
#calendar .fc-timegrid-body .fc-timegrid-col:not(:last-child)::after {
  content: "";
  position: absolute;
  top: 0;
  bottom: 0;
  right: 0;
  width: 1px;
  background: var(--calendar-border);
  pointer-events: none;
  z-index: 100;
}

/* ==================== 4. äº‹ä»¶å¡ç‰‡é¡è‰²èˆ‡æ¨£å¼ (Events) æ•´ç†ç‰ˆ ==================== */

/* è¨­è¨ˆå¸«é¡è‰²è®Šæ•¸å®šç¾© (è«‹åœ¨é€™è£¡ä¿®æ”¹é¡è‰²ç¢¼) */
:root {
  /* äº‹ä»¶é è¨­è‰²ï¼ˆè‹¥æœªå¥—è¨­è¨ˆå¸«è‰²æ™‚çš„å‚™ç”¨ï¼‰ */
  --event-default-bg: var(--kikyo-primary);--event-default-text: var(--text-light);

     --stylist-1-bg: #3A8FB7;
    --stylist-1-text: #f8f1f1;
    --stylist-1-bg-light:  #7faecc;;
    --stylist-2-bg: #E16B8C;
    --stylist-2-text: var(--text-light);
    --stylist-2-bg-light: #ef87a4;
    --stylist-3-bg: #5b546e;
    --stylist-3-text: var(--text-light);
    --stylist-3-bg-light: #958ea7;
}


/* --- A. äº‹ä»¶å¡ç‰‡çš„çµæ§‹èˆ‡äº’å‹• --- */

/* å¡ç‰‡å®¹å™¨ï¼šæ§åˆ¶å¡ç‰‡å¯¬åº¦èˆ‡é–“è· */
#calendar .fc-timegrid-event-harness {
  width: calc(50% - 6px) !important;
  margin: 0 3px !important;
  padding: 0 !important;
  box-sizing: border-box;

}

/* å¡ç‰‡æœ¬èº«ï¼šæ§åˆ¶é«˜åº¦ã€åœ“è§’ã€é™°å½±èˆ‡å‹•ç•« */
#calendar .fc-timegrid-event {
  width: 100% !important;
  min-width: 0 !important;
  height: 2.7em !important; /* ã€èª¿æ•´ã€‘å¡ç‰‡é«˜åº¦ */
  min-height: 0 !important;
  overflow: hidden;
  border-radius: var(--border-radius-small);
  box-shadow: var(--shadow-soft);
  transition: all 0.3s ease;

}

/* å¡ç‰‡æ»‘éæ™‚çš„é™°å½±èˆ‡ä¸Šæµ®æ•ˆæœ */
#calendar .fc-timegrid-event:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-medium);
}


/* --- B. äº‹ä»¶å¡ç‰‡çš„æ–‡å­—èˆ‡å…§å®¹æ’ç‰ˆ --- */

/* å¡ç‰‡æ–‡å­—çš„ä¸»å®¹å™¨ï¼šæ§åˆ¶å°é½Šã€å­—é«”ã€å…§é‚Šè· */
#calendar .fc-timegrid-event .fc-event-title {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  padding: 0 8px;
  font-size: 15px; /* ã€èª¿æ•´ã€‘é è¨­æ–‡å­—å¤§å° */
  font-weight: 400;
  line-height: 1.3;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  letter-spacing: 0.3px;
}

/* æœå‹™å¾½ç«  (svc-badge) çš„æ¨£å¼ */
.svc-badge{
  font-size: 22px; font-weight: 700; margin-right: 6px; line-height: 1;
}

/* äº‹ä»¶å¡ç‰‡å¤šæ®µæ–‡å­—çš„é–“è·èˆ‡æ¨£å¼ */
.fc-timegrid-event .fc-event-title.evt-line{
  display:flex; justify-content:center; align-items:center;
  gap:6px;    /* ã€èª¿æ•´ã€‘æ¯æ®µå­—ï¼ˆæœå‹™ã€æ™‚é–“ã€å§“åç­‰ï¼‰çš„é–“è· */
}
.evt-svc{ font-size:22px; font-weight:700; }
.evt-time{ min-width:48px; text-align:right; }
.evt-phone{ letter-spacing:0.5px; }


/* --- C. è¨­è¨ˆå¸«é¡è‰²å¥—ç”¨è¦å‰‡ (è«‹å‹¿ä¿®æ”¹ï¼Œåªéœ€èª¿æ•´ä¸Šæ–¹è®Šæ•¸) --- */

/* ä¸€èˆ¬é ç´„ (sty-1, sty-2, sty-3) */
#calendar .fc-event.sty-1{ background: var(--stylist-1-bg) !important; border-color: var(--stylist-1-bg) !important; color: var(--stylist-1-text) !important; }
#calendar .fc-event.sty-2{ background: var(--stylist-2-bg) !important; border-color: var(--stylist-2-bg) !important; color: var(--stylist-2-text) !important; }
#calendar .fc-event.sty-3{ background: var(--stylist-3-bg) !important; border-color: var(--stylist-3-bg) !important; color: var(--stylist-3-text) !important; }

/* ä¸ç´„æ™‚æ®µ (sty-*-light + blocked-time) */
#calendar .fc-event.sty-1.blocked-time{ background: var(--stylist-1-bg-light) !important; border-color: var(--stylist-1-bg-light) !important; color: var(--stylist-1-text) !important; }
#calendar .fc-event.sty-2.blocked-time{ background: var(--stylist-2-bg-light) !important; border-color: var(--stylist-2-bg-light) !important; color: var(--stylist-2-text) !important; }
#calendar .fc-event.sty-3.blocked-time{ background: var(--stylist-3-bg-light) !important; border-color: var(--stylist-3-bg-light) !important; color: var(--stylist-3-text) !important; }


/* --- D. æ‰‹æ©Ÿç‰ˆæ¨£å¼è¦†è“‹ --- */

@media (max-width:768px){
  .svc-badge{ font-size: 20px; }
  .fc-timegrid-event .fc-event-title.evt-line{ gap:6px; }
  .evt-svc{ font-size:22px; }
}

/* ==================== ğŸ’¬ ç•™è¨€å€ ==================== */

/* ç•™è¨€å€å¡Šå¤–å®¹å™¨çš„çµæ§‹èˆ‡ä½ç½® */
#notes-section {width: 100%; max-width: none; margin: 10px 0; padding: 0 15px; animation: fadeInUp 0.8s ease-out;}

/* ç•™è¨€å¡ç‰‡çš„ä¸»é«”å®¹å™¨ - èƒŒæ™¯ã€é‚Šæ¡†ã€å…§é‚Šè·èˆ‡åŸºç¤é™°å½± */
.notes-container {background: var(--notes-bg); border: 2px solid var(--notes-border); border-radius: var(--border-radius); padding: 25px; box-shadow: var(--notes-shadow); transition: all 0.3s ease;}

/* æ»‘é¼ æ»‘éå¡ç‰‡æ™‚çš„é™°å½±èˆ‡ä¸Šæµ®æ•ˆæœ */
.notes-container:hover {box-shadow: var(--shadow-medium); transform: translateY(-2px);}

/* ç•™è¨€æ¿æ¨™é¡Œåˆ—çš„ä½ˆå±€ã€å°é½Šèˆ‡åº•ç·š */
.notes-header {display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--calendar-border);}

/* ç•™è¨€æ¿æ¨™é¡Œæ–‡å­— (ä¾‹å¦‚ï¼šç•™è¨€æ¿) çš„æ¨£å¼ã€é¡è‰²èˆ‡ç¬¦è™Ÿé–“è· */
.notes-header h4 {margin: 0; color: var(--kikyo-primary); font-size: 20px; font-weight: 500; display: flex; align-items: center; gap: 10px;}
/* ç•™è¨€æ¿æ¨™é¡Œå‰çš„ç¬¦è™Ÿï¼ˆğŸ’­ï¼‰ */
.notes-header h4::before {content: "ğŸ’­"; font-size: 24px;}

/* ã€Œè‡ªå‹•å„²å­˜ã€æ–‡å­—çš„æ¨£å¼ã€é¡è‰²èˆ‡ä½ç½® */
.notes-meta {margin-left: auto; color: var(--text-muted); font-size: 12px; display: flex; align-items: center; gap: 5px;}
/* ã€Œè‡ªå‹•å„²å­˜ã€æ–‡å­—å‰çš„ç¬¦è™Ÿï¼ˆğŸ’¾ï¼‰ */
.notes-meta::before {content: "ğŸ’¾"; font-size: 14px;}

/* ç­†è¨˜è¼¸å…¥æ¡†ï¼ˆTextareaï¼‰çš„çµæ§‹ã€é¡è‰²èˆ‡é‚Šæ¡† */
#notes-content {width: 100%; min-height: 200px; padding: 20px; box-sizing: border-box; border: 2px solid var(--calendar-border); border-radius: var(--border-radius-small); font-size: 14px; line-height: 1.6; font-family: inherit; background: var(--bg-card); color: var(--text-primary); resize: vertical; transition: all 0.3s ease;}

/* ç­†è¨˜è¼¸å…¥æ¡†ç²å¾—ç„¦é»ï¼ˆè¢«é»æ“Šï¼‰æ™‚çš„æ¨£å¼èˆ‡é‚Šæ¡†é¡è‰²è®ŠåŒ– */
#notes-content:focus {outline: none; border-color: var(--kikyo-primary); box-shadow: 0 0 0 3px rgba(93, 78, 117, 0.1); background: var(--bg-active);}
/* æç¤ºæ–‡å­—ï¼ˆplaceholderï¼‰çš„æ¨£å¼ */
#notes-content::placeholder {color: var(--text-muted); font-style: italic;}

/* ç•™è¨€å€å¡Šåœ¨æ‰‹æ©Ÿç‰ˆ (å°æ–¼ 768px) çš„å¤–é‚Šè·èª¿æ•´ */
@media (max-width: 768px) {
    #notes-section {padding: 0 10px; margin: 20px auto;}
    /* æ‰‹æ©Ÿç‰ˆå¡ç‰‡å…§é‚Šè·èª¿æ•´ */
    .notes-container {padding: 20px;}
    /* æ‰‹æ©Ÿç‰ˆæ¨™é¡Œæ¬„æ”¹ç‚ºå‚ç›´æ’åˆ— */
    .notes-header {flex-direction: column; align-items: flex-start; gap: 10px;}
    /* æ‰‹æ©Ÿç‰ˆã€Œè‡ªå‹•å„²å­˜ã€æ–‡å­—å°é½Šèª¿æ•´ */
    .notes-meta {margin-left: 0;}
    /* æ‰‹æ©Ÿç‰ˆè¼¸å…¥æ¡†é«˜åº¦èˆ‡å…§é‚Šè·èª¿æ•´ */
    #notes-content {min-height: 150px; padding: 15px;}
}

/* ==================== âœ¨ è¦–è¦ºå¢å¼· ==================== */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }   /* é€²å ´å‹•ç•« */
  to { opacity: 1; transform: translateY(0); }        /* è¡Œé«˜ */
}
/* äº‹ä»¶å¡ç‰‡å¤–åœå¼§åº¦ */
#calendar .fc-timegrid-event { border-radius: 6px; }



/* ==================== ğŸ“‹ è¡¨é ­æ¨£å¼ï¼ˆç›´æ¥è¨­å®šç‰ˆï¼‰ ==================== */

/* è¡¨é ­æ•´åˆ—çš„èƒŒæ™¯èˆ‡é«˜åº¦ */
#calendar .fc-col-header {
  height: 40px !important;
  background: #6F3381 !important; /* æ‚¨æŒ‡å®šçš„èƒŒæ™¯è‰² */
  border-bottom: 2px solid var(--calendar-border); /* é‚Šæ¡†ç·šé¡è‰²ä¿ç•™è®Šæ•¸ï¼Œæ–¹ä¾¿èˆ‡æ—¥æ›†æ•´é«”é¢¨æ ¼é€£å‹• */
}

/* ç¢ºä¿æ¯ä¸€æ ¼é«˜åº¦èˆ‡æ•´åˆ—åŒæ­¥ */
#calendar .fc-col-header-cell,
#calendar .fc-col-header-cell .fc-scrollgrid-sync-inner {
  height: 40px !important;
}

/* è¡¨é ­æ–‡å­—çš„å­—å‹ã€å¤§å°ã€é–“è·ç­‰æ¨£å¼ */
#calendar .fc-col-header-cell-cushion {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  padding: 0 !important;
  line-height: 1;
  gap: 15rem; /* æ°´å¹³é–“è· */
  
  /* ä»¥ä¸‹ç‚ºæ‚¨æŒ‡å®šçš„å­—å‹æ¨£å¼ */
  font-family: 'Microsoft JhengHei', Arial;
  font-size: 22px;
  font-weight: 500;
  color: #FFFFFF; /* æ–‡å­—é¡è‰²ï¼Œæˆ‘å…ˆè¨­ç‚ºç™½è‰²ï¼Œæ‚¨å¯è‡ªè¡Œä¿®æ”¹ */
}

/* æ‰‹æ©Ÿå¯ç¨å¾®ç¸®å°å­—èˆ‡è¡Œé«˜ï¼ˆéœ€è¦å°±ç•™ï¼‰ */
@media (max-width:768px){
  :root{
    --col-header-height: 48px;
    --col-header-size:   16px;
  }
}
/* ==================== ğŸ“‹ è¡¨é ­æ–‡å­—ç‰¹æ•ˆï¼ˆè²¼åœ¨æœ€ä¸‹é¢ï¼‰ ==================== */
/*:root{
  /* å¿«é€Ÿåˆ‡æ›ï¼šæŠŠä¸‹é¢å…¶ä¸­ä¸€çµ„å€¼è²¼åˆ° --col-header-effect */
  /*--col-header-effect: 0 1px 0 #fff, 0 2px 6px rgba(0,0,0,.22); /* æŸ”å’Œé™°å½±ï¼ˆé è¨­ï¼‰ */
  /* å…¶å®ƒç¯„ä¾‹ï¼š
     ç™¼å…‰ï¼š0 0 6px rgba(139,124,163,.6), 0 0 12px rgba(139,124,163,.35)
     å…§å‡¹ï¼š0 1px 0 rgba(255,255,255,.6), 0 -1px 0 rgba(0,0,0,.25)
     å¼·å°æ¯”é™°å½±ï¼š0 1px 0 #fff, 0 3px 10px rgba(0,0,0,.35)
  */


/* è¡¨é ­æ–‡å­—å¥—ç”¨ç‰¹æ•ˆ */
#calendar .fc-col-header-cell-cushion{
  text-shadow: var(--col-header-effect);
  transition: text-shadow .2s ease, transform .2s ease;
}

/* æ»‘éå¾®äº®èˆ‡ä¸Šæµ®ï¼ˆå¯ä¸è¦å°±åˆªï¼‰ */
#calendar .fc-col-header-cell-cushion:hover{
  text-shadow: 0 1px 0 #fff, 0 3px 10px rgba(0,0,0,.28);
  transform: translateY(-1px);
}

/* æ‰‹æ©Ÿä¸Šæ”¶æ–‚ä¸€é»æ•ˆæœï¼ˆé¿å…å¤ªäº®ï¼‰ */
@media (max-width:768px){
  #calendar .fc-col-header-cell-cushion{
    text-shadow: 0 1px 0 #fff, 0 1px 4px rgba(0,0,0,.18);
  }
}

/* ğŸŒˆ å…¨é èƒŒæ™¯ï¼šæŸ”å’Œæ¥µå…‰ */
:root{ --bg-main: #e6e2f5;}
/* ğŸ§¿ è¡¨é ­èƒŒæ™¯ä¹Ÿç”¨æ¼¸å±¤ */
:root{
  --calendar-header-bg: linear-gradient(90deg, #4A225D 50%, #6F3381 100%);
}


</style>

</head>
<body>
    <!-- æ—¥æ›†ä¸»å®¹å™¨ -->
    <div id="calendar-container">
        <div id="calendar"></div>

        <!-- é ç´„å½ˆçª— -->
        <div id="appointmentModal" class="modal">
          <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>âœ¨ æ–°å¢/ç·¨è¼¯é ç´„</h3>
            <form id="appointmentForm">
              <input type="hidden" id="event_id" name="event_id">
              <input type="hidden" id="start_time" name="start_time">
              
              <input type="hidden" id="employee_id" name="employee_id">

              <label for="minute_select">ğŸ• é–‹å§‹åˆ†é˜</label>
              <select id="minute_select" name="minute_select"></select>

              <div class="appointment-type-section">
                <label>ğŸ“‹ é ç´„é¡å‹</label>
                <div class="radio-group">
                  <label>
                    <input type="radio" name="appointment_type" value="normal" checked>
                    âœ… ä¸€èˆ¬é ç´„
                  </label>
                  <label>
                    <input type="radio" name="appointment_type" value="blocked">
                    ğŸš« ä¸ç´„æ™‚æ®µ
                  </label>
                </div>
              </div>

              <div id="customer-fields">
                <label for="customer_phone">ğŸ“ é¡§å®¢é›»è©±</label>
                <input type="tel" id="customer_phone" name="customer_phone"
                      inputmode="numeric" autocomplete="off" placeholder="09xx-xxx-xxx">


                <label for="customer_name">ğŸ‘¤ é¡§å®¢å§“å</label>
                <input type="text" id="customer_name" name="customer_name" placeholder="è«‹è¼¸å…¥é¡§å®¢å§“å">

                <label for="service_id">ğŸ’‡ æœå‹™é …ç›® (å¯é¸)</label>
                <select id="service_id" name="service_id">
                  <option value="">-- è«‹é¸æ“‡æœå‹™ (å¯ä¸é¸) --</option>
                  <option value="å‰ªé«®">âœ‚ï¸ å‰ªé«®</option>
                  <option value="å‰ª+æŸ“">âœ‚ï¸ğŸ¨ å‰ª+æŸ“</option>
                  <option value="å‰ª+ç‡™">âœ‚ï¸ğŸŒ€ å‰ª+ç‡™</option>
                  <option value="å‰ª+æŸ“+ç‡™">âœ‚ï¸ğŸ¨ğŸŒ€ å‰ª+æŸ“+ç‡™</option>
                  <option value="å‰ª+é ­çš®è­·ç†">âœ‚ï¸ğŸ’† å‰ª+é ­çš®è­·ç†</option>
                </select>
              </div>

              <label for="notes">ğŸ“ å‚™è¨»</label>
              <textarea id="notes" name="notes" rows="3" placeholder="è«‹è¼¸å…¥å‚™è¨»è³‡è¨Š..."></textarea>

              <div style="margin-top: 20px; text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
                <button type="button" id="deleteBtn" style="display:none;">ğŸ—‘ï¸ åˆªé™¤é ç´„</button>
                <button type="submit" id="submit-btn">ğŸ’¾ å„²å­˜é ç´„</button>
              </div>
            </form>
          </div>
        </div>
    </div>

    <!-- ç•™è¨€å€ -->
    <div id="notes-section">
        <div class="notes-container">
            <div class="notes-header">
                <h4>ç•™è¨€æ¿</h4>
                <div class="notes-meta">
                    <span>è‡ªå‹•å„²å­˜</span>
                </div>
            </div>
            <textarea id="notes-content" placeholder="ğŸ’­ åœ¨æ­¤è¼¸å…¥æ‚¨çš„ç­†è¨˜ã€æƒ³æ³•æˆ–é‡è¦æé†’..."></textarea>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.11.5/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/locales/zh-tw.js"></script>

    <script>
// å¾Œç«¯ Google Apps Script ç¶²å€
const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz35yv10YIDyeT6a77bMY1okWfiUvyODw9A309gaSZAZUTE2i45Vn-EbTINrytvp8ZB4Q/exec';

(function(){
      document.addEventListener('DOMContentLoaded', function(){
        // --- å…ƒç´ é¸æ“‡ ---
        const modal = document.getElementById('appointmentModal');
        const form = document.getElementById('appointmentForm');
        const closeButton = document.querySelector('.close-button');
        const calendarEl = document.getElementById('calendar');
        const customerFields = document.getElementById('customer-fields');
        const submitBtn = document.getElementById('submit-btn');
        const deleteBtn = document.getElementById('deleteBtn');
        const eventIdInput = document.getElementById('event_id');
        const notesTextarea = document.getElementById('notes-content');
        const phoneEl = document.getElementById('customer_phone');

        phoneEl.addEventListener('input', (e) => {
          let d = e.target.value.replace(/\D/g,'').slice(0,10);
          if (d.length >= 7) e.target.value = d.replace(/^(\d{4})(\d{3})(\d{0,3}).*$/, function(_,a,b,c){ return c ? `${a}-${b}-${c}` : `${a}-${b}` });
          else if (d.length >= 5) e.target.value = d.replace(/^(\d{4})(\d{0,3}).*$/, '$1-$2');
          else e.target.value = d;
        });

        // --- ç•™è¨€æ¿åŠŸèƒ½ ---
        const savedNotes = localStorage.getItem('userNotes');
        if (savedNotes) {
            notesTextarea.value = savedNotes;
        }
        notesTextarea.addEventListener('input', function() {
            localStorage.setItem('userNotes', notesTextarea.value);
            const metaElement = document.querySelector('.notes-meta span');
            metaElement.textContent = 'å·²å„²å­˜ âœ“';
            setTimeout(() => { metaElement.textContent = 'è‡ªå‹•å„²å­˜'; }, 2000);
        });

        // --- ä¿®æ­£å…©å€‹äº‹ä»¶é‡ç–Šæ™‚çš„å¯¬åº¦ ---
        function fixTwoEvents() {
          function overlap(a, b) {
            const r1 = a.getBoundingClientRect();
            const r2 = b.getBoundingClientRect();
            return r1.top < r2.bottom && r2.top < r1.bottom;
          }
          document.querySelectorAll('#calendar .fc-timegrid-col').forEach(col => {
            const harnesses = Array.from(col.querySelectorAll('.fc-timegrid-event-harness'));
            harnesses.forEach(h => { h.style.width = ''; });
            harnesses.forEach(h => {
              const s = (h.getAttribute('style') || '').replace(/\s+/g, '');
              if (s.includes('left:50%')) {
                const partner = harnesses.find(p => {
                  if (p === h) return false;
                  const sp = (p.getAttribute('style') || '').replace(/\s+/g, '');
                  return sp.includes('left:0%') && overlap(p, h);
                });
                if (partner) {
                  h.style.width = 'calc(50% - 4px)';
                  partner.style.width = 'calc(50% - 4px)';
                }
              }
            });
          });
        }

        // --- å½ˆçª—å…§é ç´„é¡å‹åˆ‡æ›é‚è¼¯ ---
        document.querySelectorAll('input[name="appointment_type"]').forEach(radio => {
          radio.addEventListener('change', function() {
            const isBlocked = this.value === 'blocked';
            customerFields.style.display = isBlocked ? 'none' : 'block';
            document.getElementById('notes').placeholder = isBlocked
             ? 'ä¸ç´„æ™‚æ®µå‚™è¨»...'
             : 'è«‹è¼¸å…¥å‚™è¨»è³‡è¨Š...';


            const isEditing = !!eventIdInput.value;
            if (isBlocked) {
                submitBtn.innerHTML = 'ğŸš« è¨­å®šä¸ç´„æ™‚æ®µ';
            } else {
                submitBtn.innerHTML = isEditing ? 'âœ… æ›´æ–°é ç´„' : 'ğŸ’¾ å„²å­˜é ç´„';
            }
          });
        });
        
        // --- é–‹å•Ÿé ç´„å½ˆçª— ---
        function openApptModal(startDate, resourceId) {
          if (!resourceId) return;
          
          form.reset();
          eventIdInput.value = '';
          
          submitBtn.innerHTML = 'ğŸ’¾ å„²å­˜é ç´„';
          deleteBtn.style.display = 'none';
          document.querySelector('input[name="appointment_type"][value="normal"]').checked = true;
          customerFields.style.display = 'block';
          document.getElementById('notes').placeholder = 'è«‹è¼¸å…¥å‚™è¨»è³‡è¨Š...';
          document.getElementById('employee_id').value = resourceId;

          const minuteSelect = document.getElementById('minute_select');
          minuteSelect.innerHTML = '';
          const baseMin = startDate.getMinutes();

          for (let i = 0; i < 3; i++) { 
            const currentMinute = baseMin + (i * 5); 
            const opt = document.createElement('option');
            opt.value = currentMinute; 
            opt.textContent = String(currentMinute).padStart(2, '0');
            if (i === 0) opt.selected = true;
            minuteSelect.appendChild(opt);
          }
          
          updateHiddenStartTime(startDate);
          minuteSelect.onchange = function() { updateHiddenStartTime(startDate) };
          
          modal.style.display = 'block';
        }

        // --- æ›´æ–°éš±è—çš„é–‹å§‹æ™‚é–“æ¬„ä½ï¼ˆä»¥ UTC ISO8601 å‚³çµ¦å¾Œç«¯ï¼‰---
        function updateHiddenStartTime(baseDate) {
          const selectedMinute = parseInt(document.getElementById('minute_select').value, 10);
          const dt = new Date(baseDate.getTime());
          dt.setMinutes(selectedMinute, 0, 0);
          document.getElementById('start_time').value = dt.toISOString();
        }

        // --- åˆå§‹åŒ– FullCalendar ---
        const calendar = new FullCalendar.Calendar(calendarEl, {
          schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
          locale: 'zh-tw',
          timeZone: 'Asia/Taipei',
          initialView: 'resourceTimeGridDay',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'resourceTimeGridDay,resourceTimeGridWeek'
          },
          allDaySlot: false,
          slotMinTime: '12:00:00',
          slotMaxTime: '21:00:00',
          slotDuration: '00:15:00',
          slotLabelInterval: '00:15:00',
          defaultTimedEventDuration: '00:15:00',
          slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
          displayEventTime: false,
          height: 'auto',
          expandRows: false,
          handleWindowResize: true,
          slotLabelDidMount: function(arg) {
            const m = arg.date.getMinutes();
            arg.el.classList.toggle('slot-major-0030', m === 0 || m === 30);
            arg.el.classList.toggle('slot-minor-1545', m === 15 || m === 45);
          },
          viewDidMount: function() { fixTwoEvents() },
          dateClick: function(info) { openApptModal(info.date, info.resource ? info.resource.id : null) },
          eventDidMount: function(info) {
            info.el.setAttribute('title', info.event.title);
            fixTwoEvents();
          },
          eventClassNames: function(arg) {
            const r = arg.event.getResources();
            const cls = (r && r[0]) ? ['sty-' + r[0].id] : [];
            if (arg.event.extendedProps && arg.event.extendedProps.appointment_type === 'blocked') { 
              cls.push('blocked-time');
            }
            return cls;
          },
          eventContent: function(arg) {
            const ep = arg.event.extendedProps || {};
            const svcMap = { 'å‰ªé«®': 'å‰ª', 'å‰ª+æŸ“': 'æŸ“', 'å‰ª+ç‡™': 'ç‡™', 'å‰ª+æŸ“+ç‡™': 'å…¨', 'å‰ª+é ­çš®è­·ç†': 'è­·' };
            const svc = ep.appointment_type === 'blocked' ? 'ğŸš«' : (svcMap[ep.service_id] || 'é ');
            const name = ep.customer_name || '';
            const phone = ep.customer_phone || '';
            const notes = ep.notes || ''; 

            return {
              html: `<div class="fc-event-title evt-line">
                       <span class="evt-svc">${svc}</span>
                       <span>${name}</span>
                       <span class="evt-phone">${phone}</span>
                       ${notes ? `<span class="evt-notes">ğŸ“ ${notes}</span>` : ''}
                     </div>`
            };
          },
          editable: false,
          eventClick: function(info) {
            form.reset();
            const { event } = info;
            const ep = event.extendedProps || {};

            eventIdInput.value = event.id;
            deleteBtn.style.display = 'inline-block';

            const rs = event.getResources();
            document.getElementById('employee_id').value = (rs && rs[0] ? rs[0].id : '');
            document.getElementById('customer_phone').value = ep.customer_phone || '';
            document.getElementById('customer_name').value  = ep.customer_name  || '';
            document.getElementById('service_id').value    = ep.service_id    || '';
            document.getElementById('notes').value         = ep.notes         || '';
            
            const isBlocked = ep.appointment_type === 'blocked';
            document.querySelector(`input[name="appointment_type"][value="${isBlocked ? 'blocked' : 'normal'}"]`).checked = true;
            customerFields.style.display = isBlocked ? 'none' : 'block';
            submitBtn.innerHTML = isBlocked ? 'ğŸš« æ›´æ–°ä¸ç´„æ™‚æ®µ' : 'âœ… æ›´æ–°é ç´„';

            const startDate = event.start;
            const minuteSelect = document.getElementById('minute_select');
            minuteSelect.innerHTML = '';
            const startMinute = startDate.getMinutes();
            for (let m = 0; m < 60; m += 5) {
              const opt = document.createElement('option');
              opt.value = m;
              opt.textContent = String(m).padStart(2, '0');
              if (m === startMinute) opt.selected = true;
              minuteSelect.appendChild(opt);
            }
            updateHiddenStartTime(startDate);
            minuteSelect.onchange = function() { updateHiddenStartTime(startDate) };

            modal.style.display = 'block';
          },
          resources: [
            { id: '1', title: 'åº—é•·' },
            { id: '2', title: 'é›…å©·' },
            { id: '3', title: 'å°ç™½' }
          ],
          events: APPS_SCRIPT_WEB_APP_URL,
          selectable: true,
          select: function(info) { openApptModal(info.start, info.resource ? info.resource.id : null) }
        });

        calendar.render();
        fixTwoEvents();

        // --- å½ˆçª—é—œé–‰é‚è¼¯ ---
        closeButton.onclick = function() { modal.style.display = 'none'; };
        window.onclick = function(e) { if (e.target === modal) modal.style.display = 'none'; };

        // --- åˆªé™¤é ç´„ ---
        deleteBtn.onclick = async function () {
          const eventId = eventIdInput.value.trim();
          if (!eventId || !confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†é ç´„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;

          try {
            const res = await fetch(APPS_SCRIPT_WEB_APP_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
              redirect: 'follow',
              body: JSON.stringify({ action: 'delete', id: eventId })
            });
            const data = await res.json();
            if (!res.ok || data.status !== 'success') {
              throw new Error(data.message || 'åˆªé™¤å¤±æ•—');
            }
          } catch (err) {
            console.error('Delete Error:', err);
            alert('âŒ åˆªé™¤å¤±æ•—ï¼š' + err.message);
          } finally {
            modal.style.display = 'none';
            calendar.refetchEvents();
          }
        };

        // --- è¡¨å–®æäº¤ (æ–°å¢/ç·¨è¼¯) ---
        form.addEventListener('submit', async function (e) {
          e.preventDefault();
          const isEditing = !!eventIdInput.value;
          const fd = new FormData(form);
          const payload = {
            action: isEditing ? 'edit' : 'create',
            id: fd.get('event_id') || undefined,
            employee_id: fd.get('employee_id'),
            start: fd.get('start_time'),
            appointment_type: fd.get('appointment_type'),
            customer_name: fd.get('customer_name') || '',
            customer_phone: (fd.get('customer_phone') || '').replace(/\D/g,''),
            service_id: fd.get('service_id') || '',
            notes: fd.get('notes') || ''
          };

          if (!payload.start || !/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(payload.start)) {
            alert('é–‹å§‹æ™‚é–“éºå¤±æˆ–æ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°é»é¸æ™‚é–“æ ¼å¾Œå†å„²å­˜');
            return;
          }

          if (!payload.employee_id) {
            alert('è«‹é¸æ“‡ä¸€ä½è¨­è¨ˆå¸«');
            return;
          }

          submitBtn.disabled = true;
          try {
            const res = await fetch(APPS_SCRIPT_WEB_APP_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!res.ok || data.status !== 'success') {
              throw new Error(data.message || 'å„²å­˜å¤±æ•—');
            }
          } catch (err) {
            console.error('Submit Error:', err);
            alert('âŒ å„²å­˜å¤±æ•—ï¼š' + err.message);
          } finally {
            submitBtn.disabled = false;
            modal.style.display = 'none';
            calendar.refetchEvents();
          }
        });
      });
})();
    </script>
</body>
</html>

